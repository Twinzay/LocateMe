<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LocateMe — Warehouse Tag & Photo Tracker</title>

  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#050608;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --stroke:rgba(255,255,255,.12);
      --text:#E9EEF5;
      --muted:rgba(233,238,245,.72);

      --gold1:#f6d57a;
      --gold2:#caa24d;
      --gold3:#8b6b23;

      --good:#38d27a;
      --bad:#ff5964;

      --radius:18px;
      --shadow: 0 12px 40px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% -10%, rgba(246,213,122,.22), transparent 55%),
                  radial-gradient(900px 520px at 80% 0%, rgba(202,162,77,.18), transparent 55%),
                  radial-gradient(800px 500px at 50% 110%, rgba(139,107,35,.18), transparent 60%),
                  linear-gradient(180deg, #050608, #07090c 40%, #050608);
      overflow-x:hidden;
    }

    .wrap{max-width:1100px;margin:26px auto;padding:0 16px 48px}
    .topbar{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(246,213,122,.25), rgba(202,162,77,.12));
      border:1px solid rgba(246,213,122,.35);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .logo:before{
      content:"";
      position:absolute;inset:-40%;
      background: linear-gradient(90deg, transparent, rgba(246,213,122,.55), transparent);
      transform:rotate(25deg);
      opacity:.55;
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin:2px 0 0;color:var(--muted);font-size:12px}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--bad)}
    .dot.ok{background:var(--good)}

    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;margin-top:16px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
    }
    .card .hd b{font-size:13px;letter-spacing:.2px}
    .card .bd{padding:14px}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:680px){.row{grid-template-columns:1fr}}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      color: var(--text);
      outline:none;
    }
    textarea{min-height:88px;resize:vertical}

    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      appearance:none;border:0;cursor:pointer;
      padding:11px 14px;border-radius:14px;
      font-weight:650;
      color:#0b0c0f;
      background: linear-gradient(135deg, var(--gold1), var(--gold2));
      box-shadow: 0 10px 26px rgba(202,162,77,.25);
    }
    button.secondary{
      color:var(--text);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
      font-weight:600;
    }
    button.danger{
      color:#fff;
      background: rgba(255,89,100,.18);
      border:1px solid rgba(255,89,100,.35);
      box-shadow:none;
    }
    button:disabled{opacity:.55;cursor:not-allowed}

    .help{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}

    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:700px){.kpis{grid-template-columns:1fr}}
    .kpi{
      padding:12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }
    .kpi .n{font-size:18px;font-weight:800}
    .kpi .t{font-size:12px;color:var(--muted);margin-top:4px}

    .results{display:flex;flex-direction:column;gap:12px}
    .res{
      padding:12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
    }
    .res .top{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap
    }
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      background: rgba(246,213,122,.10);
      border:1px solid rgba(246,213,122,.20);
      color: var(--text);
      font-size:12px;
      font-weight:700;
    }
    .meta{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      font-size:12px;font-weight:800;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
    }
    .badge.in{border-color:rgba(56,210,122,.35);background:rgba(56,210,122,.10)}
    .badge.out{border-color:rgba(255,89,100,.35);background:rgba(255,89,100,.12)}
    .thumbs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .thumb{
      width:120px;height:86px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      position:relative;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .small{font-size:11px;color:var(--muted)}
    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(0,0,0,.26);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size:12px;
      display:none;
    }
    .toast.show{display:block}
    .toast.ok{border-color:rgba(56,210,122,.35);color:#bff1d2}
    .toast.bad{border-color:rgba(255,89,100,.35);color:#ffd0d3}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>LocateMe — Warehouse Tag & Photo Tracker</h1>
          <div class="sub">Save tag → aisle → rail → level with photos. Search any tag to see where it is + what it looks like.</div>
        </div>
      </div>

      <div class="pill" id="connPill">
        <span class="dot" id="connDot"></span>
        <span id="connTxt">Connecting…</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: SAVE / UPDATE -->
      <div class="card">
        <div class="hd">
          <b>Save / Update a Tag</b>
          <span class="small" id="modeTxt">Step 1: Pick aisle → rail → level</span>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Aisle</label>
              <select id="aisleSel"></select>
            </div>
            <div>
              <label>Rail (1–21)</label>
              <select id="railSel"></select>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <label>Level (1–5)</label>
              <select id="levelSel"></select>
            </div>
            <div>
              <label>Tag ID (type or scan)</label>
              <input id="tagInput" placeholder="Example: R-11966.14.23" autocomplete="off" />
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <label>Photo (optional)</label>
              <input id="photoInput" type="file" accept="image/*" />
              <div class="help">Tip: take a clear pic of the barcode label + what the pallet looks like.</div>
            </div>
            <div>
              <label>Notes (optional)</label>
              <textarea id="notesInput" placeholder="Any extra notes…"></textarea>
            </div>
          </div>

          <div class="btnrow">
            <button id="saveBtn">Save (Inbound)</button>
            <button class="secondary" id="outBtn" type="button">Mark Outbound</button>
            <button class="secondary" id="inBtn" type="button">Mark Inbound</button>
            <button class="secondary" id="backBtn" type="button">Back (undo inputs)</button>
            <button class="danger" id="clearBtn" type="button">Clear Form</button>
          </div>

          <div class="toast" id="toast"></div>

          <div class="hr"></div>

          <div class="kpis">
            <div class="kpi">
              <div class="n" id="kpiTotal">—</div>
              <div class="t">Total tags saved</div>
            </div>
            <div class="kpi">
              <div class="n" id="kpiInbound">—</div>
              <div class="t">Inbound</div>
            </div>
            <div class="kpi">
              <div class="n" id="kpiOutbound">—</div>
              <div class="t">Outbound (auto-delete after 5 days via SQL function)</div>
            </div>
          </div>

          <div class="help" style="margin-top:12px">
            <b>Outbound auto-delete:</b> Your SQL function <code>public.purge_outbound_older_than(5)</code> deletes outbound tags older than 5 days.
            Run it from Supabase SQL Editor whenever you want (daily/weekly).
          </div>
        </div>
      </div>

      <!-- RIGHT: SEARCH -->
      <div class="card">
        <div class="hd">
          <b>Search by Tag</b>
          <span class="small">Pulls aisle/rail/level + photos</span>
        </div>
        <div class="bd">
          <label>Tag ID</label>
          <div class="row" style="grid-template-columns:1fr auto;gap:10px">
            <input id="searchInput" placeholder="Type a tag and hit Search…" autocomplete="off" />
            <button id="searchBtn" style="white-space:nowrap">Search</button>
          </div>

          <div class="btnrow" style="margin-top:10px">
            <button class="secondary" id="refreshBtn" type="button">Refresh KPIs</button>
            <button class="secondary" id="recentBtn" type="button">Recent Tags</button>
          </div>

          <div class="hr"></div>
          <div class="results" id="results"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/** =========================================================
 *  CONFIG (YOUR SUPABASE)
 * ========================================================= */
const SB_URL = "https://ojdfaguhteddwaxyobnl.supabase.co";
const SB_ANON = "sb_publishable_S4Z3E2phukZklKtBuRPLjA_RB4Faij2";
const PHOTO_BUCKET = "warehouse-photos";

/** =========================================================
 *  UI helpers
 * ========================================================= */
const $ = (id)=>document.getElementById(id);
const ui = {
  connDot: $("connDot"),
  connTxt: $("connTxt"),
  aisleSel: $("aisleSel"),
  railSel: $("railSel"),
  levelSel: $("levelSel"),
  tagInput: $("tagInput"),
  photoInput: $("photoInput"),
  notesInput: $("notesInput"),
  saveBtn: $("saveBtn"),
  outBtn: $("outBtn"),
  inBtn: $("inBtn"),
  backBtn: $("backBtn"),
  clearBtn: $("clearBtn"),
  toast: $("toast"),
  modeTxt: $("modeTxt"),

  searchInput: $("searchInput"),
  searchBtn: $("searchBtn"),
  refreshBtn: $("refreshBtn"),
  recentBtn: $("recentBtn"),
  results: $("results"),

  kpiTotal: $("kpiTotal"),
  kpiInbound: $("kpiInbound"),
  kpiOutbound: $("kpiOutbound"),
};

function toast(msg, type=""){
  ui.toast.className = "toast show " + (type||"");
  ui.toast.textContent = msg;
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> ui.toast.className = "toast", 4500);
}

function setConn(ok, msg){
  ui.connDot.classList.toggle("ok", !!ok);
  ui.connTxt.textContent = msg;
}

function normTag(s){
  return (s||"").trim();
}
function safePathPart(s){
  return (s||"").trim()
    .replace(/[^\w.\-]+/g, "_")
    .replace(/_+/g, "_")
    .slice(0, 80) || "TAG";
}

function pad2(n){ return String(n).padStart(2,"0"); }

/** =========================================================
 *  Supabase
 * ========================================================= */
let sb = null;

/** =========================================================
 *  Dropdowns + Back button state
 * ========================================================= */
let historyStack = []; // store snapshots for Back button

function snapshotState(){
  return {
    aisle: ui.aisleSel.value,
    rail: ui.railSel.value,
    level: ui.levelSel.value,
    tag: ui.tagInput.value,
    notes: ui.notesInput.value,
  };
}
function pushHistory(){
  historyStack.push(snapshotState());
  if(historyStack.length > 25) historyStack.shift();
}
function restoreState(s){
  if(!s) return;
  ui.aisleSel.value = s.aisle || ui.aisleSel.value;
  ui.railSel.value = s.rail || ui.railSel.value;
  ui.levelSel.value = s.level || ui.levelSel.value;
  ui.tagInput.value = s.tag || "";
  ui.notesInput.value = s.notes || "";
}
function back(){
  const prev = historyStack.pop();
  if(!prev){ toast("Nothing to go back to.", "bad"); return; }
  restoreState(prev);
  toast("Reverted to previous inputs.", "ok");
}

/** =========================================================
 *  Load aisles / build rails/levels
 * ========================================================= */
async function loadAisles(){
  // Build rails + levels generically
  ui.railSel.innerHTML = "";
  for(let i=1;i<=21;i++){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `Rail ${i}`;
    ui.railSel.appendChild(opt);
  }

  ui.levelSel.innerHTML = "";
  for(let i=1;i<=5;i++){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `Level ${i}`;
    ui.levelSel.appendChild(opt);
  }

  // Pull aisles from DB (falls back to AISLE-01..10 if empty)
  const { data, error } = await sb
    .from("aisles")
    .select("name")
    .order("name", { ascending: true });

  ui.aisleSel.innerHTML = "";
  if(error){
    // fallback
    for(let i=1;i<=10;i++){
      const name = `AISLE-${pad2(i)}`;
      const opt = document.createElement("option");
      opt.value = name; opt.textContent = name;
      ui.aisleSel.appendChild(opt);
    }
    toast("Could not load aisles table (using default AISLE-01..10).", "bad");
    return;
  }

  const list = (data||[]).map(x=>x.name).filter(Boolean);
  if(!list.length){
    for(let i=1;i<=10;i++){
      const name = `AISLE-${pad2(i)}`;
      const opt = document.createElement("option");
      opt.value = name; opt.textContent = name;
      ui.aisleSel.appendChild(opt);
    }
  } else {
    for(const name of list){
      const opt = document.createElement("option");
      opt.value = name; opt.textContent = name;
      ui.aisleSel.appendChild(opt);
    }
  }

  // defaults
  ui.railSel.value = "1";
  ui.levelSel.value = "1";
}

/** =========================================================
 *  DB ops
 * ========================================================= */
async function upsertPalletTag({tag_id, aisle_name, rail, level, status, notes}){
  // Uses your unique index: (aisle_name, rail, level, tag_id)
  const payload = { tag_id, aisle_name, rail, level, status, notes };

  const { data, error } = await sb
    .from("pallet_tags")
    .upsert(payload, { onConflict: "aisle_name,rail,level,tag_id" })
    .select("*")
    .limit(1)
    .single();

  if(error) throw error;
  return data;
}

async function uploadPhotoAndLink(palletTagRow, file){
  if(!file) return null;

  const tag = safePathPart(palletTagRow.tag_id);
  const aisle = safePathPart(palletTagRow.aisle_name);
  const rail = `R${pad2(palletTagRow.rail)}`;
  const level = `L${palletTagRow.level}`;
  const ts = Date.now();

  const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
  const cleanName = safePathPart(file.name.replace(/\.[^/.]+$/, ""));
  const object_path = `${aisle}/${rail}/${level}/${tag}/${ts}_${cleanName}.${ext}`;

  // upload
  const { error: upErr } = await sb.storage
    .from(PHOTO_BUCKET)
    .upload(object_path, file, { upsert: false, contentType: file.type || "image/jpeg" });

  if(upErr) throw upErr;

  // insert metadata
  const { data, error } = await sb
    .from("tag_photos")
    .insert({
      pallet_tag_id: palletTagRow.id,
      bucket: PHOTO_BUCKET,
      object_path,
      file_name: file.name,
      content_type: file.type || null
    })
    .select("*")
    .limit(1)
    .single();

  if(error) throw error;
  return data;
}

function publicUrl(path){
  const { data } = sb.storage.from(PHOTO_BUCKET).getPublicUrl(path);
  return data?.publicUrl || "";
}

/** =========================================================
 *  Save / status buttons
 * ========================================================= */
async function saveWithStatus(status){
  const tag_id = normTag(ui.tagInput.value);
  if(!tag_id){
    toast("Enter a Tag ID first.", "bad");
    ui.tagInput.focus();
    return;
  }

  pushHistory();
  ui.saveBtn.disabled = true;
  ui.outBtn.disabled = true;
  ui.inBtn.disabled = true;

  try{
    const aisle_name = ui.aisleSel.value;
    const rail = parseInt(ui.railSel.value, 10);
    const level = parseInt(ui.levelSel.value, 10);
    const notes = (ui.notesInput.value || "").trim() || null;

    // 1) upsert location/status
    const row = await upsertPalletTag({ tag_id, aisle_name, rail, level, status, notes });

    // 2) optional photo upload
    const file = ui.photoInput.files?.[0] || null;
    if(file){
      await uploadPhotoAndLink(row, file);
      ui.photoInput.value = "";
    }

    toast(`Saved ${tag_id} → ${aisle_name} / Rail ${rail} / Level ${level} (${status}).`, "ok");
    await refreshKPIs();
  }catch(err){
    console.error(err);
    toast(`Save failed: ${err.message || err}`, "bad");
  }finally{
    ui.saveBtn.disabled = false;
    ui.outBtn.disabled = false;
    ui.inBtn.disabled = false;
  }
}

async function markOutbound(){
  await saveWithStatus("OUTBOUND");
}
async function markInbound(){
  await saveWithStatus("INBOUND");
}

/** =========================================================
 *  Search
 * ========================================================= */
async function fetchPhotosForTagIds(palletTagIds){
  if(!palletTagIds.length) return new Map();
  const { data, error } = await sb
    .from("tag_photos")
    .select("pallet_tag_id, object_path, created_at")
    .in("pallet_tag_id", palletTagIds)
    .order("created_at", { ascending:false });

  if(error) throw error;

  // map: tagId -> [paths...]
  const map = new Map();
  for(const row of (data||[])){
    if(!map.has(row.pallet_tag_id)) map.set(row.pallet_tag_id, []);
    map.get(row.pallet_tag_id).push(row.object_path);
  }
  return map;
}

function renderResults(rows, photoMap){
  ui.results.innerHTML = "";
  if(!rows.length){
    ui.results.innerHTML = `<div class="small">No matches found.</div>`;
    return;
  }

  for(const r of rows){
    const photos = photoMap.get(r.id) || [];
    const badgeClass = r.status === "OUTBOUND" ? "out" : "in";
    const badgeTxt = r.status === "OUTBOUND" ? "OUTBOUND" : "INBOUND";

    const div = document.createElement("div");
    div.className = "res";

    div.innerHTML = `
      <div class="top">
        <div>
          <div class="tag">${escapeHtml(r.tag_id)}</div>
          <div class="meta">
            <b>Location:</b> ${escapeHtml(r.aisle_name)} • Rail ${r.rail} • Level ${r.level}<br>
            <b>Updated:</b> ${new Date(r.updated_at || r.created_at).toLocaleString()}
            ${r.outbound_at ? `<br><b>Outbound at:</b> ${new Date(r.outbound_at).toLocaleString()}` : ``}
            ${r.notes ? `<br><b>Notes:</b> ${escapeHtml(r.notes)}` : ``}
          </div>
        </div>
        <div class="badge ${badgeClass}">${badgeTxt}</div>
      </div>
      <div class="thumbs" id="thumbs_${r.id}"></div>
      <div class="btnrow" style="margin-top:10px">
        <button class="secondary" data-act="fill" data-id="${r.id}">Load into form</button>
        <button class="secondary" data-act="in" data-id="${r.id}">Mark Inbound</button>
        <button class="secondary" data-act="out" data-id="${r.id}">Mark Outbound</button>
      </div>
    `;

    // thumbnails
    const thumbs = div.querySelector(`#thumbs_${CSS.escape(r.id)}`);
    if(photos.length){
      for(const p of photos.slice(0,6)){
        const t = document.createElement("div");
        t.className = "thumb";
        const url = publicUrl(p);
        t.innerHTML = `<img src="${url}" alt="photo" loading="lazy" />`;
        thumbs.appendChild(t);
      }
    } else {
      thumbs.innerHTML = `<div class="small">No photos saved for this tag.</div>`;
    }

    // actions
    div.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const act = btn.getAttribute("data-act");
      if(!act) return;

      if(act === "fill"){
        pushHistory();
        ui.tagInput.value = r.tag_id;
        ui.aisleSel.value = r.aisle_name;
        ui.railSel.value = String(r.rail);
        ui.levelSel.value = String(r.level);
        ui.notesInput.value = r.notes || "";
        toast("Loaded into form. You can update and resave.", "ok");
      }

      if(act === "in"){
        pushHistory();
        ui.tagInput.value = r.tag_id;
        ui.aisleSel.value = r.aisle_name;
        ui.railSel.value = String(r.rail);
        ui.levelSel.value = String(r.level);
        ui.notesInput.value = r.notes || "";
        await saveWithStatus("INBOUND");
        await doSearch(r.tag_id);
      }

      if(act === "out"){
        pushHistory();
        ui.tagInput.value = r.tag_id;
        ui.aisleSel.value = r.aisle_name;
        ui.railSel.value = String(r.rail);
        ui.levelSel.value = String(r.level);
        ui.notesInput.value = r.notes || "";
        await saveWithStatus("OUTBOUND");
        await doSearch(r.tag_id);
      }
    });

    ui.results.appendChild(div);
  }
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function doSearch(tag){
  const q = normTag(tag);
  if(!q){
    toast("Type a tag to search.", "bad");
    return;
  }
  ui.searchBtn.disabled = true;
  ui.results.innerHTML = `<div class="small">Searching…</div>`;
  try{
    const { data, error } = await sb
      .from("pallet_tags")
      .select("*")
      .eq("tag_id", q)
      .order("updated_at", { ascending:false });

    if(error) throw error;

    const rows = data || [];
    const ids = rows.map(r=>r.id);
    const photoMap = await fetchPhotosForTagIds(ids);
    renderResults(rows, photoMap);
  }catch(err){
    console.error(err);
    ui.results.innerHTML = `<div class="small">Search failed.</div>`;
    toast(`Search failed: ${err.message || err}`, "bad");
  }finally{
    ui.searchBtn.disabled = false;
  }
}

async function recentTags(){
  ui.results.innerHTML = `<div class="small">Loading recent…</div>`;
  try{
    const { data, error } = await sb
      .from("pallet_tags")
      .select("*")
      .order("updated_at", { ascending:false })
      .limit(10);

    if(error) throw error;
    const rows = data || [];
    const ids = rows.map(r=>r.id);
    const photoMap = await fetchPhotosForTagIds(ids);
    renderResults(rows, photoMap);
  }catch(err){
    console.error(err);
    toast(`Recent failed: ${err.message || err}`, "bad");
    ui.results.innerHTML = `<div class="small">Could not load recent.</div>`;
  }
}

/** =========================================================
 *  KPIs
 * ========================================================= */
async function refreshKPIs(){
  try{
    // total
    const total = await sb.from("pallet_tags").select("id", { count:"exact", head:true });
    const inbound = await sb.from("pallet_tags").select("id", { count:"exact", head:true }).eq("status","INBOUND");
    const outbound = await sb.from("pallet_tags").select("id", { count:"exact", head:true }).eq("status","OUTBOUND");

    ui.kpiTotal.textContent = (total.count ?? "—");
    ui.kpiInbound.textContent = (inbound.count ?? "—");
    ui.kpiOutbound.textContent = (outbound.count ?? "—");
  }catch(err){
    console.error(err);
  }
}

/** =========================================================
 *  Init
 * ========================================================= */
async function init(){
  try{
    sb = supabase.createClient(SB_URL, SB_ANON);
    setConn(true, "Connected");
    await loadAisles();
    await refreshKPIs();
    await recentTags();
  }catch(err){
    console.error(err);
    setConn(false, "Not connected");
    toast(`Init failed: ${err.message || err}`, "bad");
  }
}

ui.saveBtn.addEventListener("click", ()=>saveWithStatus("INBOUND"));
ui.outBtn.addEventListener("click", markOutbound);
ui.inBtn.addEventListener("click", markInbound);
ui.backBtn.addEventListener("click", back);
ui.clearBtn.addEventListener("click", ()=>{
  pushHistory();
  ui.tagInput.value = "";
  ui.notesInput.value = "";
  ui.photoInput.value = "";
  ui.railSel.value = "1";
  ui.levelSel.value = "1";
  toast("Cleared form.", "ok");
});

ui.searchBtn.addEventListener("click", ()=>doSearch(ui.searchInput.value));
ui.searchInput.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){ e.preventDefault(); doSearch(ui.searchInput.value); }
});
ui.refreshBtn.addEventListener("click", refreshKPIs);
ui.recentBtn.addEventListener("click", recentTags);

// push history when user changes dropdowns (so Back is useful)
["change","input"].forEach(evt=>{
  ui.aisleSel.addEventListener(evt, pushHistory);
  ui.railSel.addEventListener(evt, pushHistory);
  ui.levelSel.addEventListener(evt, pushHistory);
});

init();
</script>
</body>
</html>
