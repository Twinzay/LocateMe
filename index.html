<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LocateMe — Warehouse Tag & Photo Tracker</title>

  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#050608;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --stroke:rgba(255,255,255,.12);
      --text:#E9EEF5;
      --muted:rgba(233,238,245,.72);

      --gold1:#f6d57a;
      --gold2:#caa24d;
      --gold3:#8b6b23;

      --good:#38d27a;
      --bad:#ff5964;
      --warn:#ffcc66;

      --radius:18px;
      --shadow: 0 12px 40px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% -10%, rgba(246,213,122,.22), transparent 55%),
                  radial-gradient(900px 520px at 80% 0%, rgba(202,162,77,.18), transparent 55%),
                  radial-gradient(800px 500px at 50% 110%, rgba(139,107,35,.18), transparent 60%),
                  linear-gradient(180deg, #050608, #07090c 40%, #050608);
      overflow-x:hidden;
    }

    .wrap{max-width:1200px;margin:26px auto;padding:0 16px 48px}
    .topbar{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(246,213,122,.25), rgba(202,162,77,.12));
      border:1px solid rgba(246,213,122,.35);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .logo:before{
      content:"";
      position:absolute;inset:-40%;
      background: linear-gradient(90deg, transparent, rgba(246,213,122,.55), transparent);
      transform:rotate(25deg);
      opacity:.55;
    }
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin:2px 0 0;color:var(--muted);font-size:12px}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--bad)}
    .dot.ok{background:var(--good)}

    .tabs{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap}
    .tabbtn{
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      cursor:pointer;
      font-weight:750;
      font-size:12px;
    }
    .tabbtn.active{border-color: rgba(246,213,122,.35);background: rgba(246,213,122,.12)}

    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px;margin-top:16px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .gridOne{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      flex-wrap:wrap;
    }
    .card .hd b{font-size:13px;letter-spacing:.2px}
    .card .bd{padding:14px}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:680px){.row{grid-template-columns:1fr}}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.30);
      color: var(--text);
      outline:none;
    }
    textarea{min-height:88px;resize:vertical}

    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      appearance:none;border:0;cursor:pointer;
      padding:11px 14px;border-radius:14px;
      font-weight:650;
      color:#0b0c0f;
      background: linear-gradient(135deg, var(--gold1), var(--gold2));
      box-shadow: 0 10px 26px rgba(202,162,77,.25);
    }
    button.secondary{
      color:var(--text);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
      font-weight:600;
    }
    button.danger{
      color:#fff;
      background: rgba(255,89,100,.18);
      border:1px solid rgba(255,89,100,.35);
      box-shadow:none;
    }
    button:disabled{opacity:.55;cursor:not-allowed}

    .help{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}

    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:700px){.kpis{grid-template-columns:1fr}}
    .kpi{
      padding:12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }
    .kpi .n{font-size:18px;font-weight:800}
    .kpi .t{font-size:12px;color:var(--muted);margin-top:4px}

    .results{display:flex;flex-direction:column;gap:12px}
    .res{
      padding:12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
    }
    .res .top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      background: rgba(246,213,122,.10);
      border:1px solid rgba(246,213,122,.20);
      color: var(--text);
      font-size:12px;
      font-weight:700;
    }
    .meta{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      font-size:12px;font-weight:800;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
    }
    .badge.in{border-color:rgba(56,210,122,.35);background:rgba(56,210,122,.10)}
    .badge.out{border-color:rgba(255,89,100,.35);background:rgba(255,89,100,.12)}

    .thumbs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .thumb{
      width:120px;height:86px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      position:relative;
      cursor: zoom-in;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .small{font-size:11px;color:var(--muted)}
    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(0,0,0,.26);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size:12px;
      display:none;
    }
    .toast.show{display:block}
    .toast.ok{border-color:rgba(56,210,122,.35);color:#bff1d2}
    .toast.bad{border-color:rgba(255,89,100,.35);color:#ffd0d3}

    /* Aisle Map */
    .mapTop{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      align-items:end;
    }
    @media(max-width:980px){.mapTop{grid-template-columns:1fr}}
    .seg{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      font-weight:750;font-size:12px;
      cursor:pointer;user-select:none;
    }
    .chip.on{border-color: rgba(246,213,122,.35);background: rgba(246,213,122,.12)}

    .mapGridWrap{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      overflow:auto;
    }
    .mapGrid{
      min-width: 980px;
      display:grid;
      grid-template-columns: 80px repeat(21, minmax(44px, 1fr));
      gap:8px;
      padding:12px;
    }
    .mapHdr{
      font-size:11px;color: rgba(233,238,245,.75);
      text-align:center;
      padding:8px 6px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background: rgba(255,255,255,.04);
      position:sticky;top:0;
      backdrop-filter: blur(6px);
      z-index:1;
    }
    .mapRowLbl{
      font-size:12px;font-weight:800;color: rgba(233,238,245,.90);
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background: rgba(255,255,255,.04);
      padding:8px;
      position:sticky;left:0;
      z-index:1;
      backdrop-filter: blur(6px);
    }
    .cell{
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      background: rgba(255,255,255,.03);
      padding:8px 8px 7px;
      cursor:pointer;
      transition: transform .08s ease, border-color .08s ease, background .08s ease;
      min-height:46px;
      display:flex;flex-direction:column;justify-content:center;align-items:center;
      gap:4px;text-align:center;
    }
    .cell:hover{
      transform: translateY(-1px);
      border-color: rgba(246,213,122,.22);
      background: rgba(246,213,122,.06);
    }
    .cell .c1{font-size:12px;font-weight:900}
    .cell .c2{font-size:10px;color:rgba(233,238,245,.68)}
    .cell.empty .c1{color:rgba(233,238,245,.55);font-weight:800}
    .cell.inOnly{border-color: rgba(56,210,122,.25); background: rgba(56,210,122,.05)}
    .cell.outOnly{border-color: rgba(255,89,100,.25); background: rgba(255,89,100,.06)}
    .cell.mixed{border-color: rgba(255,204,102,.30); background: rgba(255,204,102,.06)}

    .drawer{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      padding:12px;
    }
    .drawerTop{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .drawerTitle{font-weight:900;letter-spacing:.2px}
    .drawerSub{color:var(--muted);font-size:12px;margin-top:4px}
    .drawerList{margin-top:10px;display:flex;flex-direction:column;gap:10px}
    .miniRow{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .miniLeft .t{font-weight:900;font-size:12px}
    .miniLeft .s{font-size:11px;color:var(--muted);margin-top:4px}

    /* Modal */
    .modal{
      position:fixed;inset:0;
      background: rgba(0,0,0,.78);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal.show{display:flex}
    .modalInner{
      max-width:1100px;
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,10,12,.9);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalTop{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalTop b{font-size:13px}
    .modalBody{padding:12px}
    .modalBody img{
      width:100%;
      height:auto;
      display:block;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
    }
    .xBtn{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>LocateMe — Warehouse Tag & Photo Tracker</h1>
          <div class="sub">Save tag → aisle → rail → level with photos. Search any tag to see where it is + what it looks like.</div>
        </div>
      </div>

      <div class="pill">
        <span class="dot" id="connDot"></span>
        <span id="connTxt">Connecting…</span>
      </div>
    </div>

    <div class="tabs">
      <button class="tabbtn active" id="tabSave">Save / Update</button>
      <button class="tabbtn" id="tabSearch">Search</button>
      <button class="tabbtn" id="tabMap">Aisle View</button>
    </div>

    <div class="grid" id="viewSaveSearch">
      <!-- SAVE -->
      <div class="card">
        <div class="hd">
          <b>Save / Update a Tag</b>
          <span class="small">Pick aisle → rail → level</span>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Aisle</label>
              <select id="aisleSel"></select>
            </div>
            <div>
              <label>Rail (1–21)</label>
              <select id="railSel"></select>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <label>Level (1–5)</label>
              <select id="levelSel"></select>
            </div>
            <div>
              <label>Tag ID (type or scan)</label>
              <input id="tagInput" placeholder="Example: R-11966.14.23" autocomplete="off" />
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <label>Photo (optional)</label>
              <input id="photoInput" type="file" accept="image/*" />
              <div class="help">Tip: take a clear pic of the barcode label + what the pallet looks like.</div>
            </div>
            <div>
              <label>Notes (optional)</label>
              <textarea id="notesInput" placeholder="Any extra notes…"></textarea>
            </div>
          </div>

          <div class="btnrow">
            <button id="saveBtn">Save (Inbound)</button>
            <button class="secondary" id="outBtn" type="button">Mark Outbound</button>
            <button class="secondary" id="inBtn" type="button">Mark Inbound</button>
            <button class="secondary" id="moveBtn" type="button">Move Tag (no photo)</button>
            <button class="secondary" id="clearBtn" type="button">Clear</button>
          </div>

          <div class="toast" id="toast"></div>

          <div class="hr"></div>

          <div class="kpis">
            <div class="kpi">
              <div class="n" id="kpiTotal">—</div>
              <div class="t">Total tags saved</div>
            </div>
            <div class="kpi">
              <div class="n" id="kpiInbound">—</div>
              <div class="t">Inbound</div>
            </div>
            <div class="kpi">
              <div class="n" id="kpiOutbound">—</div>
              <div class="t">Outbound (auto-delete with SQL purge)</div>
            </div>
          </div>

          <div class="help" style="margin-top:12px">
            Cleanup (run anytime in Supabase SQL Editor):
            <code>select public.purge_outbound_older_than(5);</code>
          </div>
        </div>
      </div>

      <!-- SEARCH -->
      <div class="card">
        <div class="hd">
          <b>Search</b>
          <span class="small">Exact / starts with / contains</span>
        </div>
        <div class="bd">
          <label>Tag search</label>
          <div class="row" style="grid-template-columns:1fr 160px;gap:10px">
            <input id="searchInput" placeholder="Type tag (example: R-11966)" autocomplete="off" />
            <select id="searchMode">
              <option value="contains">Contains</option>
              <option value="starts">Starts with</option>
              <option value="exact">Exact</option>
            </select>
          </div>

          <div class="btnrow" style="margin-top:10px">
            <button id="searchBtn">Search</button>
            <button class="secondary" id="recentBtn" type="button">Recent (25)</button>
            <button class="secondary" id="refreshBtn" type="button">Refresh KPIs</button>
          </div>

          <div class="hr"></div>
          <div class="results" id="results"></div>
        </div>
      </div>
    </div>

    <!-- AISLE VIEW -->
    <div class="gridOne" id="viewMap" style="display:none">
      <div class="card">
        <div class="hd">
          <b>Aisle View</b>
          <span class="small">Click a cell to see tags + photos</span>
        </div>
        <div class="bd">
          <div class="mapTop">
            <div>
              <label>Aisle</label>
              <select id="mapAisleSel"></select>
            </div>

            <div>
              <label>Filter</label>
              <div class="seg">
                <div class="chip on" id="fAll">All</div>
                <div class="chip" id="fIn">Inbound</div>
                <div class="chip" id="fOut">Outbound</div>
              </div>
            </div>

            <div class="btnrow" style="margin-top:0">
              <button class="secondary" id="mapRefreshBtn" type="button">Refresh aisle</button>
              <button class="secondary" id="mapRecentBtn" type="button">Jump to latest tag</button>
            </div>
          </div>

          <div class="mapGridWrap">
            <div class="mapGrid" id="mapGrid"></div>
          </div>

          <div class="drawer" id="cellDrawer" style="display:none">
            <div class="drawerTop">
              <div>
                <div class="drawerTitle" id="drawerTitle">—</div>
                <div class="drawerSub" id="drawerSub">—</div>
              </div>
              <div class="btnrow" style="margin-top:0">
                <button class="secondary" id="drawerAddBtn" type="button">Add tag here</button>
                <button class="secondary" id="drawerCloseBtn" type="button">Close</button>
              </div>
            </div>
            <div class="drawerList" id="drawerList"></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- PHOTO MODAL -->
  <div class="modal" id="modal">
    <div class="modalInner">
      <div class="modalTop">
        <b id="modalTitle">Photo</b>
        <button class="xBtn" id="modalClose">Close</button>
      </div>
      <div class="modalBody">
        <img id="modalImg" alt="photo"/>
      </div>
    </div>
  </div>

<script>
/** =========================================================
 *  CONFIG (YOUR SUPABASE)
 * ========================================================= */
const SB_URL = "https://ojdfaguhteddwaxyobnl.supabase.co";
const SB_ANON = "sb_publishable_S4Z3E2phukZklKtBuRPLjA_RB4Faij2";
const PHOTO_BUCKET = "warehouse-photos";

/** =========================================================
 *  UI helpers
 * ========================================================= */
const $ = (id)=>document.getElementById(id);
const ui = {
  // tabs
  tabSave: $("tabSave"),
  tabSearch: $("tabSearch"),
  tabMap: $("tabMap"),
  viewSaveSearch: $("viewSaveSearch"),
  viewMap: $("viewMap"),

  // conn
  connDot: $("connDot"),
  connTxt: $("connTxt"),

  // save
  aisleSel: $("aisleSel"),
  railSel: $("railSel"),
  levelSel: $("levelSel"),
  tagInput: $("tagInput"),
  photoInput: $("photoInput"),
  notesInput: $("notesInput"),
  saveBtn: $("saveBtn"),
  outBtn: $("outBtn"),
  inBtn: $("inBtn"),
  moveBtn: $("moveBtn"),
  clearBtn: $("clearBtn"),
  toast: $("toast"),

  // search
  searchInput: $("searchInput"),
  searchMode: $("searchMode"),
  searchBtn: $("searchBtn"),
  recentBtn: $("recentBtn"),
  refreshBtn: $("refreshBtn"),
  results: $("results"),

  // KPIs
  kpiTotal: $("kpiTotal"),
  kpiInbound: $("kpiInbound"),
  kpiOutbound: $("kpiOutbound"),

  // map
  mapAisleSel: $("mapAisleSel"),
  mapGrid: $("mapGrid"),
  mapRefreshBtn: $("mapRefreshBtn"),
  mapRecentBtn: $("mapRecentBtn"),
  fAll: $("fAll"),
  fIn: $("fIn"),
  fOut: $("fOut"),

  // drawer
  cellDrawer: $("cellDrawer"),
  drawerTitle: $("drawerTitle"),
  drawerSub: $("drawerSub"),
  drawerList: $("drawerList"),
  drawerAddBtn: $("drawerAddBtn"),
  drawerCloseBtn: $("drawerCloseBtn"),

  // modal
  modal: $("modal"),
  modalImg: $("modalImg"),
  modalTitle: $("modalTitle"),
  modalClose: $("modalClose"),
};

function toast(msg, type=""){
  ui.toast.className = "toast show " + (type||"");
  ui.toast.textContent = msg;
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> ui.toast.className = "toast", 4500);
}
function setConn(ok, msg){
  ui.connDot.classList.toggle("ok", !!ok);
  ui.connTxt.textContent = msg;
}
function normTag(s){ return (s||"").trim(); }
function safePathPart(s){
  return (s||"").trim().replace(/[^\w.\-]+/g, "_").replace(/_+/g, "_").slice(0, 80) || "TAG";
}
function pad2(n){ return String(n).padStart(2,"0"); }
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); toast("Copied.", "ok"); }
  catch{ toast("Copy failed (browser blocked).", "bad"); }
}

function showModal(title, imgUrl){
  ui.modalTitle.textContent = title || "Photo";
  ui.modalImg.src = imgUrl;
  ui.modal.classList.add("show");
}
function hideModal(){
  ui.modal.classList.remove("show");
  ui.modalImg.src = "";
}
ui.modalClose.addEventListener("click", hideModal);
ui.modal.addEventListener("click", (e)=>{ if(e.target === ui.modal) hideModal(); });

/** =========================================================
 *  Supabase
 * ========================================================= */
let sb = null;

/** =========================================================
 *  Tabs
 * ========================================================= */
function setTab(which){
  ui.tabSave.classList.toggle("active", which==="save");
  ui.tabSearch.classList.toggle("active", which==="search");
  ui.tabMap.classList.toggle("active", which==="map");

  ui.viewSaveSearch.style.display = (which==="map") ? "none" : "";
  ui.viewMap.style.display = (which==="map") ? "" : "none";
  if(which==="search") setTimeout(()=>ui.searchInput.focus(), 50);
  if(which==="map") setTimeout(()=>refreshMap(), 50);
}

/** =========================================================
 *  Load aisles / rails / levels
 * ========================================================= */
async function loadAisles(){
  ui.railSel.innerHTML = "";
  for(let i=1;i<=21;i++){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `Rail ${i}`;
    ui.railSel.appendChild(opt);
  }

  ui.levelSel.innerHTML = "";
  for(let i=1;i<=5;i++){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `Level ${i}`;
    ui.levelSel.appendChild(opt);
  }

  const { data, error } = await sb.from("aisles").select("name").order("name", { ascending:true });

  const fallback = ()=>{
    const names=[];
    for(let i=1;i<=10;i++) names.push(`AISLE-${pad2(i)}`);
    return names;
  };

  const aisles = (!error && (data||[]).length) ? (data||[]).map(x=>x.name).filter(Boolean) : fallback();

  ui.aisleSel.innerHTML = "";
  ui.mapAisleSel.innerHTML = "";
  for(const name of aisles){
    const a1 = document.createElement("option"); a1.value = name; a1.textContent = name;
    const a2 = document.createElement("option"); a2.value = name; a2.textContent = name;
    ui.aisleSel.appendChild(a1);
    ui.mapAisleSel.appendChild(a2);
  }

  ui.railSel.value = "1";
  ui.levelSel.value = "1";
}

/** =========================================================
 *  Storage helpers
 * ========================================================= */
function publicUrl(path){
  const { data } = sb.storage.from(PHOTO_BUCKET).getPublicUrl(path);
  return data?.publicUrl || "";
}

/** =========================================================
 *  DB ops
 * ========================================================= */
function validateFormBasics(){
  const tag_id = normTag(ui.tagInput.value);
  if(!tag_id) return { ok:false, msg:"Enter a Tag ID first." };
  if(!ui.aisleSel.value) return { ok:false, msg:"Select an aisle." };
  const rail = parseInt(ui.railSel.value, 10);
  const level = parseInt(ui.levelSel.value, 10);
  if(!Number.isFinite(rail) || rail < 1 || rail > 21) return { ok:false, msg:"Rail must be 1–21." };
  if(!Number.isFinite(level) || level < 1 || level > 5) return { ok:false, msg:"Level must be 1–5." };
  return { ok:true, tag_id, rail, level, aisle_name: ui.aisleSel.value };
}

async function upsertPalletTag({tag_id, aisle_name, rail, level, status, notes}){
  const payload = { tag_id, aisle_name, rail, level, status, notes };
  const { data, error } = await sb
    .from("pallet_tags")
    .upsert(payload, { onConflict: "aisle_name,rail,level,tag_id" })
    .select("*")
    .limit(1)
    .single();
  if(error) throw error;
  return data;
}

async function updateMoveTag({tag_id, aisle_name, rail, level}){
  const { data, error } = await sb
    .from("pallet_tags")
    .update({ aisle_name, rail, level, updated_at: new Date().toISOString() })
    .eq("tag_id", tag_id)
    .select("*")
    .limit(1)
    .single();
  if(error) throw error;
  return data;
}

async function uploadPhotoAndLink(palletTagRow, file){
  if(!file) return null;

  const tag = safePathPart(palletTagRow.tag_id);
  const aisle = safePathPart(palletTagRow.aisle_name);
  const rail = `R${pad2(palletTagRow.rail)}`;
  const level = `L${palletTagRow.level}`;
  const ts = Date.now();

  const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
  const cleanName = safePathPart(file.name.replace(/\.[^/.]+$/, ""));
  const object_path = `${aisle}/${rail}/${level}/${tag}/${ts}_${cleanName}.${ext}`;

  const { error: upErr } = await sb.storage
    .from(PHOTO_BUCKET)
    .upload(object_path, file, { upsert:false, contentType: file.type || "image/jpeg" });
  if(upErr) throw upErr;

  const { data, error } = await sb
    .from("tag_photos")
    .insert({
      pallet_tag_id: palletTagRow.id,
      bucket: PHOTO_BUCKET,
      object_path,
      file_name: file.name,
      content_type: file.type || null
    })
    .select("*")
    .limit(1)
    .single();
  if(error) throw error;
  return data;
}

async function saveWithStatus(status){
  const v = validateFormBasics();
  if(!v.ok){ toast(v.msg, "bad"); ui.tagInput.focus(); return; }

  ui.saveBtn.disabled = ui.outBtn.disabled = ui.inBtn.disabled = ui.moveBtn.disabled = true;
  try{
    const notes = (ui.notesInput.value || "").trim() || null;
    const row = await upsertPalletTag({ tag_id:v.tag_id, aisle_name:v.aisle_name, rail:v.rail, level:v.level, status, notes });

    const file = ui.photoInput.files?.[0] || null;
    if(file){
      await uploadPhotoAndLink(row, file);
      ui.photoInput.value = "";
    }

    toast(`Saved ${v.tag_id} → ${v.aisle_name} / Rail ${v.rail} / Level ${v.level} (${status}).`, "ok");
    await refreshKPIs();
  }catch(err){
    console.error(err);
    toast(`Save failed: ${err.message || err}`, "bad");
  }finally{
    ui.saveBtn.disabled = ui.outBtn.disabled = ui.inBtn.disabled = ui.moveBtn.disabled = false;
  }
}

async function moveTagNoPhoto(){
  const v = validateFormBasics();
  if(!v.ok){ toast(v.msg, "bad"); ui.tagInput.focus(); return; }

  ui.moveBtn.disabled = true;
  try{
    // Make sure tag exists first
    const { data: existing, error: exErr } = await sb
      .from("pallet_tags")
      .select("*")
      .eq("tag_id", v.tag_id)
      .limit(1)
      .maybeSingle();
    if(exErr) throw exErr;
    if(!existing){
      toast("That tag isn’t saved yet. Use Save first.", "bad");
      return;
    }

    const moved = await updateMoveTag({ tag_id:v.tag_id, aisle_name:v.aisle_name, rail:v.rail, level:v.level });
    toast(`Moved ${moved.tag_id} → ${moved.aisle_name} / Rail ${moved.rail} / Level ${moved.level} (photos kept).`, "ok");
    await refreshKPIs();
    await doSearch(v.tag_id);
  }catch(err){
    console.error(err);
    toast(`Move failed: ${err.message || err}`, "bad");
  }finally{
    ui.moveBtn.disabled = false;
  }
}

/** =========================================================
 *  Photos query + rendering
 * ========================================================= */
async function fetchPhotosForTagIds(palletTagIds){
  if(!palletTagIds.length) return new Map();
  const { data, error } = await sb
    .from("tag_photos")
    .select("pallet_tag_id, object_path, created_at")
    .in("pallet_tag_id", palletTagIds)
    .order("created_at", { ascending:false });

  if(error) throw error;

  const map = new Map();
  for(const row of (data||[])){
    if(!map.has(row.pallet_tag_id)) map.set(row.pallet_tag_id, []);
    map.get(row.pallet_tag_id).push(row.object_path);
  }
  return map;
}

function renderResults(rows, photoMap){
  ui.results.innerHTML = "";
  if(!rows.length){
    ui.results.innerHTML = `<div class="small">No matches found.</div>`;
    return;
  }

  for(const r of rows){
    const photos = photoMap.get(r.id) || [];
    const badgeClass = r.status === "OUTBOUND" ? "out" : "in";
    const badgeTxt = r.status === "OUTBOUND" ? "OUTBOUND" : "INBOUND";

    const div = document.createElement("div");
    div.className = "res";

    div.innerHTML = `
      <div class="top">
        <div>
          <div class="tag">${escapeHtml(r.tag_id)}</div>
          <div class="meta">
            <b>Location:</b> ${escapeHtml(r.aisle_name)} • Rail ${r.rail} • Level ${r.level}<br>
            <b>Updated:</b> ${new Date(r.updated_at || r.created_at).toLocaleString()}
            ${r.outbound_at ? `<br><b>Outbound at:</b> ${new Date(r.outbound_at).toLocaleString()}` : ``}
            ${r.notes ? `<br><b>Notes:</b> ${escapeHtml(r.notes)}` : ``}
          </div>
        </div>
        <div class="badge ${badgeClass}">${badgeTxt}</div>
      </div>

      <div class="thumbs" id="thumbs_${r.id}"></div>

      <div class="btnrow" style="margin-top:10px">
        <button class="secondary" data-act="fill" data-id="${r.id}">Load into form</button>
        <button class="secondary" data-act="map" data-id="${r.id}">Open in Aisle View</button>
        <button class="secondary" data-act="copytag" data-id="${r.id}">Copy tag</button>
        <button class="secondary" data-act="copyloc" data-id="${r.id}">Copy location</button>
        <button class="secondary" data-act="addphoto" data-id="${r.id}">Add photo</button>
        <button class="secondary" data-act="in" data-id="${r.id}">Inbound</button>
        <button class="secondary" data-act="out" data-id="${r.id}">Outbound</button>
      </div>
    `;

    const thumbs = div.querySelector(`#thumbs_${CSS.escape(r.id)}`);
    if(photos.length){
      for(const p of photos.slice(0,8)){
        const t = document.createElement("div");
        t.className = "thumb";
        const url = publicUrl(p);
        t.innerHTML = `<img src="${url}" alt="photo" loading="lazy" />`;
        t.addEventListener("click", (e)=>{
          e.stopPropagation();
          showModal(`${r.tag_id} — ${r.aisle_name} / R${r.rail} / L${r.level}`, url);
        });
        thumbs.appendChild(t);
      }
    } else {
      thumbs.innerHTML = `<div class="small">No photos saved for this tag.</div>`;
    }

    div.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;

      const act = btn.getAttribute("data-act");
      if(!act) return;

      if(act === "fill"){
        ui.tagInput.value = r.tag_id;
        ui.aisleSel.value = r.aisle_name;
        ui.railSel.value = String(r.rail);
        ui.levelSel.value = String(r.level);
        ui.notesInput.value = r.notes || "";
        setTab("save");
        toast("Loaded into form.", "ok");
      }

      if(act === "map"){
        setTab("map");
        ui.mapAisleSel.value = r.aisle_name;
        await refreshMap();
        openCellDrawer(r.aisle_name, r.rail, r.level);
      }

      if(act === "copytag"){
        await copyText(r.tag_id);
      }

      if(act === "copyloc"){
        await copyText(`${r.aisle_name} / Rail ${r.rail} / Level ${r.level}`);
      }

      if(act === "addphoto"){
        // Use the Save form photo input, but link to THIS tag row without changing location/status
        setTab("save");
        ui.tagInput.value = r.tag_id;
        ui.aisleSel.value = r.aisle_name;
        ui.railSel.value = String(r.rail);
        ui.levelSel.value = String(r.level);
        ui.notesInput.value = r.notes || "";
        toast("Pick a photo, then click Save (it will attach to this tag).", "ok");
      }

      if(act === "in"){
        ui.tagInput.value = r.tag_id;
        ui.aisleSel.value = r.aisle_name;
        ui.railSel.value = String(r.rail);
        ui.levelSel.value = String(r.level);
        ui.notesInput.value = r.notes || "";
        await saveWithStatus("INBOUND");
        await doSearch(ui.searchInput.value);
      }

      if(act === "out"){
        ui.tagInput.value = r.tag_id;
        ui.aisleSel.value = r.aisle_name;
        ui.railSel.value = String(r.rail);
        ui.levelSel.value = String(r.level);
        ui.notesInput.value = r.notes || "";
        await saveWithStatus("OUTBOUND");
        await doSearch(ui.searchInput.value);
      }
    });

    ui.results.appendChild(div);
  }
}

/** =========================================================
 *  Search modes
 * ========================================================= */
async function doSearch(raw){
  const q = normTag(raw);
  if(!q){ toast("Type a tag to search.", "bad"); return; }

  ui.searchBtn.disabled = true;
  ui.results.innerHTML = `<div class="small">Searching…</div>`;

  try{
    const mode = ui.searchMode.value;

    let query = sb.from("pallet_tags").select("*").order("updated_at", { ascending:false }).limit(50);

    if(mode === "exact"){
      query = query.eq("tag_id", q);
    } else if(mode === "starts"){
      // Case-insensitive "starts with"
      query = query.ilike("tag_id", `${q}%`);
    } else {
      // contains
      query = query.ilike("tag_id", `%${q}%`);
    }

    const { data, error } = await query;
    if(error) throw error;

    const rows = data || [];
    const ids = rows.map(r=>r.id);
    const photoMap = await fetchPhotosForTagIds(ids);
    renderResults(rows, photoMap);
  }catch(err){
    console.error(err);
    ui.results.innerHTML = `<div class="small">Search failed.</div>`;
    toast(`Search failed: ${err.message || err}`, "bad");
  }finally{
    ui.searchBtn.disabled = false;
  }
}

async function recentTags(){
  ui.results.innerHTML = `<div class="small">Loading recent…</div>`;
  try{
    const { data, error } = await sb
      .from("pallet_tags")
      .select("*")
      .order("updated_at", { ascending:false })
      .limit(25);
    if(error) throw error;

    const rows = data || [];
    const ids = rows.map(r=>r.id);
    const photoMap = await fetchPhotosForTagIds(ids);
    renderResults(rows, photoMap);
  }catch(err){
    console.error(err);
    toast(`Recent failed: ${err.message || err}`, "bad");
    ui.results.innerHTML = `<div class="small">Could not load recent.</div>`;
  }
}

/** =========================================================
 *  KPIs
 * ========================================================= */
async function refreshKPIs(){
  try{
    const total = await sb.from("pallet_tags").select("id", { count:"exact", head:true });
    const inbound = await sb.from("pallet_tags").select("id", { count:"exact", head:true }).eq("status","INBOUND");
    const outbound = await sb.from("pallet_tags").select("id", { count:"exact", head:true }).eq("status","OUTBOUND");

    ui.kpiTotal.textContent = (total.count ?? "—");
    ui.kpiInbound.textContent = (inbound.count ?? "—");
    ui.kpiOutbound.textContent = (outbound.count ?? "—");
  }catch(err){
    console.error(err);
  }
}

/** =========================================================
 *  AISLE VIEW
 * ========================================================= */
let mapFilter = "ALL"; // ALL | INBOUND | OUTBOUND
let aisleCache = { aisle:null, rows:[], byCell:new Map(), photoMap:new Map() };
let openCell = null; // {aisle, rail, level}

function setFilter(f){
  mapFilter = f;
  ui.fAll.classList.toggle("on", f==="ALL");
  ui.fIn.classList.toggle("on", f==="INBOUND");
  ui.fOut.classList.toggle("on", f==="OUTBOUND");
  refreshMap({ keepDrawer:true });
}
function cellKey(rail, level){ return `${rail}|${level}`; }

async function loadAisleRows(aisleName){
  let q = sb.from("pallet_tags").select("*").eq("aisle_name", aisleName);
  if(mapFilter === "INBOUND") q = q.eq("status","INBOUND");
  if(mapFilter === "OUTBOUND") q = q.eq("status","OUTBOUND");

  const { data, error } = await q.order("updated_at", { ascending:false });
  if(error) throw error;

  const rows = data || [];
  const ids = rows.map(r=>r.id);
  const photoMap = await fetchPhotosForTagIds(ids);

  const byCell = new Map();
  for(const r of rows){
    const k = cellKey(r.rail, r.level);
    if(!byCell.has(k)) byCell.set(k, []);
    byCell.get(k).push(r);
  }

  aisleCache = { aisle: aisleName, rows, byCell, photoMap };
}

function buildMapGrid(){
  const g = ui.mapGrid;
  g.innerHTML = "";

  const blank = document.createElement("div");
  blank.className = "mapHdr";
  blank.textContent = "Level \\ Rail";
  g.appendChild(blank);

  for(let rail=1; rail<=21; rail++){
    const h = document.createElement("div");
    h.className = "mapHdr";
    h.textContent = `R${rail}`;
    g.appendChild(h);
  }

  for(let level=5; level>=1; level--){
    const lbl = document.createElement("div");
    lbl.className = "mapRowLbl";
    lbl.textContent = `L${level}`;
    g.appendChild(lbl);

    for(let rail=1; rail<=21; rail++){
      const k = cellKey(rail, level);
      const list = aisleCache.byCell.get(k) || [];
      const inboundCount = list.filter(x=>x.status==="INBOUND").length;
      const outboundCount = list.filter(x=>x.status==="OUTBOUND").length;

      const cell = document.createElement("div");
      cell.className = "cell";
      if(!list.length) cell.classList.add("empty");
      if(list.length){
        if(inboundCount && outboundCount) cell.classList.add("mixed");
        else if(inboundCount) cell.classList.add("inOnly");
        else if(outboundCount) cell.classList.add("outOnly");
      }

      const top = list.length ? `${list.length}` : "—";
      const sub = list.length ? `${inboundCount} in • ${outboundCount} out` : "empty";

      cell.innerHTML = `<div class="c1">${top}</div><div class="c2">${sub}</div>`;
      cell.addEventListener("click", ()=>openCellDrawer(aisleCache.aisle, rail, level));
      g.appendChild(cell);
    }
  }
}

async function refreshMap(opts={}){
  try{
    const aisleName = ui.mapAisleSel.value;
    if(!aisleName) return;

    await loadAisleRows(aisleName);
    buildMapGrid();

    if(opts.keepDrawer && openCell && openCell.aisle === aisleName){
      openCellDrawer(openCell.aisle, openCell.rail, openCell.level, { silent:true });
    } else {
      ui.cellDrawer.style.display = "none";
      openCell = null;
    }
  }catch(err){
    console.error(err);
    toast(`Aisle view failed: ${err.message || err}`, "bad");
  }
}

function openCellDrawer(aisleName, rail, level, opts={}){
  openCell = { aisle:aisleName, rail, level };
  const k = cellKey(rail, level);
  const list = aisleCache.byCell.get(k) || [];

  ui.drawerTitle.textContent = `${aisleName} • Rail ${rail} • Level ${level}`;
  ui.drawerSub.textContent = `Showing ${list.length} tag(s) (${mapFilter === "ALL" ? "all" : mapFilter.toLowerCase()}).`;
  ui.drawerList.innerHTML = "";

  if(!list.length){
    ui.drawerList.innerHTML = `<div class="small">No tags saved in this spot. Click “Add tag here”.</div>`;
    ui.cellDrawer.style.display = "";
    if(!opts.silent) toast("Cell opened.", "ok");
    return;
  }

  for(const r of list){
    const photos = aisleCache.photoMap.get(r.id) || [];
    const badgeClass = r.status === "OUTBOUND" ? "out" : "in";
    const badgeTxt = r.status === "OUTBOUND" ? "OUTBOUND" : "INBOUND";

    const thumbs = photos.slice(0,3).map(p=>{
      const url = publicUrl(p);
      return `<div class="thumb" style="width:96px;height:70px" data-url="${escapeHtml(url)}" data-title="${escapeHtml(r.tag_id)}"><img src="${url}" loading="lazy" alt="photo"></div>`;
    }).join("");

    const item = document.createElement("div");
    item.className = "miniRow";
    item.innerHTML = `
      <div class="miniLeft">
        <div class="t">${escapeHtml(r.tag_id)}</div>
        <div class="s">
          <span class="badge ${badgeClass}" style="padding:6px 9px">${badgeTxt}</span>
          &nbsp;• Updated ${new Date(r.updated_at || r.created_at).toLocaleString()}
          ${r.outbound_at ? `<br>Outbound at ${new Date(r.outbound_at).toLocaleString()}` : ``}
          ${r.notes ? `<br>Notes: ${escapeHtml(r.notes)}` : ``}
        </div>
        ${thumbs ? `<div class="thumbs" style="margin-top:8px">${thumbs}</div>` : `<div class="small" style="margin-top:8px">No photos for this tag.</div>`}
      </div>
      <div class="btnrow" style="margin-top:0">
        <button class="secondary" data-act="load">Load</button>
        <button class="secondary" data-act="copy">Copy</button>
        <button class="secondary" data-act="in">Inbound</button>
        <button class="secondary" data-act="out">Outbound</button>
      </div>
    `;

    item.querySelectorAll(".thumb").forEach(th=>{
      th.addEventListener("click",(e)=>{
        e.stopPropagation();
        showModal(`${r.tag_id} — ${r.aisle_name} / R${r.rail} / L${r.level}`, th.getAttribute("data-url"));
      });
    });

    item.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const act = btn.getAttribute("data-act");
      if(!act) return;

      if(act === "load"){
        ui.tagInput.value = r.tag_id;
        ui.aisleSel.value = r.aisle_name;
        ui.railSel.value = String(r.rail);
        ui.levelSel.value = String(r.level);
        ui.notesInput.value = r.notes || "";
        setTab("save");
        toast("Loaded into form.", "ok");
      }

      if(act === "copy"){
        await copyText(`${r.tag_id} — ${r.aisle_name} / Rail ${r.rail} / Level ${r.level}`);
      }

      if(act === "in"){
        ui.tagInput.value = r.tag_id;
        ui.aisleSel.value = r.aisle_name;
        ui.railSel.value = String(r.rail);
        ui.levelSel.value = String(r.level);
        ui.notesInput.value = r.notes || "";
        await saveWithStatus("INBOUND");
      }

      if(act === "out"){
        ui.tagInput.value = r.tag_id;
        ui.aisleSel.value = r.aisle_name;
        ui.railSel.value = String(r.rail);
        ui.levelSel.value = String(r.level);
        ui.notesInput.value = r.notes || "";
        await saveWithStatus("OUTBOUND");
      }
    });

    ui.drawerList.appendChild(item);
  }

  ui.cellDrawer.style.display = "";
  if(!opts.silent) toast("Cell opened.", "ok");
}

async function jumpToLatestTagCell(){
  try{
    const { data, error } = await sb.from("pallet_tags").select("*").order("updated_at",{ascending:false}).limit(1).single();
    if(error) throw error;
    if(!data) return;

    setTab("map");
    ui.mapAisleSel.value = data.aisle_name;
    await refreshMap();
    openCellDrawer(data.aisle_name, data.rail, data.level);
  }catch(err){
    console.error(err);
    toast(`Could not jump to latest: ${err.message || err}`, "bad");
  }
}

/** =========================================================
 *  Init + events
 * ========================================================= */
async function init(){
  try{
    sb = supabase.createClient(SB_URL, SB_ANON);
    setConn(true, "Connected");
    await loadAisles();
    await refreshKPIs();
    await recentTags();
  }catch(err){
    console.error(err);
    setConn(false, "Not connected");
    toast(`Init failed: ${err.message || err}`, "bad");
  }
}

ui.tabSave.addEventListener("click", ()=>setTab("save"));
ui.tabSearch.addEventListener("click", ()=>setTab("search"));
ui.tabMap.addEventListener("click", ()=>setTab("map"));

ui.saveBtn.addEventListener("click", ()=>saveWithStatus("INBOUND"));
ui.outBtn.addEventListener("click", ()=>saveWithStatus("OUTBOUND"));
ui.inBtn.addEventListener("click", ()=>saveWithStatus("INBOUND"));
ui.moveBtn.addEventListener("click", moveTagNoPhoto);

ui.clearBtn.addEventListener("click", ()=>{
  ui.tagInput.value = "";
  ui.notesInput.value = "";
  ui.photoInput.value = "";
  ui.railSel.value = "1";
  ui.levelSel.value = "1";
  toast("Cleared form.", "ok");
});

ui.searchBtn.addEventListener("click", ()=>doSearch(ui.searchInput.value));
ui.searchInput.addEventListener("keydown",(e)=>{
  if(e.key === "Enter"){ e.preventDefault(); doSearch(ui.searchInput.value); }
});
ui.recentBtn.addEventListener("click", recentTags);
ui.refreshBtn.addEventListener("click", refreshKPIs);

ui.mapAisleSel.addEventListener("change", ()=>refreshMap());
ui.mapRefreshBtn.addEventListener("click", ()=>refreshMap());
ui.mapRecentBtn.addEventListener("click", jumpToLatestTagCell);
ui.fAll.addEventListener("click", ()=>setFilter("ALL"));
ui.fIn.addEventListener("click", ()=>setFilter("INBOUND"));
ui.fOut.addEventListener("click", ()=>setFilter("OUTBOUND"));

ui.drawerCloseBtn.addEventListener("click", ()=>{
  ui.cellDrawer.style.display = "none";
  openCell = null;
});
ui.drawerAddBtn.addEventListener("click", ()=>{
  if(!openCell){ toast("Open a cell first.", "bad"); return; }
  ui.aisleSel.value = openCell.aisle;
  ui.railSel.value = String(openCell.rail);
  ui.levelSel.value = String(openCell.level);
  setTab("save");
  ui.tagInput.focus();
  toast("Prefilled location. Now scan/type tag and save.", "ok");
});

init();
</script>
</body>
</html>
