<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LocateMe — Warehouse Tag Locator</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#060709;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.09);
      --stroke:rgba(255,255,255,.12);
      --text:#eaecef;
      --muted:rgba(234,236,239,.72);
      --gold1:#f6d57a;
      --gold2:#caa24d;
      --shadow:0 12px 40px rgba(0,0,0,.45);
      --radius:18px;
      --ok:#38d27a;
      --bad:#ff5964;
      --warn:#ffcc66;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(246,213,122,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 20%, rgba(202,162,77,.14), transparent 55%),
                  linear-gradient(180deg, #050507, #07080b 60%, #060709);
      overflow-x:hidden;
    }
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px 60px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; border:1px solid var(--stroke); border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:10px}
    .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(180deg,var(--gold1),var(--gold2))}
    .title{font-weight:800; letter-spacing:.3px}
    .sub{color:var(--muted); font-size:12px}
    .btn{
      appearance:none; border:1px solid var(--stroke); color:var(--text);
      background:rgba(255,255,255,.06); padding:10px 12px; border-radius:14px;
      cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      border:1px solid var(--stroke); border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow:var(--shadow);
      padding:14px;
    }
    .h{font-weight:800; margin:0 0 8px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:14px;
      border:1px solid var(--stroke); outline:none;
      background:rgba(0,0,0,.25); color:var(--text);
    }
    textarea{min-height:80px; resize:vertical}
    .small{font-size:12px;color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px; border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);
      font-size:12px; color:var(--muted);
    }
    .ok{color:var(--ok)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}
    .gold{color:var(--gold1)}
    .list{display:flex; flex-direction:column; gap:10px; margin-top:10px}
    .item{
      border:1px solid var(--stroke); border-radius:16px; padding:12px;
      background:rgba(0,0,0,.22);
    }
    .itemTop{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .tag{font-weight:900; letter-spacing:.2px}
    .meta{color:var(--muted); font-size:12px}
    .photos{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .photo{
      width:170px; border-radius:14px; border:1px solid var(--stroke);
      overflow:hidden; background:rgba(255,255,255,.05);
    }
    .photo img{width:100%; height:120px; object-fit:cover; display:block}
    .photo .cap{padding:8px 10px; font-size:12px; color:var(--muted)}
    .overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.72);
      backdrop-filter: blur(8px);
      z-index:50;
    }
    .pinbox{
      width:min(520px, 92vw);
      border:1px solid rgba(255,255,255,.18);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow:0 30px 90px rgba(0,0,0,.65);
      padding:18px;
    }
    .pinhead{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .pinhead .big{font-weight:900; font-size:18px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}

    /* MAP */
    .mapWrap{
      border:1px solid var(--stroke);
      border-radius:16px;
      background:rgba(0,0,0,.18);
      overflow:hidden;
    }
    .mapHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
    }
    .mapLegend{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      background:rgba(0,0,0,.18);
    }
    .swatch{
      width:10px;height:10px;border-radius:3px;display:inline-block;
      background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.14);
    }
    .swatch.sel{background:rgba(246,213,122,.30); border-color:rgba(246,213,122,.70)}
    .swatch.ais{background:rgba(56,210,122,.22); border-color:rgba(56,210,122,.55)}
    svg{display:block; width:100%; height:auto}
    .railCell{cursor:pointer}
    .railCell:hover{opacity:.9}
    .labelText{font-size:11px; fill:rgba(234,236,239,.85)}
    .tiny{font-size:10px; fill:rgba(234,236,239,.65)}
  </style>
</head>
<body>
  <!-- PIN Gate -->
  <div id="pinOverlay" class="overlay">
    <div class="pinbox">
      <div class="pinhead">
        <div class="big">Enter PIN</div>
        <span class="pill">Warehouse</span>
      </div>

      <label>PIN</label>
      <input id="pinInput" inputmode="numeric" placeholder="2026" />

      <div class="actions">
        <button class="btn" id="pinBtn">Unlock</button>
        <button class="btn" id="pinClear">Clear</button>
      </div>

      <div id="pinMsg" class="small" style="margin-top:10px;"></div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <div>
          <div class="title">LocateMe</div>
          <div class="sub">PIN-locked warehouse tag locator + clickable map</div>
        </div>
      </div>
      <div class="row">
        <span id="connPill" class="pill"><span class="gold">●</span> Locked</span>
        <button class="btn" id="logoutBtn" style="display:none;">Lock</button>
      </div>
    </div>

    <div class="grid">
      <!-- Add / Update -->
      <div class="card">
        <h3 class="h">Save / Update a Tag</h3>
        <div class="small">Pick aisle → rail (1–21) → level (1–5), add photo, save.</div>

        <label>Tag ID</label>
        <input id="tagId" placeholder="Type (camera scan later) or paste the tag" />

        <div class="row">
          <div style="flex:1; min-width:220px;">
            <label>Aisle</label>
            <select id="aisleSel"></select>
          </div>
          <div style="flex:.7; min-width:160px;">
            <label>Rail</label>
            <select id="railSel"></select>
          </div>
          <div style="flex:.7; min-width:160px;">
            <label>Level</label>
            <select id="levelSel"></select>
          </div>
        </div>

        <label>Status</label>
        <select id="statusSel">
          <option value="INBOUND">INBOUND</option>
          <option value="OUTBOUND">OUTBOUND</option>
        </select>

        <label>Notes (optional)</label>
        <textarea id="notes" placeholder="Anything helpful…"></textarea>

        <label>Photo (optional)</label>
        <input id="photoFile" type="file" accept="image/*" />

        <div class="actions">
          <button class="btn" id="saveBtn">Save</button>
          <button class="btn" id="backBtn">Back (Undo last choice)</button>
          <button class="btn" id="purgeBtn">Purge OUTBOUND &gt; 5 days</button>
        </div>

        <div id="saveMsg" class="small" style="margin-top:10px;"></div>
      </div>

      <!-- Right side: Map + Search -->
      <div class="card">
        <h3 class="h">Clickable Warehouse Map</h3>
        <div class="small">Click an aisle row, then click a rail box. It fills Aisle + Rail.</div>

        <div class="actions" style="margin-top:10px;">
          <button class="btn" id="addAislesBtn">Create missing aisles in Supabase</button>
          <button class="btn" id="centerSelectBtn">Select current dropdown on map</button>
        </div>

        <div id="aisleWarn" class="small" style="margin-top:10px;"></div>

        <div class="divider"></div>

        <div class="mapWrap">
          <div class="mapHead">
            <div class="mapLegend">
              <span class="chip"><span class="swatch ais"></span> aisle row</span>
              <span class="chip"><span class="swatch sel"></span> selected rail</span>
              <span class="chip">Rails 1–21</span>
              <span class="chip">Levels 1–5</span>
            </div>
            <span class="pill" id="mapPick">No selection</span>
          </div>
          <div id="mapHost"></div>
        </div>

        <div class="divider"></div>

        <h3 class="h" style="margin-top:0;">Search by Tag</h3>
        <div class="small">Type a tag → pulls aisle/rail/level + photo(s).</div>

        <label>Search</label>
        <input id="searchInput" placeholder="Tag ID…" />

        <div class="actions">
          <button class="btn" id="searchBtn">Search</button>
          <button class="btn" id="recentBtn">Recently Updated</button>
        </div>

        <div id="results" class="list"></div>
      </div>
    </div>
  </div>

<script>
/** ================================
 *  CONFIG
 * ================================ */
const SUPABASE_URL = "https://ojdfaguhteddwaxyobnl.supabase.co";
const SUPABASE_ANON = "sb_publishable_S4Z3E2phukZklKtBuRPLjA_RB4Faij2";

const BUCKET = "warehouse-photos";
const RAIL_MAX = 21;
const LEVEL_MAX = 5;

// Hard PIN (no Supabase auth; overlay-only lock)
const PIN_CODE = "2026";

// Warehouse aisle order (matches your drawing vibe)
const AISLE_ORDER = [
  "AEX",
  "Maserati",
  "Mercedes",
  "Bentley",
  "Pagani",
  "Aston Martin",
  "McLaren",
  "Ferrari",
  "Lamborghini",
  "Bugatti"
];

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/** ================================
 *  UI
 * ================================ */
const ui = {
  overlay: document.getElementById("pinOverlay"),
  pin: document.getElementById("pinInput"),
  pinBtn: document.getElementById("pinBtn"),
  pinClear: document.getElementById("pinClear"),
  pinMsg: document.getElementById("pinMsg"),
  connPill: document.getElementById("connPill"),
  logoutBtn: document.getElementById("logoutBtn"),

  tagId: document.getElementById("tagId"),
  aisleSel: document.getElementById("aisleSel"),
  railSel: document.getElementById("railSel"),
  levelSel: document.getElementById("levelSel"),
  statusSel: document.getElementById("statusSel"),
  notes: document.getElementById("notes"),
  photoFile: document.getElementById("photoFile"),
  saveBtn: document.getElementById("saveBtn"),
  backBtn: document.getElementById("backBtn"),
  purgeBtn: document.getElementById("purgeBtn"),
  saveMsg: document.getElementById("saveMsg"),

  searchInput: document.getElementById("searchInput"),
  searchBtn: document.getElementById("searchBtn"),
  recentBtn: document.getElementById("recentBtn"),
  results: document.getElementById("results"),

  mapHost: document.getElementById("mapHost"),
  mapPick: document.getElementById("mapPick"),
  aisleWarn: document.getElementById("aisleWarn"),
  addAislesBtn: document.getElementById("addAislesBtn"),
  centerSelectBtn: document.getElementById("centerSelectBtn"),
};

let selectionHistory = [];
let existingAisles = new Set();
let lastMapSelection = { aisle: "", rail: 0 };

/** ================================
 *  Helpers
 * ================================ */
function setConn(state){
  ui.connPill.innerHTML = state === "ok"
    ? `<span class="ok">●</span> Unlocked`
    : `<span class="gold">●</span> Locked`;
}
function msg(el, text, good=false){
  el.innerHTML = good ? `<span class="ok">${text}</span>` : `<span class="bad">${text}</span>`;
}
function safe(s){ return (s||"").toString().trim(); }

function fillNumericSelect(sel, max){
  sel.innerHTML = "";
  for(let i=1;i<=max;i++){
    const opt=document.createElement("option");
    opt.value=i; opt.textContent=i;
    sel.appendChild(opt);
  }
}

async function loadAisles(){
  const { data, error } = await sb.from("aisles").select("name").order("name", {ascending:true});
  if(error){
    ui.aisleSel.innerHTML = `<option value="">(Aisles table error)</option>`;
    existingAisles = new Set();
    ui.aisleWarn.innerHTML = `<span class="bad">${error.message}</span>`;
    return;
  }
  existingAisles = new Set((data||[]).map(x=>x.name));

  const ordered = [];
  for(const n of AISLE_ORDER){
    if(existingAisles.has(n)) ordered.push(n);
  }
  for(const n of Array.from(existingAisles).sort()){
    if(!ordered.includes(n)) ordered.push(n);
  }
  if(ordered.length===0){
    ui.aisleSel.innerHTML = `<option value="">(No aisles yet)</option>`;
  }else{
    ui.aisleSel.innerHTML = ordered.map(n=>`<option value="${n}">${n}</option>`).join("");
  }
  showAisleMissingWarning();
}

function showAisleMissingWarning(){
  const missing = AISLE_ORDER.filter(a => !existingAisles.has(a));
  if(missing.length){
    ui.aisleWarn.innerHTML = `<span class="warn">Missing aisles:</span> ${missing.join(", ")}. Click “Create missing aisles…”`;
  }else{
    ui.aisleWarn.innerHTML = `<span class="ok">All map aisles exist in Supabase ✅</span>`;
  }
}

async function signedUrl(path){
  // If your bucket is PUBLIC, this will still work; if PRIVATE, it may require auth policies.
  const { data, error } = await sb.storage.from(BUCKET).createSignedUrl(path, 60 * 10);
  if(error) return null;
  return data.signedUrl;
}

async function uploadPhoto(file, tagId){
  const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
  const cleanTag = tagId.replace(/[^a-zA-Z0-9._-]/g, "_");
  const objectPath = `${cleanTag}/${Date.now()}_${Math.random().toString(16).slice(2)}.${ext}`;

  const { error: upErr } = await sb.storage.from(BUCKET).upload(objectPath, file, {
    cacheControl: "3600",
    upsert: false,
    contentType: file.type || "image/jpeg",
  });
  if(upErr) throw upErr;
  return { objectPath, fileName: file.name, contentType: file.type };
}

/** ================================
 *  PIN (overlay-only)
 * ================================ */
function unlockWithPin(pin){
  pin = safe(pin);
  if(!pin) return msg(ui.pinMsg, "Enter PIN.");
  if(pin !== PIN_CODE){
    msg(ui.pinMsg, "Wrong PIN.");
    return;
  }
  ui.overlay.style.display = "none";
  ui.logoutBtn.style.display = "";
  setConn("ok");
  initApp();
}

function lockApp(){
  ui.overlay.style.display = "flex";
  ui.logoutBtn.style.display = "none";
  setConn("locked");
}

/** ================================
 *  Save / Update tag location
 * ================================ */
async function saveTag(){
  const tagId = safe(ui.tagId.value);
  const aisle = safe(ui.aisleSel.value);
  const rail = parseInt(ui.railSel.value, 10);
  const level = parseInt(ui.levelSel.value, 10);
  const status = ui.statusSel.value;
  const notes = safe(ui.notes.value);
  const file = ui.photoFile.files && ui.photoFile.files[0];

  if(!tagId) return msg(ui.saveMsg, "Tag ID is required.");
  if(!aisle) return msg(ui.saveMsg, "Pick an aisle.");
  if(existingAisles.size && !existingAisles.has(aisle)) return msg(ui.saveMsg, `Aisle "${aisle}" doesn't exist yet. Click “Create missing aisles…”.`);
  if(!(rail>=1 && rail<=RAIL_MAX)) return msg(ui.saveMsg, "Rail out of range.");
  if(!(level>=1 && level<=LEVEL_MAX)) return msg(ui.saveMsg, "Level out of range.");

  ui.saveBtn.disabled = true;
  ui.saveBtn.textContent = "Saving...";
  ui.saveMsg.textContent = "";

  try{
    const { data: row, error } = await sb
      .from("pallet_tags")
      .insert([{
        tag_id: tagId,
        aisle_name: aisle,
        rail,
        level,
        status,
        notes: notes || null
      }])
      .select("*")
      .single();

    if(error) throw error;

    if(file){
      const up = await uploadPhoto(file, tagId);
      const { error: phErr } = await sb
        .from("tag_photos")
        .insert([{
          pallet_tag_id: row.id,
          bucket: BUCKET,
          object_path: up.objectPath,
          file_name: up.fileName,
          content_type: up.contentType
        }]);
      if(phErr) throw phErr;
    }

    msg(ui.saveMsg, "Saved ✅", true);
    ui.photoFile.value = "";
  }catch(e){
    msg(ui.saveMsg, e.message || "Save failed.");
  }finally{
    ui.saveBtn.disabled = false;
    ui.saveBtn.textContent = "Save";
  }
}

/** ================================
 *  Search
 * ================================ */
async function renderTagResults(tagId){
  ui.results.innerHTML = "";
  tagId = safe(tagId);
  if(!tagId) return;

  const { data, error } = await sb
    .from("pallet_tags")
    .select("id, tag_id, aisle_name, rail, level, status, notes, updated_at, created_at")
    .eq("tag_id", tagId)
    .order("created_at", { ascending: false })
    .limit(10);

  if(error){
    ui.results.innerHTML = `<div class="item"><div class="bad">${error.message}</div></div>`;
    return;
  }
  if(!data || data.length === 0){
    ui.results.innerHTML = `<div class="item"><div class="meta">No results for <b>${tagId}</b></div></div>`;
    return;
  }

  for(const r of data){
    const { data: photos } = await sb
      .from("tag_photos")
      .select("object_path, file_name, created_at")
      .eq("pallet_tag_id", r.id)
      .order("created_at", { ascending: false })
      .limit(6);

    const photoHtml = [];
    if(photos && photos.length){
      for(const p of photos){
        const url = await signedUrl(p.object_path);
        if(!url) continue;
        photoHtml.push(`
          <div class="photo">
            <img src="${url}" alt="photo"/>
            <div class="cap">${p.file_name || "photo"}</div>
          </div>
        `);
      }
    }

    ui.results.innerHTML += `
      <div class="item">
        <div class="itemTop">
          <div>
            <div class="tag">${r.tag_id}</div>
            <div class="meta">
              ${r.aisle_name} • Rail ${r.rail} • Level ${r.level}
              • <b class="${r.status==='OUTBOUND'?'bad':'ok'}">${r.status}</b>
            </div>
            ${r.notes ? `<div class="meta" style="margin-top:6px;">${r.notes}</div>` : ""}
          </div>
          <div class="meta">
            Updated: ${new Date(r.updated_at).toLocaleString()}
          </div>
        </div>
        ${photoHtml.length ? `<div class="photos">${photoHtml.join("")}</div>` : `<div class="meta" style="margin-top:10px;">No photos</div>`}
      </div>
    `;
  }
}

async function renderRecent(){
  ui.results.innerHTML = "";

  const { data, error } = await sb
    .from("pallet_tags")
    .select("tag_id, aisle_name, rail, level, status, updated_at")
    .order("updated_at", { ascending: false })
    .limit(15);

  if(error){
    ui.results.innerHTML = `<div class="item"><div class="bad">${error.message}</div></div>`;
    return;
  }
  if(!data || data.length === 0){
    ui.results.innerHTML = `<div class="item"><div class="meta">No data yet.</div></div>`;
    return;
  }

  ui.results.innerHTML = data.map(r => `
    <div class="item">
      <div class="itemTop">
        <div>
          <div class="tag">${r.tag_id}</div>
          <div class="meta">${r.aisle_name} • Rail ${r.rail} • Level ${r.level} • <b class="${r.status==='OUTBOUND'?'bad':'ok'}">${r.status}</b></div>
        </div>
        <div class="meta">${new Date(r.updated_at).toLocaleString()}</div>
      </div>
      <div class="actions" style="margin-top:10px;">
        <button class="btn" onclick="window.__openTag('${r.tag_id.replace(/'/g,"\\'")}')">Open</button>
      </div>
    </div>
  `).join("");
}

window.__openTag = (t)=>{ ui.searchInput.value=t; renderTagResults(t); };

/** ================================
 *  Purge
 * ================================ */
async function purgeOutbound(){
  ui.purgeBtn.disabled = true;
  ui.purgeBtn.textContent = "Purging...";
  try{
    const { data, error } = await sb.rpc("purge_outbound_older_than", { days: 5 });
    if(error) throw error;
    msg(ui.saveMsg, `Purged ✅  Tags: ${data.pallet_tags_deleted} | Photos: ${data.tag_photos_deleted}`, true);
  }catch(e){
    msg(ui.saveMsg, e.message || "Purge failed.");
  }finally{
    ui.purgeBtn.disabled = false;
    ui.purgeBtn.textContent = "Purge OUTBOUND > 5 days";
  }
}

/** ================================
 *  Back button (selection undo)
 * ================================ */
function pushHistory(){
  selectionHistory.push({
    aisle: ui.aisleSel.value,
    rail: ui.railSel.value,
    level: ui.levelSel.value,
    status: ui.statusSel.value
  });
  if(selectionHistory.length > 25) selectionHistory.shift();
}

function popHistory(){
  const prev = selectionHistory.pop();
  if(!prev) return;
  ui.aisleSel.value = prev.aisle;
  ui.railSel.value = prev.rail;
  ui.levelSel.value = prev.level;
  ui.statusSel.value = prev.status;
  syncMapToDropdown();
}

/** ================================
 *  MAP (SVG)
 * ================================ */
function svgEl(tag, attrs={}){
  const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
  for(const [k,v] of Object.entries(attrs)) el.setAttribute(k, v);
  return el;
}

function aisleColor(aisle){
  const base = [
    "rgba(56,210,122,.18)",
    "rgba(246,213,122,.18)",
    "rgba(202,162,77,.16)",
    "rgba(120,180,255,.14)",
    "rgba(255,120,180,.12)"
  ];
  const i = Math.abs(hash(aisle)) % base.length;
  return base[i];
}

function hash(s){
  let h = 0;
  for(let i=0;i<s.length;i++) h = ((h<<5) - h) + s.charCodeAt(i), h|=0;
  return h;
}

function buildMap(){
  const width = 1080;
  const pad = 18;
  const cellW = 28;
  const cellH = 22;
  const gapY = 14;
  const labelW = 150;

  const rows = [
    { aisle:"AEX", rails: RAIL_MAX, height: 58, note:"Top zone" },
    { aisle:"Maserati", rails: 6, height: cellH, note:"Top right" },
    { aisle:"Mercedes", rails: 3, height: cellH, note:"Top right" },
    { aisle:"Bentley", rails: 12, height: cellH*2+6, note:"Top middle" },
    { aisle:"Pagani", rails: 8, height: cellH, note:"Top middle" },
    { aisle:"Aston Martin", rails: 12, height: cellH*2+6, note:"Mid long" },
    { aisle:"McLaren", rails: 10, height: cellH*2+6, note:"Mid right" },
    { aisle:"Ferrari", rails: 10, height: cellH*2+6, note:"Mid right" },
    { aisle:"Lamborghini", rails: 12, height: cellH*2+6, note:"Lower middle" },
    { aisle:"Bugatti", rails: RAIL_MAX, height: cellH, note:"Bottom long" },
  ];

  let y = pad;
  for(const r of rows){
    y += 32;
    y += r.height;
    y += gapY;
  }
  const height = y + pad + 40;

  const svg = svgEl("svg", { viewBox:`0 0 ${width} ${height}` });

  svg.appendChild(svgEl("rect", {
    x: 8, y: 8, width: width-16, height: height-16,
    rx: 18, fill:"rgba(0,0,0,.12)", stroke:"rgba(255,255,255,.14)", "stroke-width":"2"
  }));

  const door = (x,y,label)=>{
    const g = svgEl("g");
    g.appendChild(svgEl("rect",{x, y, width:90, height:32, rx:12, fill:"rgba(255,255,255,.05)", stroke:"rgba(255,255,255,.14)"}));
    const t = svgEl("text",{x:x+45, y:y+21, "text-anchor":"middle", class:"labelText"});
    t.textContent = label;
    g.appendChild(t);
    svg.appendChild(g);
  };
  door(width-120, 60, "A");
  door(width-120, height/2-16, "B");
  door(width-120, height-110, "C");

  const dump = svgEl("text",{x:width-120, y:height-70, class:"tiny"});
  dump.textContent = "Dumpster";
  svg.appendChild(dump);

  let curY = pad + 12;
  for(const r of rows){
    const aisle = r.aisle;

    const titleBand = svgEl("rect",{
      x: pad, y: curY, width: width - pad*2 - 130, height: 28,
      rx: 12, fill:"rgba(255,255,255,.05)", stroke:"rgba(255,255,255,.10)"
    });
    svg.appendChild(titleBand);

    const t = svgEl("text",{x: pad+12, y: curY+19, class:"labelText"});
    t.textContent = aisle;
    svg.appendChild(t);

    const n = svgEl("text",{x: width - pad - 150, y: curY+19, class:"tiny"});
    n.textContent = r.note || "";
    svg.appendChild(n);

    curY += 32;

    const rowW = labelW + (RAIL_MAX * cellW) + 12;
    svg.appendChild(svgEl("rect",{
      x: pad, y: curY, width: rowW, height: r.height,
      rx: 14, fill:"rgba(0,0,0,.18)", stroke:"rgba(255,255,255,.10)"
    }));

    svg.appendChild(svgEl("rect",{
      x: pad+8, y: curY+8, width: labelW-10, height: r.height-16,
      rx: 12, fill: aisleColor(aisle), stroke:"rgba(255,255,255,.12)"
    }));
    const lt = svgEl("text",{x: pad+18, y: curY+26, class:"labelText"});
    lt.textContent = `${aisle}`;
    svg.appendChild(lt);
    const subt = svgEl("text",{x: pad+18, y: curY+44, class:"tiny"});
    subt.textContent = `click rails →`;
    svg.appendChild(subt);

    const startX = pad + labelW;
    const startY = curY + 10;

    for(let rail=1; rail<=RAIL_MAX; rail++){
      const active = rail <= (r.rails || RAIL_MAX);
      const x = startX + (rail-1)*cellW;
      const yCell = startY;

      const rect = svgEl("rect",{
        x, y:yCell, width:cellW-4, height:cellH,
        rx: 6,
        fill: active ? "rgba(255,255,255,.08)" : "rgba(255,255,255,.03)",
        stroke: active ? "rgba(255,255,255,.14)" : "rgba(255,255,255,.06)",
        "stroke-width":"1.2",
        class:"railCell",
        "data-aisle": aisle,
        "data-rail": String(rail),
        "data-active": active ? "1" : "0"
      });

      rect.addEventListener("click", ()=> pickFromMap(aisle, rail));
      svg.appendChild(rect);

      const num = svgEl("text",{x:x+(cellW-4)/2, y:yCell+15, "text-anchor":"middle", class:"tiny"});
      num.textContent = rail;
      svg.appendChild(num);
    }

    curY += r.height + gapY;
  }

  ui.mapHost.innerHTML = "";
  ui.mapHost.appendChild(svg);
  syncMapToDropdown();
}

function pickFromMap(aisle, rail){
  lastMapSelection = { aisle, rail };
  ui.mapPick.textContent = `${aisle} • Rail ${rail}`;
  ui.aisleSel.value = aisle;
  ui.railSel.value = String(rail);
  pushHistory();
  syncMapToDropdown();
}

function syncMapToDropdown(){
  const aisle = safe(ui.aisleSel.value);
  const rail = parseInt(ui.railSel.value, 10) || 0;
  ui.mapPick.textContent = aisle && rail ? `${aisle} • Rail ${rail}` : "No selection";

  const svg = ui.mapHost.querySelector("svg");
  if(!svg) return;

  svg.querySelectorAll(".railCell").forEach(r=>{
    const active = r.getAttribute("data-active")==="1";
    r.setAttribute("fill", active ? "rgba(255,255,255,.08)" : "rgba(255,255,255,.03)");
    r.setAttribute("stroke", active ? "rgba(255,255,255,.14)" : "rgba(255,255,255,.06)");
  });

  if(!aisle || !rail) return;

  const match = svg.querySelector(`.railCell[data-aisle="${CSS.escape(aisle)}"][data-rail="${rail}"]`);
  if(match){
    match.setAttribute("fill","rgba(246,213,122,.28)");
    match.setAttribute("stroke","rgba(246,213,122,.70)");
  }
}

async function createMissingAisles(){
  const missing = AISLE_ORDER.filter(a => !existingAisles.has(a));
  if(!missing.length){
    msg(ui.aisleWarn, "Nothing to create — all aisles exist ✅", true);
    return;
  }
  ui.addAislesBtn.disabled = true;
  ui.addAislesBtn.textContent = "Creating...";
  try{
    const rows = missing.map(name => ({ name }));
    const { error } = await sb.from("aisles").insert(rows);
    if(error) throw error;
    await loadAisles();
    msg(ui.aisleWarn, "Created missing aisles ✅", true);
  }catch(e){
    msg(ui.aisleWarn, e.message || "Failed to create aisles.");
  }finally{
    ui.addAislesBtn.disabled = false;
    ui.addAislesBtn.textContent = "Create missing aisles in Supabase";
  }
}

/** ================================
 *  Init
 * ================================ */
async function initApp(){
  fillNumericSelect(ui.railSel, RAIL_MAX);
  fillNumericSelect(ui.levelSel, LEVEL_MAX);

  await loadAisles();
  buildMap();

  ["change"].forEach(evt=>{
    ui.aisleSel.addEventListener(evt, ()=>{ pushHistory(); syncMapToDropdown(); });
    ui.railSel.addEventListener(evt, ()=>{ pushHistory(); syncMapToDropdown(); });
    ui.levelSel.addEventListener(evt, pushHistory);
    ui.statusSel.addEventListener(evt, pushHistory);
  });

  const k = "locateme_last_purge";
  const last = parseInt(localStorage.getItem(k) || "0", 10);
  const now = Date.now();
  if(!last || (now - last) > 24*60*60*1000){
    try{
      await sb.rpc("purge_outbound_older_than", { days: 5 });
      localStorage.setItem(k, String(now));
    }catch(_){}
  }
}

/** ================================
 *  Boot (always locked)
 * ================================ */
(function boot(){
  ui.overlay.style.display = "flex";
  ui.logoutBtn.style.display = "none";
  setConn("locked");
})();

/** ================================
 *  Events
 * ================================ */
ui.pinBtn.addEventListener("click", ()=> unlockWithPin(ui.pin.value));
ui.pinClear.addEventListener("click", ()=> { ui.pin.value=""; ui.pinMsg.textContent=""; });
ui.pin.addEventListener("keydown", (e)=>{ if(e.key==="Enter") unlockWithPin(ui.pin.value); });

ui.logoutBtn.addEventListener("click", lockApp);

ui.saveBtn.addEventListener("click", saveTag);
ui.backBtn.addEventListener("click", popHistory);
ui.purgeBtn.addEventListener("click", purgeOutbound);

ui.searchBtn.addEventListener("click", ()=> renderTagResults(ui.searchInput.value));
ui.searchInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") renderTagResults(ui.searchInput.value); });
ui.recentBtn.addEventListener("click", renderRecent);

ui.addAislesBtn.addEventListener("click", createMissingAisles);
ui.centerSelectBtn.addEventListener("click", syncMapToDropdown);
</script>
</body>
</html>
