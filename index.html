<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LocateMe Ops ‚Äî Warehouse + Fleet + Logistics</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#060709; --panel:rgba(255,255,255,.06); --stroke:rgba(255,255,255,.12);
      --text:#eaecef; --muted:rgba(234,236,239,.72);
      --gold1:#f6d57a; --gold2:#caa24d; --shadow:0 12px 40px rgba(0,0,0,.45);
      --radius:18px; --ok:#38d27a; --bad:#ff5964; --warn:#ffcc66; --info:#7fb6ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(246,213,122,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 20%, rgba(202,162,77,.14), transparent 55%),
                  linear-gradient(180deg, #050507, #07080b 60%, #060709);
      overflow-x:hidden;
    }
    .wrap{max-width:1280px;margin:28px auto;padding:0 16px 70px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; border:1px solid var(--stroke); border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:var(--shadow);
      position:sticky; top:12px; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:10px}
    .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(180deg,var(--gold1),var(--gold2))}
    .title{font-weight:900; letter-spacing:.3px}
    .sub{color:var(--muted); font-size:12px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      appearance:none; border:1px solid var(--stroke); color:var(--text);
      background:rgba(255,255,255,.06); padding:10px 12px; border-radius:14px; cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px; border:1px solid var(--stroke);
      background:rgba(0,0,0,.25); font-size:12px; color:var(--muted); white-space:nowrap;
    }
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)} .info{color:var(--info)} .gold{color:var(--gold1)}
    .small{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}

    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;}
    .tab{
      border:1px solid var(--stroke); background:rgba(0,0,0,.22);
      padding:10px 12px; border-radius:14px; cursor:pointer; font-weight:800;
      color:rgba(234,236,239,.85);
    }
    .tab.active{
      background:linear-gradient(180deg, rgba(246,213,122,.16), rgba(0,0,0,.22));
      border-color:rgba(246,213,122,.35); color:var(--text);
    }

    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:14px; margin-top:14px}
    @media (max-width: 980px){ .grid3{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--stroke); border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow:var(--shadow); padding:14px;
    }
    .h{font-weight:900; margin:0 0 8px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:14px;
      border:1px solid var(--stroke); outline:none;
      background:rgba(0,0,0,.25); color:var(--text);
    }
    textarea{min-height:90px; resize:vertical}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}

    .list{display:flex; flex-direction:column; gap:10px; margin-top:10px}
    .item{
      border:1px solid var(--stroke); border-radius:16px; padding:12px;
      background:rgba(0,0,0,.22);
    }
    .itemTop{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .tag{font-weight:900; letter-spacing:.2px}
    .meta{color:var(--muted); font-size:12px}

    .kpi{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:10px;}
    @media (max-width: 980px){ .kpi{grid-template-columns:1fr 1fr} }
    .kcard{border:1px solid var(--stroke); border-radius:16px; padding:12px; background:rgba(0,0,0,.22);}
    .knum{font-weight:900; font-size:18px}
    .klabel{font-size:12px;color:var(--muted)}

    .photos{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .photo{width:170px; border-radius:14px; border:1px solid var(--stroke); overflow:hidden; background:rgba(255,255,255,.05);}
    .photo img{width:100%; height:120px; object-fit:cover; display:block}
    .photo .cap{padding:8px 10px; font-size:12px; color:var(--muted)}

    .overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.72); backdrop-filter: blur(8px); z-index:50;
    }
    .pinbox{
      width:min(560px, 92vw);
      border:1px solid rgba(255,255,255,.18);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow:0 30px 90px rgba(0,0,0,.65);
      padding:18px;
    }
    .pinhead{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .pinhead .big{font-weight:900; font-size:18px}

    .modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.72); backdrop-filter: blur(8px); z-index:60;
    }
    .modalbox{
      width:min(720px, 96vw);
      border:1px solid rgba(255,255,255,.18);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow:0 30px 90px rgba(0,0,0,.65);
      padding:14px;
    }
    video{width:100%; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.35)}

    .mapWrap{border:1px solid var(--stroke); border-radius:16px; background:rgba(0,0,0,.18); overflow:hidden;}
    .mapHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04);
    }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border:1px solid rgba(255,255,255,.12);
      border-radius:999px; font-size:12px; color:var(--muted);
      background:rgba(0,0,0,.18);
    }

    .damageGrid{display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; margin-top:10px;}
    @media (max-width: 980px){ .damageGrid{grid-template-columns: 1fr 1fr;} }
    .dBtn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:850;
      color:rgba(234,236,239,.9);
      text-align:center;
      user-select:none;
    }
    .dBtn.sel{
      background:linear-gradient(180deg, rgba(246,213,122,.16), rgba(0,0,0,.20));
      border-color:rgba(246,213,122,.45);
      color:var(--text);
    }

    .split2{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width: 980px){ .split2{grid-template-columns:1fr} }
  </style>
</head>

<body>
  <!-- PIN Gate -->
  <div id="pinOverlay" class="overlay">
    <div class="pinbox">
      <div class="pinhead">
        <div class="big">Enter PIN</div>
        <span class="pill">LocateMe Ops</span>
      </div>
      <div class="small" style="margin-top:8px;">Access required to view or edit anything.</div>

      <label>PIN</label>
      <input id="pinInput" inputmode="numeric" placeholder="Enter PIN" />

      <div class="actions">
        <button class="btn" id="pinBtn">Unlock</button>
        <button class="btn" id="pinClear">Clear</button>
      </div>

      <div id="pinMsg" class="small" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- Camera Modal -->
  <div id="camModal" class="modal">
    <div class="modalbox">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="title" style="font-weight:900;">Scan Tag</div>
          <div class="small">Point the camera at barcode/QR. If unsupported, type tag manually.</div>
        </div>
        <button class="btn" id="camClose">Close</button>
      </div>
      <div class="divider"></div>
      <video id="camVideo" playsinline></video>
      <div class="actions">
        <button class="btn" id="camStart">Start Camera</button>
        <button class="btn" id="camStop">Stop</button>
        <span id="camMsg" class="pill"><span class="gold">‚óè</span> Idle</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <div>
          <div class="title">LocateMe Ops</div>
          <div class="sub">Warehouse + Fleet + Logistics ‚Ä¢ photo proof ‚Ä¢ audit trails</div>
        </div>
      </div>
      <div class="row">
        <span id="connPill" class="pill"><span class="gold">‚óè</span> Locked</span>
        <span id="rolePill" class="pill"><span class="info">‚óè</span> Role: Locked</span>
        <button class="btn" id="lockBtn" style="display:none;">Lock</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="warehouse">Warehouse</div>
      <div class="tab" data-tab="fleet">Fleet</div>
      <div class="tab" data-tab="logistics">Logistics</div>
      <div class="tab" data-tab="billing">Billing</div>
      <div class="tab" data-tab="dashboard">Ops Dashboard</div>
    </div>

    <!-- WAREHOUSE -->
    <div id="tab-warehouse" class="tabpane">
      <div class="grid">
        <div class="card">
          <h3 class="h">Warehouse: Save / Update a Tag</h3>
          <div class="small">Pick aisle ‚Üí rail ‚Üí level, optional photo, then save.</div>

          <div class="divider"></div>

          <label>Tag ID</label>
          <div class="row">
            <div style="flex:1; min-width:240px;">
              <input id="tagId" placeholder="Type or paste the tag" />
            </div>
            <div style="flex:.5; min-width:160px;">
              <button class="btn" id="scanBtn">üì± Scan</button>
            </div>
          </div>

          <div class="row">
            <div style="flex:1; min-width:220px;">
              <label>Aisle</label>
              <select id="aisleSel"></select>
            </div>
            <div style="flex:.7; min-width:160px;">
              <label>Rail</label>
              <select id="railSel"></select>
            </div>
            <div style="flex:.7; min-width:160px;">
              <label>Level</label>
              <select id="levelSel"></select>
            </div>
          </div>

          <label>Status</label>
          <select id="statusSel">
            <option value="INBOUND">INBOUND</option>
            <option value="OUTBOUND">OUTBOUND</option>
          </select>

          <label>Notes (optional)</label>
          <textarea id="notes" placeholder="Anything helpful‚Ä¶"></textarea>

          <label>Photo (optional)</label>
          <input id="photoFile" type="file" accept="image/*" />

          <div class="actions">
            <button class="btn" id="saveBtn">Save</button>
            <button class="btn" id="backBtn">Back (Undo last)</button>
            <button class="btn" id="purgeBtn">Purge OUTBOUND &gt; 5 days</button>
          </div>

          <div id="saveMsg" class="small" style="margin-top:10px;"></div>
        </div>

        <div class="card">
          <h3 class="h">Warehouse Map (simple)</h3>
          <div class="small">Pick aisle + rail fast.</div>

          <div class="actions" style="margin-top:10px;">
            <button class="btn" id="addAislesBtn">Create missing aisles</button>
            <button class="btn" id="centerSelectBtn">Sync highlight</button>
          </div>

          <div id="aisleWarn" class="small" style="margin-top:10px;"></div>

          <div class="divider"></div>

          <div class="mapWrap">
            <div class="mapHead">
              <div class="row" style="gap:8px">
                <span class="chip">Rails 1‚Äì21</span>
                <span class="chip">Levels 1‚Äì5</span>
              </div>
              <span class="pill" id="mapPick">No selection</span>
            </div>
            <div id="mapHost"></div>
          </div>

          <div class="divider"></div>

          <h3 class="h" style="margin-top:0;">Search by Tag</h3>
          <div class="small">Type a tag ‚Üí pulls last locations + photos (if your tables exist).</div>

          <label>Search</label>
          <input id="searchInput" placeholder="Tag ID‚Ä¶" />

          <div class="actions">
            <button class="btn" id="searchBtn">Search</button>
            <button class="btn" id="recentBtn">Recently Updated</button>
          </div>

          <div id="results" class="list"></div>
        </div>
      </div>
    </div>

    <!-- FLEET -->
    <div id="tab-fleet" class="tabpane" style="display:none;">
      <div class="grid3">
        <div class="card">
          <h3 class="h">Driver Profile</h3>
          <div class="small">Save once, then reuse from dropdown.</div>

          <label>My Saved Profiles (this device)</label>
          <select id="myProfiles"></select>

          <div class="divider"></div>

          <label>Driver Name</label>
          <input id="drvName" placeholder="Full name" />

          <label>Middle Name (optional)</label>
          <input id="drvMid" placeholder="Optional" />

          <div class="row">
            <div style="flex:1; min-width:200px;">
              <label>Date of Birth</label>
              <input id="drvDob" type="date" />
            </div>
            <div style="flex:1; min-width:240px;">
              <label>License #</label>
              <input id="drvLic" placeholder="Driver license number" />
            </div>
          </div>

          <label>License Status</label>
          <select id="licStatus">
            <option value="ACTIVE">Active</option>
            <option value="SUSPENDED">Suspended</option>
            <option value="PERMIT">Permit</option>
            <option value="NO_LICENSE">No license</option>
          </select>

          <div class="actions">
            <button class="btn" id="drvSaveBtn">Save Driver Profile</button>
          </div>

          <div id="drvMsg" class="small" style="margin-top:10px;"></div>

          <div class="divider"></div>

          <h3 class="h" style="margin-top:0;">Mode</h3>
          <div class="small">Driver role forces Driver mode. Manager/Admin can switch view mode.</div>
          <label>Mode</label>
          <select id="modeSel">
            <option value="MANAGER">Manager</option>
            <option value="DRIVER">Driver</option>
          </select>
          <div class="actions">
            <button class="btn" id="modeApplyBtn">Apply Mode</button>
          </div>
          <div id="modeMsg" class="small" style="margin-top:10px;"></div>
        </div>

        <div class="card">
          <h3 class="h">Driver Trip Log</h3>
          <div class="small">Mileage out/in + cab photos before/after + notes + checkbox.</div>

          <label>Select Vehicle</label>
          <select id="vehSel"></select>

          <label>Job (optional)</label>
          <select id="jobSel"></select>

          <div class="row">
            <div style="flex:1; min-width:220px;">
              <label>Mileage Before</label>
              <input id="mileOut" type="number" inputmode="numeric" placeholder="e.g. 124883" />
            </div>
            <div style="flex:1; min-width:220px;">
              <label>Mileage After</label>
              <input id="mileIn" type="number" inputmode="numeric" placeholder="e.g. 125011" />
            </div>
          </div>

          <label>Inside Cab Photo BEFORE</label>
          <input id="cabBefore" type="file" accept="image/*" />

          <label>Inside Cab Photo AFTER</label>
          <input id="cabAfter" type="file" accept="image/*" />

          <div class="divider"></div>

          <h3 class="h" style="margin-top:0;">Damage Update (optional)</h3>
          <label>Damage Type</label>
          <select id="dmgType">
            <option value="">No new damage</option>
            <option value="SCRATCH">Scratch</option>
            <option value="DENT">Dent</option>
            <option value="BROKEN">Broken</option>
            <option value="OTHER">Other</option>
          </select>

          <label>Click where the damage is</label>
          <div class="damageGrid" id="dmgGrid">
            <div class="dBtn" data-area="FRONT">Front</div>
            <div class="dBtn" data-area="BACK">Back</div>
            <div class="dBtn" data-area="DRIVER_SIDE">Driver side</div>
            <div class="dBtn" data-area="PASSENGER_SIDE">Passenger side</div>
            <div class="dBtn" data-area="MIRRORS">Mirrors</div>
          </div>
          <div class="small" id="dmgAreasText" style="margin-top:8px;">Selected: none</div>

          <label>Damage Notes (optional)</label>
          <textarea id="dmgNotes" placeholder="What happened / where exactly‚Ä¶"></textarea>

          <label>Damage Photos (optional)</label>
          <input id="dmgPhotos" type="file" accept="image/*" multiple />

          <div class="divider"></div>

          <label>Trip Notes</label>
          <textarea id="tripNotes" placeholder="Route, stops, issues‚Ä¶"></textarea>

          <div class="row" style="align-items:flex-start;">
            <input id="ackBox" type="checkbox" style="width:auto; margin-top:14px;" />
            <div class="small" style="margin-top:12px;">
              <b>Accountability:</b> If damages are not stated BEFORE the ride, driver may be held accountable.
            </div>
          </div>

          <div class="actions">
            <button class="btn" id="tripSaveBtn">Submit Trip</button>
          </div>

          <div id="tripMsg" class="small" style="margin-top:10px;"></div>
        </div>

        <div class="card">
          <h3 class="h">Fleet Tools</h3>
          <div class="small">Vehicles + quick tickets + exports.</div>

          <div class="actions">
            <button class="btn" id="vehRefreshBtn">Refresh Vehicles</button>
            <button class="btn" id="mtAddBtn">Create Repair Ticket</button>
          </div>

          <div class="divider"></div>

          <div class="small">Quick Add Vehicle (Manager/Admin only)</div>
          <div class="row">
            <div style="flex:1; min-width:220px;">
              <label>Unit # / Name</label>
              <input id="vehUnit" placeholder="e.g. Truck-3" />
            </div>
            <div style="flex:1; min-width:220px;">
              <label>Plate</label>
              <input id="vehPlate" placeholder="Plate (optional)" />
            </div>
          </div>
          <div class="row">
            <div style="flex:1; min-width:220px;">
              <label>Make/Model</label>
              <input id="vehModel" placeholder="e.g. Ford Transit 250" />
            </div>
            <div style="flex:1; min-width:220px;">
              <label>Current Mileage</label>
              <input id="vehMiles" type="number" inputmode="numeric" placeholder="e.g. 125000" />
            </div>
          </div>
          <div class="actions">
            <button class="btn" id="vehCreateBtn">Save Vehicle</button>
          </div>
          <div id="vehMsg" class="small" style="margin-top:10px;"></div>

          <div class="divider"></div>

          <h3 class="h" style="margin-top:0;">Exports (Manager/Admin)</h3>
          <div class="actions">
            <button class="btn" id="expTripsCsvBtn">Trips ‚Üí CSV</button>
            <button class="btn" id="expTripsPdfBtn">Trips ‚Üí PDF</button>
            <button class="btn" id="expDmgCsvBtn">Damages ‚Üí CSV</button>
            <button class="btn" id="expWhCsvBtn">Warehouse ‚Üí CSV</button>
          </div>
          <div id="expMsg" class="small" style="margin-top:10px;"></div>

          <div class="divider"></div>

          <h3 class="h" style="margin-top:0;">Recent Trips</h3>
          <div id="tripList" class="list"></div>
        </div>

        <!-- Reporting + Jobs -->
        <div class="card" style="grid-column: 1 / -1;" id="fleetReportsCard">
          <h3 class="h">Fleet Reporting + Job Tracking</h3>
          <div class="small">Manager/Admin sees all drivers. Driver view only sees own trips.</div>

          <div class="divider"></div>

          <div class="split2">
            <div class="card" style="margin:0;" id="jobsCard">
              <h3 class="h" style="margin-top:0;">Jobs</h3>

              <input id="jobIdHidden" type="hidden" />

              <div class="row">
                <div style="flex:1; min-width:220px;">
                  <label>Job Name</label>
                  <input id="jobName" placeholder="e.g. Uptown Install" />
                </div>
                <div style="flex:1; min-width:220px;">
                  <label>Job Code (optional)</label>
                  <input id="jobCode" placeholder="e.g. JOB-1027" />
                </div>
              </div>

              <div class="row">
                <div style="flex:1; min-width:220px;">
                  <label>Status</label>
                  <select id="jobStatus">
                    <option value="OPEN">OPEN</option>
                    <option value="PAUSED">PAUSED</option>
                    <option value="CLOSED">CLOSED</option>
                  </select>
                </div>
              </div>

              <label>Notes (optional)</label>
              <textarea id="jobNotes" placeholder="Access notes, contact, scope‚Ä¶"></textarea>

              <div class="actions">
                <button class="btn" id="jobSaveBtn">Save Job</button>
                <button class="btn" id="jobRefreshBtn">Refresh Jobs</button>
              </div>
              <div id="jobMsg" class="small" style="margin-top:10px;"></div>

              <div class="divider"></div>

              <h3 class="h" style="margin-top:0;">Mileage per Job (quick)</h3>
              <div class="row">
                <div style="flex:1; min-width:220px;">
                  <label>From</label>
                  <input id="jobFrom" type="date" />
                </div>
                <div style="flex:1; min-width:220px;">
                  <label>To</label>
                  <input id="jobTo" type="date" />
                </div>
              </div>
              <div class="actions">
                <button class="btn" id="jobReportBtn">Run Job Report</button>
                <button class="btn" id="jobReportCsvBtn">Job Report ‚Üí CSV</button>
              </div>
              <div id="jobReportMsg" class="small" style="margin-top:10px;"></div>
              <div id="jobReportOut" class="list"></div>
            </div>

            <div class="card" style="margin:0;">
              <h3 class="h" style="margin-top:0;">Driver Reporting</h3>

              <div class="row">
                <div style="flex:1; min-width:220px;">
                  <label>From</label>
                  <input id="drvFrom" type="date" />
                </div>
                <div style="flex:1; min-width:220px;">
                  <label>To</label>
                  <input id="drvTo" type="date" />
                </div>
                <div style="flex:1; min-width:260px;">
                  <label>Driver</label>
                  <select id="drvReportSel"></select>
                </div>
              </div>

              <div class="actions">
                <button class="btn" id="drvReportBtn">Run Driver Report</button>
                <button class="btn" id="drvReportCsvBtn">Driver Report ‚Üí CSV</button>
              </div>

              <div id="drvReportMsg" class="small" style="margin-top:10px;"></div>
              <div id="drvReportTotals" class="row" style="margin-top:10px; gap:8px;"></div>

              <div class="divider"></div>

              <h3 class="h" style="margin-top:0;">Drivers by License Status</h3>
              <div id="driversGrouped" class="list"></div>

              <div class="divider"></div>

              <h3 class="h" style="margin-top:0;">Report Output</h3>
              <div id="drvReportOut" class="list"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- LOGISTICS -->
    <div id="tab-logistics" class="tabpane" style="display:none;">
      <div class="grid">
        <div class="card">
          <h3 class="h">Create / Update Shipment</h3>
          <div class="small">Track pickups, deliveries, PO/BOL, carrier, proof photo.</div>

          <label>Shipment ID</label>
          <input id="shId" placeholder="e.g. CLT-2026-001" />

          <div class="row">
            <div style="flex:1; min-width:220px;">
              <label>Status</label>
              <select id="shStatus">
                <option value="PLANNED">PLANNED</option>
                <option value="PICKUP_SCHEDULED">PICKUP_SCHEDULED</option>
                <option value="IN_TRANSIT">IN_TRANSIT</option>
                <option value="DELIVERED">DELIVERED</option>
                <option value="EXCEPTION">EXCEPTION</option>
                <option value="CANCELLED">CANCELLED</option>
              </select>
            </div>
            <div style="flex:1; min-width:220px;">
              <label>Carrier / Driver</label>
              <input id="shCarrier" placeholder="Carrier or driver name" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1; min-width:220px;">
              <label>PO #</label>
              <input id="shPO" placeholder="PO (optional)" />
            </div>
            <div style="flex:1; min-width:220px;">
              <label>BOL #</label>
              <input id="shBOL" placeholder="BOL (optional)" />
            </div>
          </div>

          <label>Pickup Location</label>
          <input id="shPickup" placeholder="Pickup address / site" />

          <label>Delivery Location</label>
          <input id="shDrop" placeholder="Delivery address / site" />

          <label>Notes</label>
          <textarea id="shNotes" placeholder="Load details, access instructions‚Ä¶"></textarea>

          <label>Proof / Load Photo (optional)</label>
          <input id="shPhoto" type="file" accept="image/*" />

          <div class="actions">
            <button class="btn" id="shSaveBtn">Save Shipment</button>
            <button class="btn" id="shRefreshBtn">Refresh Shipments</button>
          </div>

          <div id="shMsg" class="small" style="margin-top:10px;"></div>
        </div>

        <div class="card">
          <h3 class="h">Shipment Board</h3>
          <div class="small">Search shipments fast and open details.</div>

          <label>Search</label>
          <input id="shSearch" placeholder="Shipment ID, PO, BOL, carrier‚Ä¶" />

          <div class="actions">
            <button class="btn" id="shSearchBtn">Search</button>
            <button class="btn" id="shTodayBtn">Recently Updated</button>
          </div>

          <div id="shList" class="list"></div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
     <!-- BILLING -->
<div id="tab-billing" class="tabpane" style="display:none;">
  <div class="grid">
    <!-- Log a movement -->
    <div class="card">
      <h3 class="h">Billing: Log Movement</h3>
      <div class="small">Manager logs approved. Admin logs pending until manager approves.</div>

      <label>Client Code</label>
      <input id="billClient" value="AEX" />

      <label>Movement Type</label>
      <select id="billType">
        <option value="PUTAWAY">PUTAWAY</option>
        <option value="PICK">PICK</option>
        <option value="MOVE">MOVE</option>
        <option value="LOAD">LOAD</option>
        <option value="UNLOAD">UNLOAD</option>
        <option value="OTHER">OTHER</option>
      </select>

      <div class="row">
        <div style="flex:1; min-width:200px;">
          <label>Qty</label>
          <input id="billQty" type="number" inputmode="numeric" placeholder="e.g. 12" />
        </div>
        <div style="flex:1; min-width:240px;">
          <label>Occurred At</label>
          <input id="billOccurred" type="datetime-local" />
        </div>
      </div>

      <div class="row">
        <div style="flex:1; min-width:220px;">
          <label>Item Tag (optional)</label>
          <input id="billItemTag" placeholder="optional" />
        </div>
        <div style="flex:1; min-width:220px;">
          <label>Pallet Tag (optional)</label>
          <input id="billPalletTag" placeholder="optional" />
        </div>
      </div>

      <div class="row">
        <div style="flex:1; min-width:220px;">
          <label>From Location (optional)</label>
          <input id="billFromLoc" placeholder="optional" />
        </div>
        <div style="flex:1; min-width:220px;">
          <label>To Location (optional)</label>
          <input id="billToLoc" placeholder="optional" />
        </div>
      </div>

      <label>Notes (optional)</label>
      <textarea id="billNotes" placeholder="optional‚Ä¶"></textarea>

      <div class="actions">
        <button class="btn" id="billLogBtn">Log Movement</button>
        <button class="btn" id="billClearBtn">Clear</button>
      </div>
      <div id="billMsg" class="small" style="margin-top:10px;"></div>
    </div>

    <!-- Daily lines + approvals -->
    <div class="card">
      <h3 class="h">Billing: Daily Invoice Lines</h3>
      <div class="small">Pulls from view v_aex_invoice_lines_daily (or your actual view name).</div>

      <div class="row" style="margin-top:10px;">
        <div style="flex:1; min-width:160px;">
          <label>Client</label>
          <input id="billLinesClient" value="AEX" />
        </div>
        <div style="flex:1; min-width:180px;">
          <label>From</label>
          <input id="billFrom" type="date" />
        </div>
        <div style="flex:1; min-width:180px;">
          <label>To</label>
          <input id="billTo" type="date" />
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="billLinesRunBtn">Run</button>
      </div>
      <div id="billLinesMsg" class="small" style="margin-top:10px;"></div>
      <div id="billLinesOut" class="list"></div>

      <div class="divider"></div>

      <h3 class="h" style="margin-top:0;">Approvals Queue</h3>
      <div class="small">Shows PENDING events. Manager approves/rejects.</div>

      <div class="actions" style="margin-top:10px;">
        <button class="btn" id="billPendingBtn">Refresh Pending</button>
      </div>
      <div id="billPendingMsg" class="small" style="margin-top:10px;"></div>
      <div id="billPendingOut" class="list"></div>
    </div>
  </div>
</div>

    <div id="tab-dashboard" class="tabpane" style="display:none;">
      <div class="card">
        <h3 class="h">Ops Dashboard</h3>
        <div class="small">Quick counts + latest activity.</div>

        <div class="kpi">
          <div class="kcard"><div class="knum" id="kWarehouse">‚Äî</div><div class="klabel">Warehouse tags</div></div>
          <div class="kcard"><div class="knum" id="kMoved">‚Äî</div><div class="klabel">Moved last 24h</div></div>
          <div class="kcard"><div class="knum" id="kFleet">‚Äî</div><div class="klabel">Fleet vehicles</div></div>
          <div class="kcard"><div class="knum" id="kShip">‚Äî</div><div class="klabel">Open shipments</div></div>
        </div>

        <div class="divider"></div>

        <div class="grid">
          <div class="card" style="margin:0;">
            <h3 class="h">Latest Warehouse Movements</h3>
            <div id="dashMoves" class="list"></div>
          </div>
          <div class="card" style="margin:0;">
            <h3 class="h">Fleet: Latest Trips</h3>
            <div id="dashTrips" class="list"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid">
          <div class="card" style="margin:0;">
            <h3 class="h">Logistics: Exceptions</h3>
            <div id="dashExceptions" class="list"></div>
          </div>
          <div class="card" style="margin:0;">
  <h3 class="h">Billing: Daily Invoice Lines</h3>
  <div class="small">Shows approved invoice lines (view). Use real date range.</div>

  <div class="row" style="margin-top:10px;">
    <div style="flex:1; min-width:160px;">
      <label>Client</label>
      <select id="mbeClient">
        <option value="AEX">AEX</option>
      </select>
    </div>
    <div style="flex:1; min-width:180px;">
      <label>From</label>
      <input id="mbeFrom" type="date" />
    </div>
    <div style="flex:1; min-width:180px;">
      <label>To</label>
      <input id="mbeTo" type="date" />
    </div>
  </div>

  <div class="actions">
    <button class="btn" id="mbeDailyRunBtn">Run</button>
  </div>
  <div id="mbeDailyMsg" class="small" style="margin-top:10px;"></div>
  <div id="mbeDailyOut" class="list"></div>

  <div class="divider"></div>

  <h3 class="h" style="margin-top:0;">Approvals Queue</h3>
  <div class="small">Admin PIN entries show as PENDING until Manager approves.</div>

  <div class="actions" style="margin-top:10px;">
    <button class="btn" id="mbePendingBtn">Refresh Pending</button>
  </div>
  <div id="mbePendingMsg" class="small" style="margin-top:10px;"></div>
  <div id="mbePendingOut" class="list"></div>
</div>
          <div class="card" style="margin:0;">
            <h3 class="h">Manager Notes</h3>
            <textarea id="mgrNotes" placeholder="Today: ‚Ä¶"></textarea>
            <div class="actions">
              <button class="btn" id="notesSaveBtn">Save Notes</button>
              <button class="btn" id="notesLoadBtn">Load Notes</button>
            </div>
            <div id="notesMsg" class="small" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/** ================================
 *  CONFIG
 * ================================ */
const SUPABASE_URL  = "https://ojdfaguhteddwaxyobnl.supabase.co";
const SUPABASE_ANON = "sb_publishable_S4Z3E2phukZklKtBuRPLjA_RB4Faij2";

// Storage buckets (must exist in Supabase Storage)
const BUCKET_WAREHOUSE = "warehouse-photos";
const BUCKET_FLEET     = "fleet-photos";
const BUCKET_LOGISTICS = "logistics-photos";

const RAIL_MAX = 21;
const LEVEL_MAX = 5;

// Role PINs
const PIN_MANAGER   = "9262"; // full access + edits
const PIN_ADMIN     = "2026"; // sees all; ANY edit requires manager confirmation
const PIN_WAREHOUSE = "0001"; // warehouse only (can edit warehouse)
const PIN_DRIVER    = "2000"; // fleet only (driver mode)

// Aisles for map + ordering
const AISLE_ORDER = ["AEX","Maserati","Mercedes","Bentley","Pagani","Aston Martin","McLaren","Ferrari","Lamborghini","Bugatti"];

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/** ================================
 *  UI refs
 * ================================ */
const ui = {
  overlay:   document.getElementById("pinOverlay"),
  pin:       document.getElementById("pinInput"),
  pinBtn:    document.getElementById("pinBtn"),
  pinClear:  document.getElementById("pinClear"),
  pinMsg:    document.getElementById("pinMsg"),
  connPill:  document.getElementById("connPill"),
  rolePill:  document.getElementById("rolePill"),
  lockBtn:   document.getElementById("lockBtn"),

  tabs: Array.from(document.querySelectorAll(".tab")),
  panes: {
    warehouse: document.getElementById("tab-warehouse"),
    fleet:     document.getElementById("tab-fleet"),
    logistics: document.getElementById("tab-logistics"),
    billing:   document.getElementById("tab-billing"),
    dashboard: document.getElementById("tab-dashboard"),
  },

  // camera
  camModal: document.getElementById("camModal"),
  camVideo: document.getElementById("camVideo"),
  camStart: document.getElementById("camStart"),
  camStop:  document.getElementById("camStop"),
  camClose: document.getElementById("camClose"),
  camMsg:   document.getElementById("camMsg"),
  scanBtn:  document.getElementById("scanBtn"),

  // warehouse
  tagId: document.getElementById("tagId"),
  aisleSel: document.getElementById("aisleSel"),
  railSel: document.getElementById("railSel"),
  levelSel: document.getElementById("levelSel"),
  statusSel: document.getElementById("statusSel"),
  notes: document.getElementById("notes"),
  photoFile: document.getElementById("photoFile"),
  saveBtn: document.getElementById("saveBtn"),
  backBtn: document.getElementById("backBtn"),
  purgeBtn: document.getElementById("purgeBtn"),
  saveMsg: document.getElementById("saveMsg"),
  searchInput: document.getElementById("searchInput"),
  searchBtn: document.getElementById("searchBtn"),
  recentBtn: document.getElementById("recentBtn"),
  results: document.getElementById("results"),
  mapHost: document.getElementById("mapHost"),
  mapPick: document.getElementById("mapPick"),
  aisleWarn: document.getElementById("aisleWarn"),
  addAislesBtn: document.getElementById("addAislesBtn"),
  centerSelectBtn: document.getElementById("centerSelectBtn"),

  // fleet
  myProfiles: document.getElementById("myProfiles"),
  drvName: document.getElementById("drvName"),
  drvMid: document.getElementById("drvMid"),
  drvDob: document.getElementById("drvDob"),
  drvLic: document.getElementById("drvLic"),
  licStatus: document.getElementById("licStatus"),
  drvSaveBtn: document.getElementById("drvSaveBtn"),
  drvMsg: document.getElementById("drvMsg"),
  modeSel: document.getElementById("modeSel"),
  modeApplyBtn: document.getElementById("modeApplyBtn"),
  modeMsg: document.getElementById("modeMsg"),
  vehSel: document.getElementById("vehSel"),
  jobSel: document.getElementById("jobSel"),
  mileOut: document.getElementById("mileOut"),
  mileIn: document.getElementById("mileIn"),
  cabBefore: document.getElementById("cabBefore"),
  cabAfter: document.getElementById("cabAfter"),
  tripNotes: document.getElementById("tripNotes"),
  ackBox: document.getElementById("ackBox"),
  tripSaveBtn: document.getElementById("tripSaveBtn"),
  tripMsg: document.getElementById("tripMsg"),
  dmgType: document.getElementById("dmgType"),
  dmgNotes: document.getElementById("dmgNotes"),
  dmgPhotos: document.getElementById("dmgPhotos"),
  dmgAreasText: document.getElementById("dmgAreasText"),
  dmgBtns: Array.from(document.querySelectorAll(".dBtn")),
  vehRefreshBtn: document.getElementById("vehRefreshBtn"),
  mtAddBtn: document.getElementById("mtAddBtn"),
  vehUnit: document.getElementById("vehUnit"),
  vehPlate: document.getElementById("vehPlate"),
  vehModel: document.getElementById("vehModel"),
  vehMiles: document.getElementById("vehMiles"),
  vehCreateBtn: document.getElementById("vehCreateBtn"),
  vehMsg: document.getElementById("vehMsg"),
  tripList: document.getElementById("tripList"),
  expTripsCsvBtn: document.getElementById("expTripsCsvBtn"),
  expTripsPdfBtn: document.getElementById("expTripsPdfBtn"),
  expDmgCsvBtn: document.getElementById("expDmgCsvBtn"),
  expWhCsvBtn: document.getElementById("expWhCsvBtn"),
  expMsg: document.getElementById("expMsg"),

  // jobs + reports
  fleetReportsCard: document.getElementById("fleetReportsCard"),
  jobsCard: document.getElementById("jobsCard"),
  jobIdHidden: document.getElementById("jobIdHidden"),
  jobName: document.getElementById("jobName"),
  jobCode: document.getElementById("jobCode"),
  jobStatus: document.getElementById("jobStatus"),
  jobNotes: document.getElementById("jobNotes"),
  jobSaveBtn: document.getElementById("jobSaveBtn"),
  jobRefreshBtn: document.getElementById("jobRefreshBtn"),
  jobMsg: document.getElementById("jobMsg"),

  jobFrom: document.getElementById("jobFrom"),
  jobTo: document.getElementById("jobTo"),
  jobReportBtn: document.getElementById("jobReportBtn"),
  jobReportCsvBtn: document.getElementById("jobReportCsvBtn"),
  jobReportMsg: document.getElementById("jobReportMsg"),
  jobReportOut: document.getElementById("jobReportOut"),

  drvFrom: document.getElementById("drvFrom"),
  drvTo: document.getElementById("drvTo"),
  drvReportSel: document.getElementById("drvReportSel"),
  drvReportBtn: document.getElementById("drvReportBtn"),
  drvReportCsvBtn: document.getElementById("drvReportCsvBtn"),
  drvReportMsg: document.getElementById("drvReportMsg"),
  drvReportTotals: document.getElementById("drvReportTotals"),
  driversGrouped: document.getElementById("driversGrouped"),
  drvReportOut: document.getElementById("drvReportOut"),

  // logistics
  shId: document.getElementById("shId"),
  shStatus: document.getElementById("shStatus"),
  shCarrier: document.getElementById("shCarrier"),
  shPO: document.getElementById("shPO"),
  shBOL: document.getElementById("shBOL"),
  shPickup: document.getElementById("shPickup"),
  shDrop: document.getElementById("shDrop"),
  shNotes: document.getElementById("shNotes"),
  shPhoto: document.getElementById("shPhoto"),
  shSaveBtn: document.getElementById("shSaveBtn"),
  shRefreshBtn: document.getElementById("shRefreshBtn"),
  shMsg: document.getElementById("shMsg"),
  shSearch: document.getElementById("shSearch"),
  shSearchBtn: document.getElementById("shSearchBtn"),
  shTodayBtn: document.getElementById("shTodayBtn"),
  shList: document.getElementById("shList"),

  // dashboard
  kWarehouse: document.getElementById("kWarehouse"),
  kMoved: document.getElementById("kMoved"),
  kFleet: document.getElementById("kFleet"),
  kShip: document.getElementById("kShip"),
  dashMoves: document.getElementById("dashMoves"),
  dashTrips: document.getElementById("dashTrips"),
  dashExceptions: document.getElementById("dashExceptions"),
  mgrNotes: document.getElementById("mgrNotes"),
  notesSaveBtn: document.getElementById("notesSaveBtn"),
  notesLoadBtn: document.getElementById("notesLoadBtn"),
      notesMsg: document.getElementById("notesMsg"),

  // billing (new tab)
  billClient: document.getElementById("billClient"),
  billType: document.getElementById("billType"),
  billQty: document.getElementById("billQty"),
  billOccurred: document.getElementById("billOccurred"),
  billItemTag: document.getElementById("billItemTag"),
  billPalletTag: document.getElementById("billPalletTag"),
  billFromLoc: document.getElementById("billFromLoc"),
  billToLoc: document.getElementById("billToLoc"),
  billNotes: document.getElementById("billNotes"),
  billLogBtn: document.getElementById("billLogBtn"),
  billClearBtn: document.getElementById("billClearBtn"),
  billMsg: document.getElementById("billMsg"),

  billLinesClient: document.getElementById("billLinesClient"),
  billFrom: document.getElementById("billFrom"),
  billTo: document.getElementById("billTo"),
  billLinesRunBtn: document.getElementById("billLinesRunBtn"),
  billLinesMsg: document.getElementById("billLinesMsg"),
  billLinesOut: document.getElementById("billLinesOut"),

  billPendingBtn: document.getElementById("billPendingBtn"),
  billPendingMsg: document.getElementById("billPendingMsg"),
  billPendingOut: document.getElementById("billPendingOut"),
};



let role = "LOCKED";     // MANAGER | ADMIN | WAREHOUSE | DRIVER | LOCKED
let mode = "MANAGER";    // MANAGER | DRIVER (UI view mode)
let __activePin = "";    // stores the PIN used to unlock (for billing functions)
let selectionHistory = [];
let existingAisles = new Set();
let camStream = null;
let camDetector = null;
let damageAreas = new Set();

// caches
let __jobsCache = [];
let __driversCache = [];
let __reportTripsCache = [];

/** ================================
 *  Helpers
 * ================================ */
const safe = (s)=> (s||"").toString().trim();
const nowISO = ()=> new Date().toISOString();
const daysAgoISO = (days)=> new Date(Date.now() - days*24*60*60*1000).toISOString();

function ymdStart(dateStr){
  const v = safe(dateStr);
  if(!v) return null;
  const dt = new Date(v + "T00:00:00");
  return isNaN(dt.getTime()) ? null : dt.toISOString();
}
function ymdEnd(dateStr){
  const v = safe(dateStr);
  if(!v) return null;
  const dt = new Date(v + "T23:59:59.999");
  return isNaN(dt.getTime()) ? null : dt.toISOString();
}
/** ================================
 *  Billing Tab Logic
 * ================================ */

// IMPORTANT: set this once you confirm the function name in Supabase
let BILLING_ADD_FN = "mbe_add_event"; 
let BILLING_DAILY_VIEW = "v_aex_invoice_lines_daily"; 

function dtLocalToISO(v){
  v = safe(v);
  if(!v) return null;
  // datetime-local comes as "YYYY-MM-DDTHH:mm"
  const dt = new Date(v);
  return isNaN(dt.getTime()) ? null : dt.toISOString();
}

async function billingLogMovement(){
  if(!(role==="MANAGER" || role==="ADMIN")) return msg(ui.billMsg, "Manager/Admin only.");

  const p_pin = safe(__activePin);
  const p_client_code = safe(ui.billClient.value || "AEX").toUpperCase();
  const p_movement_type = safe(ui.billType.value).toUpperCase();
  const p_qty = parseInt(ui.billQty.value, 10) || 1;

  const p_occurred_at = dtLocalToISO(ui.billOccurred.value) || new Date().toISOString();

  if(!p_pin) return msg(ui.billMsg, "Missing active PIN. Lock and unlock again.");
  if(!p_client_code) return msg(ui.billMsg, "Client code required.");
  if(!p_movement_type) return msg(ui.billMsg, "Movement type required.");

  ui.billLogBtn.disabled = true;
  ui.billLogBtn.textContent = "Logging...";

  try{
    const { data, error } = await sb.rpc("mbe_add_event", {
      p_pin,
      p_client_code,
      p_movement_type,
      p_qty,
      p_occurred_at
      // IMPORTANT: only add more fields IF your function actually has them
    });
    if(error) throw error;

    const statusText = (role==="MANAGER") ? "APPROVED ‚úÖ" : "PENDING ‚è≥";
    msg(ui.billMsg, `Logged movement ‚Ä¢ ${statusText}`, true);

    await refreshBillingPending();
  }catch(e){
    msg(ui.billMsg, e.message || "Log failed.");
  }finally{
    ui.billLogBtn.disabled = false;
    ui.billLogBtn.textContent = "Log Movement";
  }
}


function billingClearForm(){
  ui.billQty.value = "";
  ui.billOccurred.value = "";
  ui.billItemTag.value = "";
  ui.billPalletTag.value = "";
  ui.billFromLoc.value = "";
  ui.billToLoc.value = "";
  ui.billNotes.value = "";
  ui.billMsg.textContent = "";
}

async function billingRunDailyLines(){
  try{
    ui.billLinesMsg.textContent = "Loading‚Ä¶";
    const client = safe(ui.billLinesClient.value || "AEX").toUpperCase();

    const fromISO = ui.billFrom.value ? (ui.billFrom.value + "T00:00:00.000Z") : null;
    const toISO   = ui.billTo.value ? (ui.billTo.value + "T23:59:59.999Z") : null;

    // NOTE: Your earlier error happened because you used 2026-02-29 (invalid).
    // The date inputs prevent that.

    let q = sb.from(BILLING_DAILY_VIEW).select("*").order("day",{ascending:false}).order("movement_type",{ascending:true});
    if(client) q = q.eq("client_code", client);
    if(fromISO) q = q.gte("day", fromISO);
    if(toISO) q = q.lte("day", toISO);

    const { data, error } = await q.limit(5000);
    if(error) throw error;

    const rows = data || [];
    ui.billLinesOut.innerHTML = rows.length ? rows.map(r=>`
      <div class="item">
        <div class="itemTop">
          <div>
            <div class="tag">${r.day ? new Date(r.day).toLocaleDateString() : "‚Äî"} ‚Ä¢ ${r.movement_type}</div>
            <div class="meta">Qty: <b>${r.moves}</b> ‚Ä¢ Amount: <b>$${Number(r.amount||0).toFixed(2)}</b></div>
          </div>
          <div class="meta">${r.client_code || ""}</div>
        </div>
      </div>
    `).join("") : `<div class="item"><div class="meta">No rows found for that range.</div></div>`;

    ui.billLinesMsg.textContent = "";
  }catch(e){
    ui.billLinesMsg.textContent = e.message || String(e);
  }
}

async function refreshBillingPending(){
  if(role!=="MANAGER" && role!=="ADMIN"){
    ui.billPendingOut.innerHTML = `<div class="item"><div class="meta">Manager/Admin only.</div></div>`;
    return;
  }
  try{
    ui.billPendingMsg.textContent = "Loading‚Ä¶";
    const client = safe(ui.billLinesClient.value || "AEX").toUpperCase();

    const { data, error } = await sb
      .from("movement_billing_events")
      .select("id, client_code, movement_type, qty, occurred_at, notes, submitted_by_pin, approval_status")
      .eq("approval_status","PENDING")
      .eq("client_code", client)
      .order("occurred_at",{ascending:false})
      .limit(300);

    if(error) throw error;

    const rows = data || [];
    ui.billPendingOut.innerHTML = rows.length ? rows.map(r=>`
      <div class="item">
        <div class="itemTop">
          <div>
            <div class="tag">#${r.id} ‚Ä¢ ${r.movement_type} ‚Ä¢ Qty ${r.qty}</div>
            <div class="meta">${r.client_code} ‚Ä¢ ${r.occurred_at ? new Date(r.occurred_at).toLocaleString() : "‚Äî"}</div>
            ${r.notes ? `<div class="meta" style="margin-top:6px;">${r.notes}</div>` : ""}
            <div class="meta" style="margin-top:6px;">Submitted by PIN: <b>${r.submitted_by_pin || "‚Äî"}</b></div>
          </div>
          <div class="actions">
            <button class="btn" onclick="window.__billingApprove(${r.id})">Approve</button>
            <button class="btn" onclick="window.__billingReject(${r.id})">Reject</button>
          </div>
        </div>
      </div>
    `).join("") : `<div class="item"><div class="meta">No pending approvals ‚úÖ</div></div>`;

    ui.billPendingMsg.textContent = "";
  }catch(e){
    ui.billPendingMsg.textContent = e.message || String(e);
  }
}

window.__billingApprove = async (id)=>{
  try{
    const mp = prompt("Manager PIN to approve:", "");
    if(!mp) return;
    if(safe(mp) !== PIN_MANAGER) return alert("Wrong manager PIN.");

    const { error } = await sb.rpc("mbe_approve_event", { p_manager_pin: String(mp), p_event_id: Number(id) });
    if(error) throw error;

    await refreshBillingPending();
    alert(`Approved #${id}`);
  }catch(e){
    alert(e.message || e);
  }
};

window.__billingReject = async (id)=>{
  try{
    const mp = prompt("Manager PIN to reject:", "");
    if(!mp) return;
    if(safe(mp) !== PIN_MANAGER) return alert("Wrong manager PIN.");

    const reason = prompt("Reason (optional):", "") || null;

    const { error } = await sb.rpc("mbe_reject_event", { p_manager_pin: String(mp), p_event_id: Number(id), p_reason: reason });
    if(error) throw error;

    await refreshBillingPending();
    alert(`Rejected #${id}`);
  }catch(e){
    alert(e.message || e);
  }
};

/** ================================
 *  Movement Billing (PIN-only approvals)
 *  - 9262 (MANAGER) logs/edits => APPROVED
 *  - 2026 (ADMIN) logs/edits => PENDING until manager approves
 * ================================ */

// Normalize helpers
function normStr(v){ return (v === undefined || v === null || String(v).trim()==="") ? null : String(v).trim(); }
function normInt(v){
  if(v === undefined || v === null || String(v).trim()==="") return null;
  const n = parseInt(v, 10);
  return Number.isFinite(n) ? n : null;
}

// Convert date inputs to safe ISO range
function toISOStart(dateStr){
  const v = safe(dateStr);
  if(!v) return null;
  const dt = new Date(v + "T00:00:00");
  return isNaN(dt.getTime()) ? null : dt.toISOString();
}
function toISOEnd(dateStr){
  const v = safe(dateStr);
  if(!v) return null;
  const dt = new Date(v + "T23:59:59.999");
  return isNaN(dt.getTime()) ? null : dt.toISOString();
}

// RPC: add event (your SQL should provide: mbe_add_event or add_movement_billing_event)
// If your function is named add_movement_billing_event, keep that.
// If it is mbe_add_event, switch it below.
async function mbeLogMove(payload){
  const fn = "mbe_add_event";

  const rpcPayload = {
    p_pin: activePin,
    ...payload
  };

  const { data, error } = await sb.rpc(fn, rpcPayload);
  if(error) throw error;
  return data;
}


// RPC: update event (your SQL function we created: mbe_update_event)
async function mbeUpdateMove(payload){
  const { data, error } = await sb.rpc("mbe_update_event", payload);
  if(error) throw error;
  return data;
}

// RPC: approve/reject (your SQL should provide these)
async function mbeApprove(manager_pin, event_id){
  const { data, error } = await sb.rpc("mbe_approve_event", { p_manager_pin: String(manager_pin), p_event_id: Number(event_id) });
  if(error) throw error;
  return data;
}
async function mbeReject(manager_pin, event_id, reason){
  const { data, error } = await sb.rpc("mbe_reject_event", { p_manager_pin: String(manager_pin), p_event_id: Number(event_id), p_reason: reason || null });
  if(error) throw error;
  return data;
}

// Fetch daily invoice lines (view)
async function mbeFetchDailyLines(clientCode, fromISO, toISO){
  let q = sb.from("v_aex_invoice_lines_daily").select("*").order("day",{ascending:false}).order("movement_type",{ascending:true});
  if(clientCode) q = q.eq("client_code", clientCode);
  if(fromISO) q = q.gte("day", fromISO);
  if(toISO) q = q.lte("day", toISO);
  const { data, error } = await q.limit(5000);
  if(error) throw error;
  return data || [];
}

// Fetch pending approvals
async function mbeFetchPending(clientCode){
  let q = sb.from("movement_billing_events")
    .select("id, client_code, movement_type, qty, occurred_at, notes, submitted_by_pin, approval_status")
    .eq("approval_status","PENDING")
    .order("occurred_at",{ascending:false});
  if(clientCode) q = q.eq("client_code", clientCode);
  const { data, error } = await q.limit(300);
  if(error) throw error;
  return data || [];
}

// Render helpers
function renderDailyLines(rows){
  ui.mbeDailyOut.innerHTML = rows.length ? rows.map(r=>`
    <div class="item">
      <div class="itemTop">
        <div>
          <div class="tag">${(r.day ? new Date(r.day).toLocaleDateString() : "‚Äî")} ‚Ä¢ ${r.movement_type}</div>
          <div class="meta">Qty: <b>${r.moves}</b> ‚Ä¢ Amount: <b>$${Number(r.amount||0).toFixed(2)}</b></div>
        </div>
        <div class="meta">${r.client_code || ""}</div>
      </div>
    </div>
  `).join("") : `<div class="item"><div class="meta">No rows found for that range.</div></div>`;
}

function renderPending(rows){
  ui.mbePendingOut.innerHTML = rows.length ? rows.map(r=>`
    <div class="item">
      <div class="itemTop">
        <div>
          <div class="tag">#${r.id} ‚Ä¢ ${r.movement_type} ‚Ä¢ Qty ${r.qty}</div>
          <div class="meta">${r.client_code} ‚Ä¢ ${r.occurred_at ? new Date(r.occurred_at).toLocaleString() : "‚Äî"}</div>
          ${r.notes ? `<div class="meta" style="margin-top:6px;">${r.notes}</div>` : ""}
          <div class="meta" style="margin-top:6px;">Submitted by PIN: <b>${r.submitted_by_pin || "‚Äî"}</b></div>
        </div>
        <div class="actions">
          <button class="btn" onclick="window.__mbeApprove(${r.id})">Approve</button>
          <button class="btn" onclick="window.__mbeReject(${r.id})">Reject</button>
        </div>
      </div>
    </div>
  `).join("") : `<div class="item"><div class="meta">No pending approvals ‚úÖ</div></div>`;
}

window.__mbeApprove = async (id)=>{
  try{
    const mp = prompt("Manager PIN to approve:", "");
    if(!mp) return;
    if(safe(mp) !== PIN_MANAGER) return alert("Wrong manager PIN.");
    await mbeApprove(mp, id);
    await refreshPendingApprovals();
    alert(`Approved #${id}`);
  }catch(e){
    alert(e.message || e);
  }
};

window.__mbeReject = async (id)=>{
  try{
    const mp = prompt("Manager PIN to reject:", "");
    if(!mp) return;
    if(safe(mp) !== PIN_MANAGER) return alert("Wrong manager PIN.");
    const reason = prompt("Reason (optional):", "") || null;
    await mbeReject(mp, id, reason);
    await refreshPendingApprovals();
    alert(`Rejected #${id}`);
  }catch(e){
    alert(e.message || e);
  }
};

async function refreshPendingApprovals(){
  try{
    ui.mbePendingMsg.textContent = "Loading‚Ä¶";
    const rows = await mbeFetchPending(ui.mbeClient.value || "AEX");
    renderPending(rows);
    ui.mbePendingMsg.textContent = "";
  }catch(e){
    ui.mbePendingMsg.textContent = e.message || String(e);
  }
}

async function runDailyLines(){
  try{
    ui.mbeDailyMsg.textContent = "Loading‚Ä¶";
    const client = safe(ui.mbeClient.value || "AEX");
    const fromISO = toISOStart(ui.mbeFrom.value);
    const toISO   = toISOEnd(ui.mbeTo.value);
    const rows = await mbeFetchDailyLines(client, fromISO, toISO);
    renderDailyLines(rows);
    ui.mbeDailyMsg.textContent = "";
  }catch(e){
    ui.mbeDailyMsg.textContent = e.message || String(e);
  }
}

function msg(el, text, good=false){
  if(!el) return;
  el.innerHTML = good ? `<span class="ok">${text}</span>` : `<span class="bad">${text}</span>`;
}

function setConn(unlocked){
  ui.connPill.innerHTML = unlocked ? `<span class="ok">‚óè</span> Unlocked` : `<span class="gold">‚óè</span> Locked`;
}
function setRolePill(){
  const r = (role==="LOCKED") ? "Locked" : role;
  const m = (role==="DRIVER") ? "Driver" : mode;
  ui.rolePill.innerHTML = `<span class="info">‚óè</span> Role: ${r} ‚Ä¢ Mode: ${m}`;
}

function fillNumericSelect(sel, max){
  sel.innerHTML = "";
  for(let i=1;i<=max;i++){
    const opt=document.createElement("option");
    opt.value=i; opt.textContent=i;
    sel.appendChild(opt);
  }
}

function roleFromPin(pin){
  if(pin === PIN_MANAGER) return "MANAGER";
  if(pin === PIN_ADMIN) return "ADMIN";
  if(pin === PIN_WAREHOUSE) return "WAREHOUSE";
  if(pin === PIN_DRIVER) return "DRIVER";
  return "LOCKED";
}
function isManagerLike(){ return role==="MANAGER" || role==="ADMIN"; }
function isManagerOnly(){ return role==="MANAGER"; }

function canSee(tab){
  if(isManagerLike()) return true;
  if(role==="WAREHOUSE") return tab==="warehouse";
  if(role==="DRIVER") return tab==="fleet";
  return false;
}

function requireManagerConfirmIfAdmin(){
  if(role !== "ADMIN") return true;
  const pin = prompt("Manager PIN required to approve this edit:");
  return safe(pin) === PIN_MANAGER;
}
function canEdit(area){
  if(role==="MANAGER") return true;
  if(role==="WAREHOUSE") return area==="warehouse";
  if(role==="DRIVER") return area==="fleet_driver";
  // ADMIN requires manager confirm for edits
  return false;
}
function ensureEdit(area, elForMsg, noPermText){
  if(canEdit(area)) return true;
  if(role==="ADMIN"){
    if(!requireManagerConfirmIfAdmin()){
      msg(elForMsg, "Edit blocked (manager approval not confirmed).");
      return false;
    }
    return true;
  }
  msg(elForMsg, noPermText || "No permission.");
  return false;
}
function ensureManagerAdmin(elForMsg){
  if(isManagerLike()) return true;
  msg(elForMsg, "Manager/Admin only.");
  return false;
}

// Mask license unless manager-like
function maskLicense(lic){
  lic = safe(lic).toUpperCase();
  if(!lic) return "‚Äî";
  if(isManagerLike()) return lic;
  const keep = lic.length >= 4 ? 4 : 2;
  return "‚Ä¢‚Ä¢‚Ä¢‚Ä¢" + lic.slice(-keep);
}
function currentLicense(){
  return safe(ui.drvLic.value || localStorage.getItem("locateme_driver_license") || "").toUpperCase();
}

/** ================================
 *  Tabs
 * ================================ */
function setTab(tab){
  if(!canSee(tab)){
    tab = (role==="DRIVER") ? "fleet" : "warehouse";
  }
  ui.tabs.forEach(t=>t.classList.toggle("active", t.dataset.tab===tab));
  Object.entries(ui.panes).forEach(([k,p])=> p.style.display = (k===tab) ? "" : "none");
  localStorage.setItem("locateme_last_tab", tab);
  if(tab==="dashboard") refreshDashboard();
}
ui.tabs.forEach(t=> t.addEventListener("click", ()=> setTab(t.dataset.tab)));

/** ================================
 *  Lock/Unlock
 * ================================ */
function unlockMaster(pin){
  pin = safe(pin);
  if(!pin) return msg(ui.pinMsg, "Enter PIN.");
  const r = roleFromPin(pin);
  if(r==="LOCKED") return msg(ui.pinMsg, "Wrong PIN.");
  role = r;
   __activePin = pin; // ‚úÖ store the pin for billing RPCs
  mode = (role==="DRIVER") ? "DRIVER" : (localStorage.getItem("locateme_mode") || "MANAGER");
  ui.overlay.style.display = "none";
  ui.lockBtn.style.display = "";
  setConn(true);
  setRolePill();
  initApp();
}

function lockAll(){
  role = "LOCKED";
  mode = "MANAGER";
    __activePin = "";
  ui.overlay.style.display = "flex";
  ui.lockBtn.style.display = "none";
  setConn(false);
  setRolePill();
}

/** ================================
 *  Camera scan
 * ================================ */
function camSet(text, ok=false){
  ui.camMsg.innerHTML = ok ? `<span class="ok">‚óè</span> ${text}` : `<span class="gold">‚óè</span> ${text}`;
}
async function camStart(){
  try{
    if(!navigator.mediaDevices?.getUserMedia){
      camSet("Camera not supported on this device.");
      return;
    }
    camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio:false });
    ui.camVideo.srcObject = camStream;
    await ui.camVideo.play();
    camSet("Scanning‚Ä¶", true);

    if("BarcodeDetector" in window){
      camDetector = new BarcodeDetector({ formats: ["qr_code","code_128","code_39","ean_13","ean_8","upc_a","upc_e","pdf417","data_matrix"] });
      scanLoop();
    }else{
      camSet("BarcodeDetector not available ‚Äî type manually.");
    }
  }catch(e){
    camSet(e.message || "Camera failed.");
  }
}
async function scanLoop(){
  if(!camDetector || !camStream) return;
  try{
    const codes = await camDetector.detect(ui.camVideo);
    if(codes?.length){
      const val = codes[0].rawValue || "";
      if(val){
        ui.tagId.value = val;
        camSet("Captured ‚úÖ", true);
        camStop();
        ui.camModal.style.display = "none";
        return;
      }
    }
  }catch(_){}
  requestAnimationFrame(scanLoop);
}
function camStop(){
  if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream = null; }
  camDetector = null;
  camSet("Idle");
}
ui.scanBtn.addEventListener("click", ()=>{ ui.camModal.style.display="flex"; camSet("Idle"); });
ui.camClose.addEventListener("click", ()=>{ camStop(); ui.camModal.style.display="none"; });
ui.camStart.addEventListener("click", camStart);
ui.camStop.addEventListener("click", camStop);

/** ================================
 *  Storage helpers
 * ================================ */
function sanitizeKey(s){ return safe(s).replace(/[^a-zA-Z0-9._-]/g, "_"); }
async function uploadPhoto(bucket, file, keyPrefix){
  const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
  const objectPath = `${keyPrefix}/${Date.now()}_${Math.random().toString(16).slice(2)}.${ext}`;
  const { error } = await sb.storage.from(bucket).upload(objectPath, file, {
    cacheControl:"3600", upsert:false, contentType: file.type || "image/jpeg",
  });
  if(error) throw error;
  return { objectPath, fileName:file.name, contentType:file.type };
}
async function signedUrl(bucket, path){
  const { data, error } = await sb.storage.from(bucket).createSignedUrl(path, 60*10);
  if(error) return null;
  return data?.signedUrl || null;
}

/** ================================
 *  Warehouse: aisles + map
 * ================================ */
async function loadAisles(){
  try{
    const { data, error } = await sb.from("aisles").select("name").order("name",{ascending:true});
    if(error) throw error;
    existingAisles = new Set((data||[]).map(x=>x.name));
  }catch(e){
    existingAisles = new Set();
    ui.aisleSel.innerHTML = `<option value="">(aisles table missing)</option>`;
    ui.aisleWarn.innerHTML = `<span class="bad">${(e && e.message) ? e.message : "Aisles table error"}</span>`;
    return;
  }

  const ordered = [];
  for(const n of AISLE_ORDER) if(existingAisles.has(n)) ordered.push(n);
  for(const n of Array.from(existingAisles).sort()) if(!ordered.includes(n)) ordered.push(n);

  ui.aisleSel.innerHTML = ordered.length
    ? ordered.map(n=>`<option value="${n}">${n}</option>`).join("")
    : `<option value="">(No aisles yet)</option>`;

  showAisleMissingWarning();
}
function showAisleMissingWarning(){
  const missing = AISLE_ORDER.filter(a=> !existingAisles.has(a));
  ui.aisleWarn.innerHTML = missing.length
    ? `<span class="warn">Missing aisles:</span> ${missing.join(", ")}`
    : `<span class="ok">All map aisles exist ‚úÖ</span>`;
}
async function createMissingAisles(){
  if(!ensureEdit("warehouse", ui.aisleWarn, "No permission to create aisles.")) return;
  const missing = AISLE_ORDER.filter(a=> !existingAisles.has(a));
  if(!missing.length) return msg(ui.aisleWarn, "Nothing to create ‚úÖ", true);

  ui.addAislesBtn.disabled = true;
  try{
    const rows = missing.map(name=>({ name }));
    const { error } = await sb.from("aisles").insert(rows);
    if(error) throw error;
    await loadAisles();
    msg(ui.aisleWarn, "Created missing aisles ‚úÖ", true);
  }catch(e){
    msg(ui.aisleWarn, e.message || "Failed to create aisles.");
  }finally{
    ui.addAislesBtn.disabled = false;
  }
}

// simple map: clickable aisle rows + rails
function buildMap(){
  const rows = [
    { aisle:"AEX", rails:21 },
    { aisle:"Maserati", rails:6 },
    { aisle:"Mercedes", rails:9 },
    { aisle:"Bentley", rails:21 },
    { aisle:"Pagani", rails:20 },
    { aisle:"Aston Martin", rails:12 },
    { aisle:"McLaren", rails:10 },
    { aisle:"Ferrari", rails:10 },
    { aisle:"Lamborghini", rails:10 },
    { aisle:"Bugatti", rails:13 },
  ];

  const host = document.createElement("div");
  host.style.padding = "12px";
  host.style.display = "flex";
  host.style.flexDirection = "column";
  host.style.gap = "10px";

  for(const r of rows){
    const row = document.createElement("div");
    row.style.border = "1px solid rgba(255,255,255,.10)";
    row.style.borderRadius = "14px";
    row.style.padding = "10px";
    row.style.background = "rgba(0,0,0,.14)";

    const head = document.createElement("div");
    head.className = "row";
    head.style.justifyContent = "space-between";
    head.innerHTML = `<div class="tag">${r.aisle}</div><div class="meta">rails: ${r.rails}</div>`;
    row.appendChild(head);

    const rails = document.createElement("div");
    rails.style.display = "grid";
    rails.style.gridTemplateColumns = "repeat(7, 1fr)";
    rails.style.gap = "8px";
    rails.style.marginTop = "10px";

    for(let i=1;i<=RAIL_MAX;i++){
      const b = document.createElement("button");
      b.className = "btn";
      b.style.padding = "8px 10px";
      b.style.borderRadius = "12px";
      b.textContent = String(i);
      const active = i <= r.rails;
      b.disabled = !active;
      b.style.opacity = active ? "1" : ".35";
      b.addEventListener("click", ()=>{
        ui.aisleSel.value = r.aisle;
        ui.railSel.value = String(i);
        pushHistory();
        syncMapToDropdown();
      });
      rails.appendChild(b);
    }

    row.appendChild(rails);
    host.appendChild(row);
  }

  ui.mapHost.innerHTML = "";
  ui.mapHost.appendChild(host);
  syncMapToDropdown();
}
function syncMapToDropdown(){
  const aisle = safe(ui.aisleSel.value);
  const rail = safe(ui.railSel.value);
  ui.mapPick.textContent = (aisle && rail) ? `${aisle} ‚Ä¢ Rail ${rail}` : "No selection";
}

/** ================================
 *  Warehouse: save/search/purge
 * ================================ */
async function saveTag(){
  if(!ensureEdit("warehouse", ui.saveMsg, "No permission to edit warehouse.")) return;

  const tagId = safe(ui.tagId.value);
  const aisle = safe(ui.aisleSel.value);
  const rail  = parseInt(ui.railSel.value, 10);
  const level = parseInt(ui.levelSel.value, 10);
  const status = ui.statusSel.value;
  const notes = safe(ui.notes.value);
  const file = ui.photoFile.files && ui.photoFile.files[0];

  if(!tagId) return msg(ui.saveMsg, "Tag ID is required.");
  if(!aisle) return msg(ui.saveMsg, "Pick an aisle.");
  if(existingAisles.size && !existingAisles.has(aisle)) return msg(ui.saveMsg, `Aisle "${aisle}" doesn't exist yet.`);
  if(!(rail>=1 && rail<=RAIL_MAX)) return msg(ui.saveMsg, "Rail out of range.");
  if(!(level>=1 && level<=LEVEL_MAX)) return msg(ui.saveMsg, "Level out of range.");

  ui.saveBtn.disabled = true;
  ui.saveBtn.textContent = "Saving...";
  ui.saveMsg.textContent = "";

  try{
    // upsert by tag_id if you want ‚Äúcurrent location‚Äù, otherwise insert history.
    // This does INSERT history (safe).
    const { data: row, error } = await sb
      .from("pallet_tags")
      .insert([{ tag_id: tagId, aisle_name: aisle, rail, level, status, notes: notes || null }])
      .select("*")
      .single();
    if(error) throw error;

    if(file){
      const up = await uploadPhoto(BUCKET_WAREHOUSE, file, sanitizeKey(tagId));
      const { error: phErr } = await sb.from("tag_photos").insert([{
        pallet_tag_id: row.id,
        bucket: BUCKET_WAREHOUSE,
        object_path: up.objectPath,
        file_name: up.fileName,
        content_type: up.contentType
      }]);
      if(phErr) throw phErr;
    }

    msg(ui.saveMsg, "Saved ‚úÖ", true);
    ui.photoFile.value = "";
  }catch(e){
    msg(ui.saveMsg, (e && e.message) ? e.message : "Save failed.");
  }finally{
    ui.saveBtn.disabled = false;
    ui.saveBtn.textContent = "Save";
  }
}

async function renderTagResults(tagId){
  ui.results.innerHTML = "";
  tagId = safe(tagId);
  if(!tagId) return;

  let data=null, error=null;
  ({ data, error } = await sb
    .from("pallet_tags")
    .select("id, tag_id, aisle_name, rail, level, status, notes, updated_at, created_at")
    .eq("tag_id", tagId)
    .order("created_at", { ascending:false })
    .limit(10)
  );

  if(error){
    ui.results.innerHTML = `<div class="item"><div class="bad">${error.message}</div><div class="meta">If you don‚Äôt have tables yet, create: pallet_tags, tag_photos, aisles.</div></div>`;
    return;
  }
  if(!data?.length){
    ui.results.innerHTML = `<div class="item"><div class="meta">No results for <b>${tagId}</b></div></div>`;
    return;
  }

  const movedCutoff = Date.now() - 24*60*60*1000;

  for(const r of data){
    const updated = r.updated_at ? new Date(r.updated_at).getTime() : 0;
    const moved = updated >= movedCutoff;

    let photos = [];
    try{
      const res = await sb.from("tag_photos")
        .select("object_path, file_name, created_at")
        .eq("pallet_tag_id", r.id)
        .order("created_at",{ascending:false})
        .limit(6);
      photos = res.data || [];
    }catch(_){ photos = []; }

    const photoHtml = [];
    for(const p of photos){
      const url = await signedUrl(BUCKET_WAREHOUSE, p.object_path);
      if(!url) continue;
      photoHtml.push(`
        <div class="photo">
          <img src="${url}" alt="photo"/>
          <div class="cap">${p.file_name || "photo"}</div>
        </div>
      `);
    }

    ui.results.innerHTML += `
      <div class="item" style="${moved ? 'border-color: rgba(255,204,102,.45); box-shadow: 0 0 0 1px rgba(255,204,102,.12) inset;' : ''}">
        <div class="itemTop">
          <div>
            <div class="tag">${r.tag_id} ${moved ? `<span class="pill" style="margin-left:8px;"><span class="warn">‚óè</span> Recently moved</span>` : ""}</div>
            <div class="meta">
              ${r.aisle_name} ‚Ä¢ Rail ${r.rail} ‚Ä¢ Level ${r.level}
              ‚Ä¢ <b class="${r.status==='OUTBOUND'?'bad':'ok'}">${r.status}</b>
            </div>
            ${r.notes ? `<div class="meta" style="margin-top:6px;">${r.notes}</div>` : ""}
          </div>
          <div class="meta">Updated: ${r.updated_at ? new Date(r.updated_at).toLocaleString() : "‚Äî"}</div>
        </div>
        ${photoHtml.length ? `<div class="photos">${photoHtml.join("")}</div>` : `<div class="meta" style="margin-top:10px;">No photos</div>`}
      </div>
    `;
  }
}

async function renderRecent(){
  ui.results.innerHTML = "";
  const { data, error } = await sb
    .from("pallet_tags")
    .select("tag_id, aisle_name, rail, level, status, updated_at")
    .order("updated_at", { ascending:false })
    .limit(20);

  if(error){
    ui.results.innerHTML = `<div class="item"><div class="bad">${error.message}</div></div>`;
    return;
  }
  if(!data?.length){
    ui.results.innerHTML = `<div class="item"><div class="meta">No data yet.</div></div>`;
    return;
  }

  ui.results.innerHTML = data.map(r=>{
    const moved = r.updated_at && new Date(r.updated_at).getTime() >= (Date.now()-24*60*60*1000);
    const safeTag = (r.tag_id||"").replace(/'/g,"\\'");
    return `
      <div class="item" style="${moved ? 'border-color: rgba(255,204,102,.45);' : ''}">
        <div class="itemTop">
          <div>
            <div class="tag">${r.tag_id} ${moved ? `<span class="pill" style="margin-left:8px;"><span class="warn">‚óè</span> Recently moved</span>` : ""}</div>
            <div class="meta">${r.aisle_name} ‚Ä¢ Rail ${r.rail} ‚Ä¢ Level ${r.level} ‚Ä¢ <b class="${r.status==='OUTBOUND'?'bad':'ok'}">${r.status}</b></div>
          </div>
          <div class="meta">${r.updated_at ? new Date(r.updated_at).toLocaleString() : "‚Äî"}</div>
        </div>
        <div class="actions" style="margin-top:10px;">
          <button class="btn" onclick="window.__openTag('${safeTag}')">Open</button>
        </div>
      </div>
    `;
  }).join("");
}
window.__openTag = (t)=>{ ui.searchInput.value=t; renderTagResults(t); };

async function purgeOutbound(){
  if(!ensureEdit("warehouse", ui.saveMsg, "No permission to purge.")) return;
  ui.purgeBtn.disabled = true;
  ui.purgeBtn.textContent = "Purging...";
  try{
    // expects a Supabase RPC: purge_outbound_older_than(days int)
    const { data, error } = await sb.rpc("purge_outbound_older_than", { days: 5 });
    if(error) throw error;
    msg(ui.saveMsg, `Purged ‚úÖ ${JSON.stringify(data || {})}`, true);
  }catch(e){
    msg(ui.saveMsg, (e && e.message) ? e.message : "Purge failed.");
  }finally{
    ui.purgeBtn.disabled = false;
    ui.purgeBtn.textContent = "Purge OUTBOUND > 5 days";
  }
}

function pushHistory(){
  selectionHistory.push({
    aisle: ui.aisleSel.value,
    rail: ui.railSel.value,
    level: ui.levelSel.value,
    status: ui.statusSel.value
  });
  if(selectionHistory.length > 25) selectionHistory.shift();
}
function popHistory(){
  const prev = selectionHistory.pop();
  if(!prev) return;
  ui.aisleSel.value = prev.aisle;
  ui.railSel.value = prev.rail;
  ui.levelSel.value = prev.level;
  ui.statusSel.value = prev.status;
  syncMapToDropdown();
}

/** ================================
 *  Fleet: local profiles
 * ================================ */
function getLocalProfiles(){
  try{ return JSON.parse(localStorage.getItem("locateme_profiles") || "[]"); }catch(_){ return []; }
}
function setLocalProfiles(arr){
  localStorage.setItem("locateme_profiles", JSON.stringify(arr||[]));
}
function addLocalProfile(licenseNo){
  licenseNo = safe(licenseNo).toUpperCase();
  if(!licenseNo) return;
  const arr = getLocalProfiles();
  if(!arr.includes(licenseNo)){
    arr.unshift(licenseNo);
    if(arr.length > 20) arr.length = 20;
    setLocalProfiles(arr);
  }
}
function renderMyProfilesDropdown(){
  const arr = getLocalProfiles();
  const current = (localStorage.getItem("locateme_driver_license") || "").toUpperCase();
  ui.myProfiles.innerHTML = `<option value="">Select‚Ä¶</option>` + arr.map(l=>`<option value="${l}">${maskLicense(l)}</option>`).join("");
  ui.myProfiles.value = current || "";
}

/** ================================
 *  Fleet: damage selection
 * ================================ */
function updateDamageAreaText(){
  const arr = Array.from(damageAreas);
  ui.dmgAreasText.textContent = "Selected: " + (arr.length ? arr.join(", ") : "none");
}
ui.dmgBtns.forEach(b=>{
  b.addEventListener("click", ()=>{
    const a = b.getAttribute("data-area");
    if(!a) return;
    if(damageAreas.has(a)){ damageAreas.delete(a); b.classList.remove("sel"); }
    else { damageAreas.add(a); b.classList.add("sel"); }
    updateDamageAreaText();
  });
});
updateDamageAreaText();

/** ================================
 *  Fleet: jobs + drivers + reports
 * ================================ */
async function loadJobs(){
  try{
    const { data, error } = await sb.from("jobs").select("*").order("job_name",{ascending:true});
    if(error) throw error;
    __jobsCache = data || [];
  }catch(_){
    __jobsCache = [];
  }

  ui.jobSel.innerHTML = `<option value="">(Select job)</option>` + __jobsCache.map(j=>
    `<option value="${j.id}">${j.job_name}${j.job_code ? ` ‚Ä¢ ${j.job_code}`:""}</option>`
  ).join("");
}

window.__openJob = (id)=>{
  if(!isManagerLike()) return;
  const j = __jobsCache.find(x=>String(x.id)===String(id));
  if(!j) return;
  ui.jobIdHidden.value = j.id || "";
  ui.jobName.value = j.job_name || "";
  ui.jobCode.value = j.job_code || "";
  ui.jobStatus.value = (j.status || "OPEN");
  ui.jobNotes.value = j.notes || "";
  msg(ui.jobMsg, "Loaded job ‚úÖ", true);
};

async function saveJob(){
  if(!ensureManagerAdmin(ui.jobMsg)) return;
  // treat jobs as fleet_manager area; admin requires confirm via ensureEdit
  if(!ensureEdit("fleet_manager", ui.jobMsg, "No permission to manage jobs.")) return;

  const id = safe(ui.jobIdHidden.value);
  const payload = {
    job_name: safe(ui.jobName.value),
    job_code: safe(ui.jobCode.value) || null,
    status: safe(ui.jobStatus.value) || "OPEN",
    notes: safe(ui.jobNotes.value) || null,
  };
  if(!payload.job_name) return msg(ui.jobMsg, "Job name required.");

  try{
    const { error } = id
      ? await sb.from("jobs").update(payload).eq("id", id)
      : await sb.from("jobs").insert([payload]);
    if(error) throw error;

    ui.jobIdHidden.value = "";
    msg(ui.jobMsg, "Job saved ‚úÖ", true);
    await loadJobs();
  }catch(e){
    msg(ui.jobMsg, e.message || "Job save failed.");
  }
}

async function loadDriversForReporting(){
  if(!isManagerLike()){
    ui.drvReportSel.innerHTML = `<option value="">(Manager/Admin only)</option>`;
    ui.driversGrouped.innerHTML = `<div class="item"><div class="meta">Manager/Admin only.</div></div>`;
    return;
  }
  try{
    const { data, error } = await sb.from("drivers").select("id,name,license_no,license_status").order("name",{ascending:true});
    if(error) throw error;
    __driversCache = data || [];
  }catch(_){
    __driversCache = [];
  }

  // dropdown
  ui.drvReportSel.innerHTML = `<option value="">(Select driver)</option>` + __driversCache.map(d=>
    `<option value="${d.license_no}">${d.name} ‚Ä¢ ${maskLicense(d.license_no)}</option>`
  ).join("");

  // grouped list
  const groups = {};
  for(const d of __driversCache){
    const st = (d.license_status || "UNKNOWN").toUpperCase();
    (groups[st] ||= []).push(d);
  }
  const order = ["ACTIVE","PERMIT","SUSPENDED","NO_LICENSE","UNKNOWN"];
  ui.driversGrouped.innerHTML = order.filter(k=>groups[k]?.length).map(k=>`
    <div class="item">
      <div class="itemTop">
        <div>
          <div class="tag">${k} <span class="pill" style="margin-left:8px;">${groups[k].length}</span></div>
          <div class="meta">Click a driver to load trips</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="list" style="margin-top:0;">
        ${groups[k].map(d=>`
          <div class="item" style="background:rgba(255,255,255,.03);">
            <div class="itemTop">
              <div>
                <div class="tag">${d.name}</div>
                <div class="meta">License: <b>${maskLicense(d.license_no)}</b></div>
              </div>
              <div class="actions">
                <button class="btn" onclick="window.__openDriverTrips('${(d.license_no||"").replace(/'/g,"\\'")}')">Open</button>
              </div>
            </div>
          </div>
        `).join("")}
      </div>
    </div>
  `).join("") || `<div class="item"><div class="meta">No drivers yet.</div></div>`;
}

window.__openDriverTrips = async (licenseNo)=>{
  if(!isManagerLike()) return;
  ui.drvReportSel.value = safe(licenseNo).toUpperCase();
  await runTripReport();
};

async function runTripReport(){
  const canRunAsManager = isManagerLike();
  const myLic = currentLicense();

  const requested = safe(ui.drvReportSel.value).toUpperCase();
  const enforced = canRunAsManager ? requested : myLic;

  if(!enforced) return msg(ui.drvReportMsg, "Pick a driver / load your profile first.");

  const from = ymdStart(ui.drvFrom.value);
  const to   = ymdEnd(ui.drvTo.value);

  // trips_view expected columns: driver_license_no, driver_name, vehicle_unit, vehicle_plate, mileage_out, mileage_in, job_name, created_at, notes
  let q = sb.from("trips_view").select("*").order("created_at",{ascending:false}).eq("driver_license_no", enforced);
  if(from) q = q.gte("created_at", from);
  if(to)   q = q.lte("created_at", to);

  const { data, error } = await q.limit(800);
  if(error) return msg(ui.drvReportMsg, error.message);

  __reportTripsCache = data || [];

  let totalMiles = 0;
  for(const r of __reportTripsCache){
    const m = Number(r.mileage_in) - Number(r.mileage_out);
    if(Number.isFinite(m)) totalMiles += m;
  }

  ui.drvReportTotals.innerHTML = `
    <span class="pill"><span class="info">‚óè</span> Trips: <b>${__reportTripsCache.length}</b></span>
    <span class="pill"><span class="ok">‚óè</span> Miles: <b>${totalMiles}</b></span>
  `;

  ui.drvReportOut.innerHTML = __reportTripsCache.length ? __reportTripsCache.map(r=>`
    <div class="item">
      <div class="itemTop">
        <div>
          <div class="tag">${r.vehicle_unit || "Vehicle"} ‚Ä¢ ${r.driver_name || "Driver"}</div>
          <div class="meta">
            ${new Date(r.created_at).toLocaleString()} ‚Ä¢ ${r.mileage_out} ‚Üí ${r.mileage_in} (${(r.mileage_in-r.mileage_out)} mi)
            ${r.job_name ? ` ‚Ä¢ <span class="gold"><b>${r.job_name}</b></span>` : ""}
          </div>
          ${r.notes ? `<div class="meta" style="margin-top:6px;">${r.notes}</div>` : ""}
        </div>
        <div class="meta">${r.vehicle_plate || ""}</div>
      </div>
    </div>
  `).join("") : `<div class="item"><div class="meta">No trips in that range.</div></div>`;

  msg(ui.drvReportMsg, "Report ready ‚úÖ", true);
}

async function runJobMileageReport(){
  if(!ensureManagerAdmin(ui.jobReportMsg)) return;

  const from = ymdStart(ui.jobFrom.value);
  const to   = ymdEnd(ui.jobTo.value);

  let q = sb.from("trips_view").select("*").order("created_at",{ascending:false});
  if(from) q = q.gte("created_at", from);
  if(to)   q = q.lte("created_at", to);

  const { data, error } = await q.limit(2000);
  if(error) return msg(ui.jobReportMsg, error.message);

  const rows = data || [];
  const map = new Map();
  for(const r of rows){
    const j = r.job_name || "UNASSIGNED";
    const miles = Number(r.mileage_in) - Number(r.mileage_out);
    if(!map.has(j)) map.set(j, { miles:0, trips:0 });
    const o = map.get(j);
    o.trips += 1;
    if(Number.isFinite(miles)) o.miles += miles;
  }

  const out = Array.from(map.entries()).map(([job, v])=>({ job, ...v }))
    .sort((a,b)=> b.miles - a.miles);

  ui.jobReportOut.innerHTML = out.length ? out.map(r=>`
    <div class="item">
      <div class="itemTop">
        <div>
          <div class="tag">${r.job}</div>
          <div class="meta">Trips: <b>${r.trips}</b> ‚Ä¢ Miles: <b>${r.miles}</b></div>
        </div>
      </div>
    </div>
  `).join("") : `<div class="item"><div class="meta">No data.</div></div>`;

  msg(ui.jobReportMsg, "Job mileage report ready ‚úÖ", true);
}

/** ================================
 *  Export helpers
 * ================================ */
function toCSV(rows){
  if(!rows || !rows.length) return "";
  const keys = Array.from(rows.reduce((s,r)=>{ Object.keys(r||{}).forEach(k=>s.add(k)); return s; }, new Set()));
  const esc = (v)=> `"${String(v ?? "").replace(/"/g,'""')}"`;
  const lines = [];
  lines.push(keys.map(esc).join(","));
  for(const r of rows) lines.push(keys.map(k=>esc(r[k])).join(","));
  return lines.join("\n");
}
function downloadBlob(name, text, type="text/plain"){
  const blob = new Blob([text], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = name;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 800);
}
function exportCSVFile(name, rows){
  const csv = toCSV(rows);
  if(!csv) return alert("No rows to export.");
  downloadBlob(name, csv, "text/csv");
}
function exportPrintPDF(title, rows){
  if(!rows || !rows.length) return alert("No rows to export.");
  const keys = Object.keys(rows[0] || {});
  const html = `
    <html><head><meta charset="utf-8"/><title>${title}</title>
      <style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; padding:18px;}
        h1{margin:0 0 6px;font-size:18px}
        .sub{color:#555;font-size:12px;margin-bottom:12px}
        table{width:100%; border-collapse:collapse; font-size:12px;}
        th,td{border:1px solid #999; padding:6px 8px; text-align:left; vertical-align:top;}
        th{background:#eee;}
      </style>
    </head><body>
      <h1>${title}</h1>
      <div class="sub">Generated: ${new Date().toLocaleString()}</div>
      <table><thead><tr>${keys.map(k=>`<th>${k}</th>`).join("")}</tr></thead>
      <tbody>${rows.map(r=>`<tr>${keys.map(k=>`<td>${(r[k]??"")}</td>`).join("")}</tr>`).join("")}</tbody></table>
      <script>window.onload=()=>{ window.print(); }<\/script>
    </body></html>
  `;
  const w = window.open("", "_blank");
  if(!w) return alert("Pop-up blocked. Allow pop-ups to export PDF.");
  w.document.open(); w.document.write(html); w.document.close();
}

// export buttons
async function exportTripsCSV(){
  if(!__reportTripsCache.length) await runTripReport();
  exportCSVFile(`trips_${Date.now()}.csv`, __reportTripsCache);
}
async function exportTripsPDF(){
  if(!__reportTripsCache.length) await runTripReport();
  exportPrintPDF("Trips Report", __reportTripsCache);
}
async function exportDamagesCSV(){
  if(!ensureManagerAdmin(ui.expMsg)) return;
  const { data, error } = await sb.from("fleet_damage_updates").select("*").order("created_at",{ascending:false}).limit(2000);
  if(error) return msg(ui.expMsg, error.message);
  exportCSVFile(`damages_${Date.now()}.csv`, data||[]);
}
async function exportWarehouseHistoryCSV(){
  if(!ensureManagerAdmin(ui.expMsg)) return;
  const { data, error } = await sb.from("pallet_tags").select("*").order("updated_at",{ascending:false}).limit(5000);
  if(error) return msg(ui.expMsg, error.message);
  exportCSVFile(`warehouse_history_${Date.now()}.csv`, data||[]);
}

/** ================================
 *  Fleet: drivers/vehicles/trips
 * ================================ */
async function saveDriver(){
  if(role==="WAREHOUSE") return msg(ui.drvMsg, "No permission.");
  if(!ensureEdit("fleet_driver", ui.drvMsg, "No permission to edit fleet.")) return;

  const name = safe(ui.drvName.value);
  const middle = safe(ui.drvMid.value) || null;
  const dob = ui.drvDob.value || null;
  const lic = safe(ui.drvLic.value).toUpperCase();
  const status = safe(ui.licStatus.value || "ACTIVE").toUpperCase();

  if(!name) return msg(ui.drvMsg, "Driver name required.");
  if(!dob) return msg(ui.drvMsg, "DOB required.");
  if(!lic) return msg(ui.drvMsg, "License # required.");

  ui.drvSaveBtn.disabled = true;
  ui.drvSaveBtn.textContent = "Saving...";
  try{
    const { error } = await sb.from("drivers").upsert([{
      license_no: lic, name, middle_name: middle, dob, license_status: status
    }], { onConflict: "license_no" });

    if(error) throw error;

    localStorage.setItem("locateme_driver_license", lic);
    addLocalProfile(lic);
    renderMyProfilesDropdown();

    msg(ui.drvMsg, "Driver profile saved ‚úÖ", true);

    if(isManagerLike()) loadDriversForReporting();
  }catch(e){
    msg(ui.drvMsg, e.message || "Save failed.");
  }finally{
    ui.drvSaveBtn.disabled = false;
    ui.drvSaveBtn.textContent = "Save Driver Profile";
  }
}

async function loadDriverByLicense(lic){
  lic = safe(lic).toUpperCase();
  if(!lic) return;
  const { data, error } = await sb.from("drivers")
    .select("name,middle_name,dob,license_no,license_status")
    .eq("license_no", lic)
    .maybeSingle();
  if(error || !data) return;
  ui.drvName.value = data.name || "";
  ui.drvMid.value = data.middle_name || "";
  ui.drvDob.value = data.dob || "";
  ui.drvLic.value = data.license_no || "";
  ui.licStatus.value = (data.license_status || "ACTIVE").toUpperCase();
}

async function loadDriverFromLocal(){
  renderMyProfilesDropdown();
  const lic = (localStorage.getItem("locateme_driver_license") || "").toUpperCase();
  if(lic) await loadDriverByLicense(lic);
}

ui.myProfiles.addEventListener("change", async ()=>{
  const lic = safe(ui.myProfiles.value).toUpperCase();
  if(!lic) return;
  localStorage.setItem("locateme_driver_license", lic);
  await loadDriverByLicense(lic);
  msg(ui.drvMsg, "Loaded profile ‚úÖ", true);
});

async function loadVehicles(){
  const { data, error } = await sb.from("vehicles").select("*").order("unit_name",{ascending:true});
  if(error){
    ui.vehSel.innerHTML = `<option value="">(vehicles table missing)</option>`;
    msg(ui.vehMsg, error.message);
    return;
  }
  const rows = data || [];
  ui.vehSel.innerHTML = rows.length
    ? rows.map(v=>`<option value="${v.id}">${v.unit_name}${v.plate ? " ‚Ä¢ "+v.plate : ""} ‚Ä¢ ${v.make_model || "Vehicle"}</option>`).join("")
    : `<option value="">(No vehicles yet)</option>`;

  await renderTripList();
}

async function createVehicle(){
  if(!ensureEdit("fleet_manager", ui.vehMsg, "No permission to create vehicles.")) return;

  const unit = safe(ui.vehUnit.value);
  const plate = safe(ui.vehPlate.value);
  const model = safe(ui.vehModel.value);
  const miles = parseInt(ui.vehMiles.value, 10);

  if(!unit) return msg(ui.vehMsg, "Unit # required.");

  ui.vehCreateBtn.disabled = true;
  ui.vehCreateBtn.textContent = "Saving...";
  try{
    const { error } = await sb.from("vehicles").insert([{
      unit_name: unit,
      plate: plate || null,
      make_model: model || null,
      current_mileage: Number.isFinite(miles) ? miles : null,
      status: "ACTIVE"
    }]);
    if(error) throw error;

    msg(ui.vehMsg, "Vehicle saved ‚úÖ", true);
    ui.vehUnit.value = ui.vehPlate.value = ui.vehModel.value = ui.vehMiles.value = "";
    await loadVehicles();
  }catch(e){
    msg(ui.vehMsg, e.message || "Vehicle save failed.");
  }finally{
    ui.vehCreateBtn.disabled = false;
    ui.vehCreateBtn.textContent = "Save Vehicle";
  }
}

async function saveTrip(){
  if(!ensureEdit("fleet_driver", ui.tripMsg, "No permission to submit trips.")) return;

  const lic = safe(ui.drvLic.value).toUpperCase();
  if(!lic) return msg(ui.tripMsg, "Driver profile required first (license #).");

  const { data: driver, error: dErr } = await sb.from("drivers").select("id").eq("license_no", lic).maybeSingle();
  if(dErr) return msg(ui.tripMsg, dErr.message);
  if(!driver?.id) return msg(ui.tripMsg, "Driver profile not found. Save it first.");

  const vehicleId = safe(ui.vehSel.value);
  if(!vehicleId) return msg(ui.tripMsg, "Pick a vehicle.");

  const jobId = safe(ui.jobSel.value);

  const mileOut = parseInt(ui.mileOut.value, 10);
  const mileIn  = parseInt(ui.mileIn.value, 10);
  if(!Number.isFinite(mileOut)) return msg(ui.tripMsg, "Mileage BEFORE required.");
  if(!Number.isFinite(mileIn)) return msg(ui.tripMsg, "Mileage AFTER required.");
  if(mileIn < mileOut) return msg(ui.tripMsg, "Mileage AFTER can‚Äôt be less than BEFORE.");

  const beforeFile = ui.cabBefore.files && ui.cabBefore.files[0];
  const afterFile  = ui.cabAfter.files && ui.cabAfter.files[0];
  if(!beforeFile) return msg(ui.tripMsg, "Cab BEFORE photo required.");
  if(!afterFile)  return msg(ui.tripMsg, "Cab AFTER photo required.");
  if(!ui.ackBox.checked) return msg(ui.tripMsg, "You must confirm accountability checkbox.");

  const dmgType = safe(ui.dmgType.value);
  const dmgArea = Array.from(damageAreas).join(",");
  const dmgNotes = safe(ui.dmgNotes.value);

  ui.tripSaveBtn.disabled = true;
  ui.tripSaveBtn.textContent = "Submitting...";

  try{
    const { data: trip, error } = await sb.from("trips").insert([{
      driver_id: driver.id,
      vehicle_id: vehicleId,
      job_id: jobId || null,
      mileage_out: mileOut,
      mileage_in: mileIn,
      notes: safe(ui.tripNotes.value) || null,
      ack_damage_policy: true,
      damage_update_type: dmgType || null,
      damage_update_notes: dmgNotes || null,
      damage_area: dmgArea || null
    }]).select("*").single();
    if(error) throw error;

    const prefix = `trip_${trip.id}`;
    const upB = await uploadPhoto(BUCKET_FLEET, beforeFile, prefix);
    const upA = await uploadPhoto(BUCKET_FLEET, afterFile, prefix);

    const { error: phErr } = await sb.from("trip_photos").insert([
      { trip_id: trip.id, kind: "CAB_BEFORE", bucket: BUCKET_FLEET, object_path: upB.objectPath, file_name: upB.fileName, content_type: upB.contentType },
      { trip_id: trip.id, kind: "CAB_AFTER",  bucket: BUCKET_FLEET, object_path: upA.objectPath, file_name: upA.fileName, content_type: upA.contentType },
    ]);
    if(phErr) throw phErr;

    if(dmgType){
      const { data: dmgRow, error: dmgErr } = await sb.from("fleet_damage_updates").insert([{
        trip_id: trip.id,
        vehicle_id: vehicleId,
        driver_id: driver.id,
        update_type: dmgType,
        area: dmgArea || "UNSPECIFIED",
        notes: dmgNotes || null
      }]).select("*").single();
      if(dmgErr) throw dmgErr;

      const files = ui.dmgPhotos.files ? Array.from(ui.dmgPhotos.files) : [];
      for(const f of files){
        const up = await uploadPhoto(BUCKET_FLEET, f, `damage_${dmgRow.id}`);
        const { error: dpErr } = await sb.from("fleet_damage_photos").insert([{
          damage_update_id: dmgRow.id,
          bucket: BUCKET_FLEET,
          object_path: up.objectPath,
          file_name: up.fileName,
          content_type: up.contentType
        }]);
        if(dpErr) throw dpErr;
      }
    }

    await sb.from("vehicles").update({ current_mileage: mileIn, last_trip_at: nowISO() }).eq("id", vehicleId);

    msg(ui.tripMsg, "Trip submitted ‚úÖ", true);

    // reset
    ui.mileOut.value = ui.mileIn.value = "";
    ui.cabBefore.value = ui.cabAfter.value = "";
    ui.tripNotes.value = "";
    ui.ackBox.checked = false;
    ui.dmgType.value = "";
    ui.dmgNotes.value = "";
    ui.dmgPhotos.value = "";
    damageAreas.clear();
    ui.dmgBtns.forEach(b=>b.classList.remove("sel"));
    updateDamageAreaText();
    ui.jobSel.value = "";

    await renderTripList();
    if(localStorage.getItem("locateme_last_tab")==="dashboard") refreshDashboard();
  }catch(e){
    msg(ui.tripMsg, e.message || "Trip failed.");
  }finally{
    ui.tripSaveBtn.disabled = false;
    ui.tripSaveBtn.textContent = "Submit Trip";
  }
}

async function renderTripList(){
  ui.tripList.innerHTML = "";
  const { data, error } = await sb.from("trips_view").select("*").order("created_at",{ascending:false}).limit(10);
  if(error){
    ui.tripList.innerHTML = `<div class="item"><div class="bad">${error.message}</div><div class="meta">If trips_view doesn‚Äôt exist, create it or change this query to trips + joins.</div></div>`;
    return;
  }
  const rows = data || [];
  ui.tripList.innerHTML = rows.length ? rows.map(r=>`
    <div class="item">
      <div class="itemTop">
        <div>
          <div class="tag">${r.vehicle_unit || "Vehicle"} ‚Ä¢ ${r.driver_name || "Driver"}</div>
          <div class="meta">
            ${new Date(r.created_at).toLocaleString()} ‚Ä¢ ${r.mileage_out} ‚Üí ${r.mileage_in} (${(r.mileage_in-r.mileage_out)} mi)
            ${r.job_name ? ` ‚Ä¢ <span class="gold"><b>${r.job_name}</b></span>` : ""}
          </div>
          ${r.notes ? `<div class="meta" style="margin-top:6px;">${r.notes}</div>` : ""}
        </div>
        <div class="meta">${r.vehicle_plate || ""}</div>
      </div>
    </div>
  `).join("") : `<div class="item"><div class="meta">No trips yet.</div></div>`;
}

async function createRepairTicket(){
  if(!ensureEdit("fleet_driver", ui.vehMsg, "No permission to create tickets.")) return;

  const vehicleId = safe(ui.vehSel.value);
  if(!vehicleId) return msg(ui.vehMsg, "Pick a vehicle first.");

  const lic = safe(ui.drvLic.value).toUpperCase();
  if(!lic) return msg(ui.vehMsg, "Load your driver profile first.");

  const { data: driver, error: dErr } = await sb.from("drivers").select("id").eq("license_no", lic).maybeSingle();
  if(dErr) return msg(ui.vehMsg, dErr.message);
  if(!driver?.id) return msg(ui.vehMsg, "Driver not found. Save profile first.");

  const summary = prompt("Repair summary (short):", "Brakes / lights / tire / damage / etc");
  if(!summary) return;
  const area = (prompt("Area (FRONT/BACK/DRIVER_SIDE/PASSENGER_SIDE/MIRRORS/OTHER):", "FRONT") || "OTHER").toUpperCase();
  const priority = (prompt("Priority: LOW / MEDIUM / HIGH", "MEDIUM") || "MEDIUM").toUpperCase();
  const remarks = prompt("Remarks (optional):", "") || "";

  let file = null;
  if(confirm("Attach a photo to this repair ticket?")){
    file = await pickSingleImage();
  }

  try{
    const { data: ticket, error } = await sb.from("maintenance_tickets").insert([{
      vehicle_id: vehicleId,
      driver_id: driver.id,
      summary,
      priority,
      status: "OPEN",
      area,
      remarks: remarks || null
    }]).select("*").single();
    if(error) throw error;

    if(file){
      const up = await uploadPhoto(BUCKET_FLEET, file, `ticket_${ticket.id}`);
      const { error: pErr } = await sb.from("maintenance_ticket_photos").insert([{
        maintenance_ticket_id: ticket.id,
        bucket: BUCKET_FLEET,
        object_path: up.objectPath,
        file_name: up.fileName,
        content_type: up.contentType
      }]);
      if(pErr) throw pErr;
    }

    msg(ui.vehMsg, "Repair ticket created ‚úÖ", true);
  }catch(e){
    msg(ui.vehMsg, e.message || "Ticket failed.");
  }
}
function pickSingleImage(){
  return new Promise((resolve)=>{
    const input = document.createElement("input");
    input.type="file"; input.accept="image/*";
    input.onchange=()=> resolve(input.files && input.files[0] ? input.files[0] : null);
    input.click();
  });
}

/** ================================
 *  Logistics: shipments
 * ================================ */
async function saveShipment(){
  if(!ensureEdit("logistics", ui.shMsg, "No permission to edit logistics.")) return;

  const id = safe(ui.shId.value);
  if(!id) return msg(ui.shMsg, "Shipment ID required.");

  ui.shSaveBtn.disabled = true;
  ui.shSaveBtn.textContent = "Saving...";
  try{
    const payload = {
      shipment_id: id,
      status: ui.shStatus.value,
      carrier: safe(ui.shCarrier.value) || null,
      po_no: safe(ui.shPO.value) || null,
      bol_no: safe(ui.shBOL.value) || null,
      pickup: safe(ui.shPickup.value) || null,
      dropoff: safe(ui.shDrop.value) || null,
      notes: safe(ui.shNotes.value) || null
    };

    const { data: ship, error } = await sb
      .from("shipments")
      .upsert([payload], { onConflict: "shipment_id" })
      .select("*")
      .single();
    if(error) throw error;

    const file = ui.shPhoto.files && ui.shPhoto.files[0];
    if(file){
      const up = await uploadPhoto(BUCKET_LOGISTICS, file, `shipment_${ship.id}`);
      const { error: phErr } = await sb.from("shipment_photos").insert([{
        shipment_id: ship.id,
        bucket: BUCKET_LOGISTICS,
        object_path: up.objectPath,
        file_name: up.fileName,
        content_type: up.contentType
      }]);
      if(phErr) throw phErr;
      ui.shPhoto.value = "";
    }

    msg(ui.shMsg, "Shipment saved ‚úÖ", true);
    await refreshShipments();
    if(localStorage.getItem("locateme_last_tab")==="dashboard") refreshDashboard();
  }catch(e){
    msg(ui.shMsg, e.message || "Shipment save failed.");
  }finally{
    ui.shSaveBtn.disabled = false;
    ui.shSaveBtn.textContent = "Save Shipment";
  }
}

async function refreshShipments(){
  ui.shList.innerHTML = "";
  const { data, error } = await sb.from("shipments").select("*").order("updated_at",{ascending:false}).limit(30);
  if(error){
    ui.shList.innerHTML = `<div class="item"><div class="bad">${error.message}</div><div class="meta">If shipments table doesn‚Äôt exist yet, create it first.</div></div>`;
    return;
  }
  const rows = data || [];
  ui.shList.innerHTML = rows.length ? rows.map(r=>`
    <div class="item">
      <div class="itemTop">
        <div>
          <div class="tag">${r.shipment_id} ‚Ä¢ <span class="${r.status==='EXCEPTION'?'bad':(r.status==='DELIVERED'?'ok':'warn')}">${r.status}</span></div>
          <div class="meta">${r.carrier || "‚Äî"} ‚Ä¢ PO: ${r.po_no || "‚Äî"} ‚Ä¢ BOL: ${r.bol_no || "‚Äî"}</div>
          <div class="meta" style="margin-top:6px;">${r.pickup || "‚Äî"} ‚Üí ${r.dropoff || "‚Äî"}</div>
        </div>
        <div class="meta">Updated: ${r.updated_at ? new Date(r.updated_at).toLocaleString() : "‚Äî"}</div>
      </div>
      <div class="actions" style="margin-top:10px;">
        <button class="btn" onclick="window.__openShipment('${(r.shipment_id||"").replace(/'/g,"\\'")}')">Open</button>
      </div>
    </div>
  `).join("") : `<div class="item"><div class="meta">No shipments yet.</div></div>`;
}

window.__openShipment = async (shipmentId)=>{
  const { data } = await sb.from("shipments").select("*").eq("shipment_id", shipmentId).maybeSingle();
  if(!data) return;
  ui.shId.value = data.shipment_id || "";
  ui.shStatus.value = data.status || "PLANNED";
  ui.shCarrier.value = data.carrier || "";
  ui.shPO.value = data.po_no || "";
  ui.shBOL.value = data.bol_no || "";
  ui.shPickup.value = data.pickup || "";
  ui.shDrop.value = data.dropoff || "";
  ui.shNotes.value = data.notes || "";
};

async function searchShipments(){
  const q = safe(ui.shSearch.value);
  if(!q) return refreshShipments();
  ui.shList.innerHTML = "";

  const { data, error } = await sb.from("shipments")
    .select("*")
    .or(`shipment_id.ilike.%${q}%,po_no.ilike.%${q}%,bol_no.ilike.%${q}%,carrier.ilike.%${q}%`)
    .order("updated_at",{ascending:false})
    .limit(30);

  if(error){
    ui.shList.innerHTML = `<div class="item"><div class="bad">${error.message}</div></div>`;
    return;
  }
  const rows = data || [];
  ui.shList.innerHTML = rows.length ? rows.map(r=>`
    <div class="item">
      <div class="itemTop">
        <div>
          <div class="tag">${r.shipment_id} ‚Ä¢ <span class="${r.status==='EXCEPTION'?'bad':(r.status==='DELIVERED'?'ok':'warn')}">${r.status}</span></div>
          <div class="meta">${r.carrier || "‚Äî"} ‚Ä¢ PO: ${r.po_no || "‚Äî"} ‚Ä¢ BOL: ${r.bol_no || "‚Äî"}</div>
          <div class="meta" style="margin-top:6px;">${r.pickup || "‚Äî"} ‚Üí ${r.dropoff || "‚Äî"}</div>
        </div>
        <div class="meta">Updated: ${r.updated_at ? new Date(r.updated_at).toLocaleString() : "‚Äî"}</div>
      </div>
      <div class="actions" style="margin-top:10px;">
        <button class="btn" onclick="window.__openShipment('${(r.shipment_id||"").replace(/'/g,"\\'")}')">Open</button>
      </div>
    </div>
  `).join("") : `<div class="item"><div class="meta">No matches.</div></div>`;
}

async function shipmentsRecentlyUpdated(){
  ui.shList.innerHTML = "";
  const { data, error } = await sb.from("shipments")
    .select("*")
    .gte("updated_at", daysAgoISO(1))
    .order("updated_at",{ascending:false})
    .limit(30);
  if(error){
    ui.shList.innerHTML = `<div class="item"><div class="bad">${error.message}</div></div>`;
    return;
  }
  const rows = data || [];
  ui.shList.innerHTML = rows.length ? rows.map(r=>`
    <div class="item">
      <div class="itemTop">
        <div>
          <div class="tag">${r.shipment_id} ‚Ä¢ <span class="${r.status==='EXCEPTION'?'bad':(r.status==='DELIVERED'?'ok':'warn')}">${r.status}</span></div>
          <div class="meta">${r.carrier || "‚Äî"} ‚Ä¢ PO: ${r.po_no || "‚Äî"} ‚Ä¢ BOL: ${r.bol_no || "‚Äî"}</div>
          <div class="meta" style="margin-top:6px;">${r.pickup || "‚Äî"} ‚Üí ${r.dropoff || "‚Äî"}</div>
        </div>
        <div class="meta">Updated: ${r.updated_at ? new Date(r.updated_at).toLocaleString() : "‚Äî"}</div>
      </div>
      <div class="actions" style="margin-top:10px;">
        <button class="btn" onclick="window.__openShipment('${(r.shipment_id||"").replace(/'/g,"\\'")}')">Open</button>
      </div>
    </div>
  `).join("") : `<div class="item"><div class="meta">None updated in last 24h.</div></div>`;
}

/** ================================
 *  Dashboard
 * ================================ */
async function refreshDashboard(){
  // counts
  const [wCount, movedCount, vCount, shipOpen] = await Promise.all([
    sb.from("pallet_tags").select("id", { count:"exact", head:true }),
    sb.from("pallet_tags").select("id", { count:"exact", head:true }).gte("updated_at", daysAgoISO(1)),
    sb.from("vehicles").select("id", { count:"exact", head:true }),
    sb.from("shipments").select("id", { count:"exact", head:true }).not("status","eq","DELIVERED").not("status","eq","CANCELLED"),
  ]);

  ui.kWarehouse.textContent = (wCount.count ?? "‚Äî");
  ui.kMoved.textContent     = (movedCount.count ?? "‚Äî");
  ui.kFleet.textContent     = (vCount.count ?? "‚Äî");
  ui.kShip.textContent      = (shipOpen.count ?? "‚Äî");

  const [moves, trips, exc] = await Promise.all([
    sb.from("pallet_tags").select("tag_id, aisle_name, rail, level, status, updated_at").order("updated_at",{ascending:false}).limit(8),
    sb.from("trips_view").select("*").order("created_at",{ascending:false}).limit(8),
    sb.from("shipments").select("*").eq("status","EXCEPTION").order("updated_at",{ascending:false}).limit(10),
  ]);

  ui.dashMoves.innerHTML = (moves.data||[]).length ? (moves.data||[]).map(r=>`
    <div class="item">
      <div class="itemTop">
        <div>
          <div class="tag">${r.tag_id} ‚Ä¢ <span class="${r.status==='OUTBOUND'?'bad':'ok'}">${r.status}</span></div>
          <div class="meta">${r.aisle_name} ‚Ä¢ Rail ${r.rail} ‚Ä¢ Level ${r.level}</div>
        </div>
        <div class="meta">${r.updated_at ? new Date(r.updated_at).toLocaleString() : "‚Äî"}</div>
      </div>
    </div>
  `).join("") : `<div class="item"><div class="meta">No movements yet.</div></div>`;

  ui.dashTrips.innerHTML = (trips.data||[]).length ? (trips.data||[]).map(r=>`
    <div class="item">
      <div class="itemTop">
        <div>
          <div class="tag">${r.vehicle_unit || "Vehicle"} ‚Ä¢ ${r.driver_name || "Driver"}</div>
          <div class="meta">${new Date(r.created_at).toLocaleString()} ‚Ä¢ ${r.mileage_out} ‚Üí ${r.mileage_in} (${(r.mileage_in-r.mileage_out)} mi)</div>
        </div>
        <div class="meta">${r.vehicle_plate || ""}</div>
      </div>
    </div>
  `).join("") : `<div class="item"><div class="meta">No trips yet.</div></div>`;

  ui.dashExceptions.innerHTML = (exc.data||[]).length ? (exc.data||[]).map(r=>`
    <div class="item">
      <div class="itemTop">
        <div>
          <div class="tag">${r.shipment_id} ‚Ä¢ <span class="bad">EXCEPTION</span></div>
          <div class="meta">${r.carrier || "‚Äî"} ‚Ä¢ PO: ${r.po_no || "‚Äî"} ‚Ä¢ BOL: ${r.bol_no || "‚Äî"}</div>
          <div class="meta" style="margin-top:6px;">${r.pickup || "‚Äî"} ‚Üí ${r.dropoff || "‚Äî"}</div>
        </div>
        <div class="meta">${r.updated_at ? new Date(r.updated_at).toLocaleString() : "‚Äî"}</div>
      </div>
    </div>
  `).join("") : `<div class="item"><div class="meta">No exceptions ‚úÖ</div></div>`;
}

async function saveManagerNotes(){
  if(!ensureEdit("dashboard", ui.notesMsg, "No permission to edit notes.")) return;
  const text = safe(ui.mgrNotes.value);
  const { error } = await sb.from("manager_notes").upsert([{ key:"ops_notes", content:text || "" }], { onConflict:"key" });
  if(error) return msg(ui.notesMsg, error.message);
  msg(ui.notesMsg, "Saved ‚úÖ", true);
}
async function loadManagerNotes(){
  const { data, error } = await sb.from("manager_notes").select("content").eq("key","ops_notes").maybeSingle();
  if(error) return msg(ui.notesMsg, error.message);
  ui.mgrNotes.value = data?.content || "";
  msg(ui.notesMsg, "Loaded ‚úÖ", true);
}

/** ================================
 *  Mode + UI rules
 * ================================ */
function applyMode(){
  if(role==="DRIVER"){
    mode="DRIVER";
    ui.modeSel.value="DRIVER";
    msg(ui.modeMsg, "Driver role: mode locked ‚úÖ", true);
  }else{
    mode = ui.modeSel.value;
    msg(ui.modeMsg, `Mode set to ${mode} ‚úÖ`, true);
  }
  localStorage.setItem("locateme_mode", mode);
  setRolePill();
  applyFleetUIRules();
}
function applyFleetUIRules(){
  const isDriverView = (role==="DRIVER") || (mode==="DRIVER");

  // vehicle creation manager-only
  const allowVehicleCreate = isManagerLike() && !isDriverView;
  ui.vehCreateBtn.disabled = !allowVehicleCreate;
  [ui.vehUnit, ui.vehPlate, ui.vehModel, ui.vehMiles].forEach(x=> x.disabled = !allowVehicleCreate);

  // reporting panels manager/admin only
  ui.fleetReportsCard.style.display = isManagerLike() ? "" : "none";
}

async function autoPurgeOncePerDay(){
  const k = "locateme_last_purge";
  const last = parseInt(localStorage.getItem(k) || "0", 10);
  const now = Date.now();
  if(!last || (now-last) > 24*60*60*1000){
    try{
      if(role==="MANAGER" || role==="ADMIN"){
        await sb.rpc("purge_outbound_older_than", { days:5 });
      }
      localStorage.setItem(k, String(now));
    }catch(_){}
  }
}

/** ================================
 *  Init
 * ================================ */
async function initApp(){
  // show/hide tabs by role
  ui.tabs.forEach(t=>{
    const tab = t.dataset.tab;
    t.style.display = canSee(tab) ? "" : "none";
  });

  // warehouse init
  fillNumericSelect(ui.railSel, RAIL_MAX);
  fillNumericSelect(ui.levelSel, LEVEL_MAX);
  await loadAisles();
  buildMap();

  ["change"].forEach(evt=>{
    ui.aisleSel.addEventListener(evt, ()=>{ pushHistory(); syncMapToDropdown(); });
    ui.railSel.addEventListener(evt, ()=>{ pushHistory(); syncMapToDropdown(); });
    ui.levelSel.addEventListener(evt, pushHistory);
    ui.statusSel.addEventListener(evt, pushHistory);
  });

  // fleet init
  if(role==="DRIVER"){ mode="DRIVER"; ui.modeSel.value="DRIVER"; }
  else { ui.modeSel.value = mode; }
  setRolePill();
  applyFleetUIRules();

  await loadDriverFromLocal();

  if(canSee("fleet")){
    await loadVehicles();
    await loadJobs();
    await loadDriversForReporting();
  }

  // logistics init
  if(canSee("logistics")) await refreshShipments();

  // dashboard
  if(canSee("dashboard")) await refreshDashboard();

  await autoPurgeOncePerDay();

  const preferred = localStorage.getItem("locateme_last_tab") || "warehouse";
  const fallback = (role==="DRIVER") ? "fleet" : (role==="WAREHOUSE" ? "warehouse" : preferred);
  setTab(canSee(fallback) ? fallback : ((role==="DRIVER") ? "fleet" : "warehouse"));
}

/** ================================
 *  Events
 * ================================ */
// pin
ui.pinBtn.addEventListener("click", ()=> unlockMaster(ui.pin.value));
ui.pinClear.addEventListener("click", ()=> { ui.pin.value=""; ui.pinMsg.textContent=""; });
ui.pin.addEventListener("keydown", (e)=>{ if(e.key==="Enter") unlockMaster(ui.pin.value); });

// lock
ui.lockBtn.addEventListener("click", lockAll);

// warehouse
ui.saveBtn.addEventListener("click", saveTag);
ui.backBtn.addEventListener("click", popHistory);
ui.purgeBtn.addEventListener("click", purgeOutbound);
ui.searchBtn.addEventListener("click", ()=> renderTagResults(ui.searchInput.value));
ui.searchInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") renderTagResults(ui.searchInput.value); });
ui.recentBtn.addEventListener("click", renderRecent);
ui.addAislesBtn.addEventListener("click", createMissingAisles);
ui.centerSelectBtn.addEventListener("click", syncMapToDropdown);

// fleet
ui.drvSaveBtn.addEventListener("click", saveDriver);
ui.modeApplyBtn.addEventListener("click", applyMode);
ui.tripSaveBtn.addEventListener("click", saveTrip);
ui.vehRefreshBtn.addEventListener("click", loadVehicles);
ui.vehCreateBtn.addEventListener("click", createVehicle);
ui.mtAddBtn.addEventListener("click", createRepairTicket);

// reporting + exports + jobs
ui.drvReportBtn.addEventListener("click", runTripReport);
ui.drvReportCsvBtn.addEventListener("click", ()=> exportCSVFile(`driver_report_${Date.now()}.csv`, __reportTripsCache));
ui.jobReportBtn.addEventListener("click", runJobMileageReport);
ui.jobReportCsvBtn.addEventListener("click", ()=>{
  // quick export from DOM list is messy; re-run and export from computed output by running again:
  alert("Tip: Click ‚ÄúRun Job Report‚Äù first, then use Trips ‚Üí CSV if you want raw rows. If you want a dedicated job-export table, tell me and I‚Äôll add it.");
});
ui.jobSaveBtn.addEventListener("click", saveJob);
ui.jobRefreshBtn.addEventListener("click", loadJobs);

ui.expTripsCsvBtn.addEventListener("click", exportTripsCSV);
ui.expTripsPdfBtn.addEventListener("click", exportTripsPDF);
ui.expDmgCsvBtn.addEventListener("click", exportDamagesCSV);
ui.expWhCsvBtn.addEventListener("click", exportWarehouseHistoryCSV);

// logistics
ui.shSaveBtn.addEventListener("click", saveShipment);
ui.shRefreshBtn.addEventListener("click", refreshShipments);
ui.shSearchBtn.addEventListener("click", searchShipments);
ui.shSearch.addEventListener("keydown", (e)=>{ if(e.key==="Enter") searchShipments(); });
ui.shTodayBtn.addEventListener("click", shipmentsRecentlyUpdated);

// dashboard notes
ui.notesSaveBtn.addEventListener("click", saveManagerNotes);
ui.notesLoadBtn.addEventListener("click", loadManagerNotes);
// billing tab
ui.billLogBtn?.addEventListener("click", billingLogMovement);
ui.billClearBtn?.addEventListener("click", billingClearForm);
ui.billLinesRunBtn?.addEventListener("click", billingRunDailyLines);
ui.billPendingBtn?.addEventListener("click", refreshBillingPending);

// billing (dashboard)
ui.mbeDailyRunBtn?.addEventListener("click", runDailyLines);
ui.mbePendingBtn?.addEventListener("click", refreshPendingApprovals);


// boot (always locked)
(function boot(){
  ui.overlay.style.display = "flex";
  ui.lockBtn.style.display = "none";
  setConn(false);
  setRolePill();
})();
</script>
</body>
</html>
