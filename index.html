<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LocateMe ‚Äî Warehouse Pallet & Photo Tracker</title>

  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- ZXing for camera barcode scan (UMD) -->
  <script src="https://unpkg.com/@zxing/browser@0.1.5/umd/zxing-browser.min.js"></script>
  <!-- jsPDF for PDF exports -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#07080b;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.09);
      --stroke:rgba(255,255,255,.12);
      --text:#e9eef5;
      --muted:rgba(233,238,245,.70);
      --gold1:#ffcf5a;
      --gold2:#caa24d;
      --ok:#38d27a;
      --bad:#ff5964;
      --warn:#ffcc66;
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 10% 0%, rgba(255,207,90,.16), transparent 60%),
                  radial-gradient(900px 500px at 90% 30%, rgba(202,162,77,.14), transparent 55%),
                  linear-gradient(160deg, #050506, #090a0f 55%, #06070a);
      min-height:100vh;
      overflow-x:hidden;
    }
    .waves{
      position:fixed; inset:-120px -120px auto -120px; height:520px; pointer-events:none; opacity:.9; z-index:-1;
      filter: blur(0px);
    }
    .waves:before,.waves:after{
      content:"";
      position:absolute; inset:0;
      background-image:
        radial-gradient(900px 280px at 15% 30%, rgba(255,207,90,.35), transparent 60%),
        radial-gradient(800px 260px at 80% 15%, rgba(202,162,77,.32), transparent 60%),
        radial-gradient(700px 250px at 55% 70%, rgba(255,207,90,.18), transparent 60%);
      transform: rotate(-6deg);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(10,10,14,.75), rgba(10,10,14,.25));
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .wrap{max-width:1180px; margin:0 auto; padding:18px 18px;}
    .top{
      display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, rgba(255,207,90,.95), rgba(202,162,77,.9));
      box-shadow: 0 12px 28px rgba(255,207,90,.12);
    }
    h1{margin:0; font-size:18px; letter-spacing:.4px}
    .sub{margin:2px 0 0 0; color:var(--muted); font-size:12px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      font-size:12px; color:var(--muted);
    }
    .dot{width:8px; height:8px; border-radius:50%; background: var(--warn);}
    .dot.ok{background: var(--ok);}
    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1.2fr .8fr;
      align-items:start;
      margin-top:18px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      background: rgba(255,255,255,.05);
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .card .bd{padding:16px;}
    .title{font-weight:700; letter-spacing:.25px}
    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input, select, button, textarea{
      font: inherit;
      color: var(--text);
    }
    input, select, textarea{
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 11px 12px;
      outline: none;
      width: 100%;
    }
    textarea{min-height:70px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color: rgba(255,207,90,.45); box-shadow: 0 0 0 3px rgba(255,207,90,.12);}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.11)}
    .btn:active{transform: translateY(1px)}
    .btn.gold{
      border-color: rgba(255,207,90,.35);
      background: linear-gradient(135deg, rgba(255,207,90,.22), rgba(202,162,77,.14));
    }
    .btn.ok{
      border-color: rgba(56,210,122,.35);
      background: rgba(56,210,122,.12);
    }
    .btn.bad{
      border-color: rgba(255,89,100,.35);
      background: rgba(255,89,100,.12);
    }
    .btn.small{padding:8px 10px; border-radius:12px; font-size:12px}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .cols{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 560px){.cols{grid-template-columns:1fr}}
    .map{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap:10px;
    }
    .tile{
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .tile:hover{background: rgba(255,255,255,.07); border-color: rgba(255,207,90,.20)}
    .tile:active{transform: translateY(1px)}
    .tile.sel{
      border-color: rgba(255,207,90,.40);
      box-shadow: 0 0 0 3px rgba(255,207,90,.12);
      background: rgba(255,207,90,.08);
    }
    .crumb{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      color:var(--muted); font-size:12px;
    }
    .crumb b{color:var(--text)}
    .thumbs{display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px; margin-top:10px}
    .thumb{
      border-radius:16px; overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
    }
    .thumb img{width:100%; height:160px; object-fit:cover; display:block}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; font-size:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    .badge.recent{
      border-color: rgba(255,204,102,.45);
      background: rgba(255,204,102,.14);
      color: #ffe6aa;
    }
    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
    }
    th, td{
      padding:10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size:13px;
      vertical-align: top;
    }
    th{color:var(--muted); font-weight:700; background: rgba(255,255,255,.04)}
    tr:hover td{background: rgba(255,255,255,.03)}
    .right{display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap}
    .note{font-size:12px; color:var(--muted)}
    .hr{height:1px; background: rgba(255,255,255,.10); margin:14px 0}
    .videoWrap{
      display:none;
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow:hidden;
      background: rgba(0,0,0,.20);
    }
    video{width:100%; height:240px; object-fit:cover; display:block}
    .toast{
      position:fixed; bottom:18px; left:18px; right:18px;
      max-width: 820px;
      margin:0 auto;
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:none;
      z-index:999;
      font-size:13px;
    }
    .toast.show{display:block}
    .toast b{color:var(--text)}
    .toast .small{display:block; margin-top:4px; color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <div class="waves"></div>

  <header>
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>LocateMe</h1>
            <div class="sub">Internal pallet + photo tracker (Aisle ‚Üí Rail ‚Üí Level ‚Üí Photo)</div>
          </div>
        </div>
        <div class="pill" id="connPill">
          <span class="dot" id="connDot"></span>
          <span id="connText">Connecting‚Ä¶</span>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: Tag + location flow -->
      <div class="card">
        <div class="hd">
          <div>
            <div class="title">Add / Move a Tag</div>
            <div class="muted" style="font-size:12px">Scan or type a tag ‚Üí pick aisle ‚Üí rail ‚Üí level ‚Üí add photo ‚Üí save</div>
          </div>
          <div class="right">
            <button class="btn small" id="btnBack" disabled>‚¨Ö Back</button>
            <button class="btn small" id="btnReset">Reset</button>
          </div>
        </div>
        <div class="bd">

          <div class="cols">
            <div>
              <label class="note">Tag ID</label>
              <div class="row">
                <input id="tagInput" placeholder="Type or scan tag (ex: R-11966.14.23)" />
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn gold" id="btnCam">üì± Camera Scan</button>
                <button class="btn" id="btnFind">üîç Find Tag</button>
              </div>

              <div class="videoWrap" id="videoWrap">
                <video id="video" muted playsinline></video>
                <div class="row" style="padding:10px">
                  <button class="btn small" id="btnStopCam">Stop Camera</button>
                  <span class="note">Point at barcode/QR ‚Äî it will auto-fill the Tag</span>
                </div>
              </div>
            </div>

            <div>
              <label class="note">Status</label>
              <div class="row">
                <span class="badge" id="statusBadge">‚Äî</span>
                <span class="badge recent" id="recentBadge" style="display:none">Recently moved</span>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn ok" id="btnMarkInbound" disabled>‚úÖ Mark INBOUND</button>
                <button class="btn bad" id="btnMarkOutbound" disabled>üöö Mark OUTBOUND</button>
              </div>
              <div class="note" style="margin-top:10px">
                OUTBOUND tags auto-purge after 5 days (daily auto-check).
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="crumb" id="crumb">
            Step: <b id="stepLabel">Pick an Aisle</b>
            <span>‚Ä¢</span>
            Selected: <span><b id="crumbAisle">‚Äî</b></span>
            <span>‚Üí</span>
            <span><b id="crumbRail">‚Äî</b></span>
            <span>‚Üí</span>
            <span><b id="crumbLevel">‚Äî</b></span>
          </div>

          <div style="margin-top:12px">
            <div id="stepAisle">
              <div class="note" style="margin-bottom:8px">Click an aisle:</div>
              <div class="map" id="aisleMap"></div>
              <div class="note" style="margin-top:10px">
                Aisles come from the <code>aisles</code> table. Add more anytime.
              </div>
            </div>

            <div id="stepRail" style="display:none">
              <div class="note" style="margin-bottom:8px">Pick a rail (1‚Äì21):</div>
              <div class="map" id="railMap"></div>
            </div>

            <div id="stepLevel" style="display:none">
              <div class="note" style="margin-bottom:8px">Pick a level (1‚Äì5):</div>
              <div class="map" id="levelMap"></div>
            </div>

            <div id="stepPhoto" style="display:none">
              <div class="cols">
                <div>
                  <label class="note">Add Photo (required)</label>
                  <input type="file" id="photoInput" accept="image/*" capture="environment" />
                  <div class="note" style="margin-top:8px">
                    Photo uploads to Storage bucket <b>warehouse-photos</b> and links to this tag.
                  </div>
                </div>
                <div>
                  <label class="note">Notes (optional)</label>
                  <textarea id="notesInput" placeholder="Anything helpful (ex: left side near door, top wrap ripped, etc)"></textarea>
                </div>
              </div>
              <div class="row" style="margin-top:12px">
                <button class="btn gold" id="btnSave" disabled>üíæ Save Tag Location</button>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div id="foundBox" style="display:none">
            <div class="row" style="justify-content:space-between; gap:10px">
              <div>
                <div class="title">Tag Details</div>
                <div class="muted" id="foundMeta" style="font-size:12px"></div>
              </div>
              <div class="row">
                <button class="btn small" id="btnTagPdf">üßæ Tag PDF</button>
              </div>
            </div>
            <div class="thumbs" id="foundThumbs"></div>
          </div>

        </div>
      </div>

      <!-- RIGHT: Search + reports -->
      <div class="card">
        <div class="hd">
          <div>
            <div class="title">Search + Reports</div>
            <div class="muted" style="font-size:12px">Search by tag or list what‚Äôs INBOUND</div>
          </div>
          <div class="right">
            <button class="btn small" id="btnPdf">üßæ PDF Report</button>
            <button class="btn small" id="btnRefresh">‚Üª Refresh</button>
          </div>
        </div>
        <div class="bd">

          <div class="cols">
            <div>
              <label class="note">Filter</label>
              <select id="statusFilter">
                <option value="INBOUND">INBOUND</option>
                <option value="OUTBOUND">OUTBOUND</option>
                <option value="ALL">ALL</option>
              </select>
            </div>
            <div>
              <label class="note">Search Tag</label>
              <input id="searchInput" placeholder="Search tag (partial works)" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnSearch">Search</button>
            <span class="note" id="listNote">‚Äî</span>
          </div>

          <div style="margin-top:12px; overflow:auto; max-height: 520px;">
            <table>
              <thead>
                <tr>
                  <th style="width:26%">Tag</th>
                  <th style="width:24%">Location</th>
                  <th style="width:20%">Status</th>
                  <th style="width:20%">Updated</th>
                  <th style="width:10%">Action</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>

          <div class="note" style="margin-top:10px">
            Recently moved = updated within last 24 hours.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/** ==========================================================
 *  CONFIG (your Supabase)
 * ========================================================== */
const SB_URL = "https://ojdfaguhteddwaxyobnl.supabase.co";
const SB_KEY = "sb_publishable_S4Z3E2phukZklKtBuRPLjA_RB4Faij2";
const BUCKET = "warehouse-photos";
const AUTO_PURGE_DAYS = 5;           // delete OUTBOUND older than this many days
const AUTO_PURGE_INTERVAL_HRS = 24;  // run purge once per day per device

const sb = supabase.createClient(SB_URL, SB_KEY);

/** ==========================================================
 *  UI refs
 * ========================================================== */
const ui = {
  connDot: document.getElementById("connDot"),
  connText: document.getElementById("connText"),
  toast: document.getElementById("toast"),

  tagInput: document.getElementById("tagInput"),
  btnCam: document.getElementById("btnCam"),
  videoWrap: document.getElementById("videoWrap"),
  video: document.getElementById("video"),
  btnStopCam: document.getElementById("btnStopCam"),
  btnFind: document.getElementById("btnFind"),

  btnBack: document.getElementById("btnBack"),
  btnReset: document.getElementById("btnReset"),

  statusBadge: document.getElementById("statusBadge"),
  recentBadge: document.getElementById("recentBadge"),
  btnMarkInbound: document.getElementById("btnMarkInbound"),
  btnMarkOutbound: document.getElementById("btnMarkOutbound"),

  stepLabel: document.getElementById("stepLabel"),
  crumbAisle: document.getElementById("crumbAisle"),
  crumbRail: document.getElementById("crumbRail"),
  crumbLevel: document.getElementById("crumbLevel"),

  stepAisle: document.getElementById("stepAisle"),
  stepRail: document.getElementById("stepRail"),
  stepLevel: document.getElementById("stepLevel"),
  stepPhoto: document.getElementById("stepPhoto"),

  aisleMap: document.getElementById("aisleMap"),
  railMap: document.getElementById("railMap"),
  levelMap: document.getElementById("levelMap"),

  photoInput: document.getElementById("photoInput"),
  notesInput: document.getElementById("notesInput"),
  btnSave: document.getElementById("btnSave"),

  foundBox: document.getElementById("foundBox"),
  foundMeta: document.getElementById("foundMeta"),
  foundThumbs: document.getElementById("foundThumbs"),
  btnTagPdf: document.getElementById("btnTagPdf"),

  statusFilter: document.getElementById("statusFilter"),
  searchInput: document.getElementById("searchInput"),
  btnSearch: document.getElementById("btnSearch"),
  btnRefresh: document.getElementById("btnRefresh"),
  btnPdf: document.getElementById("btnPdf"),
  listNote: document.getElementById("listNote"),
  rows: document.getElementById("rows"),
};

/** ==========================================================
 *  State
 * ========================================================== */
const state = {
  step: "AISLE", // AISLE | RAIL | LEVEL | PHOTO
  history: [],
  selected: { aisle:null, rail:null, level:null },
  currentTagRow: null,     // pallet_tags row when found/created
  currentPhotos: [],
  cam: { reader:null, stopFn:null, running:false },
  list: [],
};

function toast(msg, small=""){
  ui.toast.innerHTML = `<b>${msg}</b>${small ? `<span class="small">${small}</span>` : ""}`;
  ui.toast.classList.add("show");
  setTimeout(()=>ui.toast.classList.remove("show"), 3800);
}

function setConnected(ok, msg){
  ui.connDot.classList.toggle("ok", !!ok);
  ui.connText.textContent = msg;
}

function norm(s){ return (s||"").trim(); }

function isRecent(ts){
  if(!ts) return false;
  const t = new Date(ts).getTime();
  return (Date.now() - t) <= 24*60*60*1000;
}

/** ==========================================================
 *  Auto purge (runs once/day from any device that opens page)
 * ========================================================== */
async function maybeAutoPurge(){
  const key = "locateme_last_purge_at";
  const last = parseInt(localStorage.getItem(key) || "0", 10);
  const due = !last || (Date.now() - last) > AUTO_PURGE_INTERVAL_HRS*60*60*1000;
  if(!due) return;

  // Call the RPC
  try{
    const { data, error } = await sb.rpc("purge_outbound_older_than", { days: AUTO_PURGE_DAYS });
    if(error) throw error;
    localStorage.setItem(key, String(Date.now()));
    toast("Auto-purge ran", `Deleted ${data?.pallet_tags_deleted ?? 0} OUTBOUND tags older than ${AUTO_PURGE_DAYS} days.`);
  }catch(e){
    // Don‚Äôt block app if purge fails
    console.warn("Auto-purge failed:", e);
  }
}

/** ==========================================================
 *  Load aisles + build clickable map
 * ========================================================== */
async function loadAisles(){
  const { data, error } = await sb.from("aisles").select("name").order("name", { ascending:true });
  if(error) throw error;
  ui.aisleMap.innerHTML = "";
  (data||[]).forEach(a=>{
    const div = document.createElement("div");
    div.className = "tile";
    div.textContent = a.name;
    div.onclick = ()=>pickAisle(a.name, div);
    ui.aisleMap.appendChild(div);
  });
}

/** ==========================================================
 *  Build Rail + Level maps
 * ========================================================== */
function buildRailMap(){
  ui.railMap.innerHTML = "";
  for(let i=1;i<=21;i++){
    const div = document.createElement("div");
    div.className = "tile";
    div.textContent = "Rail " + i;
    div.onclick = ()=>pickRail(i, div);
    ui.railMap.appendChild(div);
  }
}
function buildLevelMap(){
  ui.levelMap.innerHTML = "";
  for(let i=1;i<=5;i++){
    const div = document.createElement("div");
    div.className = "tile";
    div.textContent = "Level " + i;
    div.onclick = ()=>pickLevel(i, div);
    ui.levelMap.appendChild(div);
  }
}

/** ==========================================================
 *  Step navigation
 * ========================================================== */
function pushHistory(){
  state.history.push({
    step: state.step,
    selected: { ...state.selected }
  });
  ui.btnBack.disabled = state.history.length === 0;
}
function goStep(step){
  state.step = step;
  ui.stepAisle.style.display = (step==="AISLE") ? "" : "none";
  ui.stepRail.style.display  = (step==="RAIL")  ? "" : "none";
  ui.stepLevel.style.display = (step==="LEVEL") ? "" : "none";
  ui.stepPhoto.style.display = (step==="PHOTO") ? "" : "none";
  ui.stepLabel.textContent = ({
    AISLE:"Pick an Aisle",
    RAIL:"Pick a Rail",
    LEVEL:"Pick a Level",
    PHOTO:"Add Photo + Save"
  })[step] || "‚Äî";

  ui.crumbAisle.textContent = state.selected.aisle || "‚Äî";
  ui.crumbRail.textContent  = state.selected.rail ? ("Rail " + state.selected.rail) : "‚Äî";
  ui.crumbLevel.textContent = state.selected.level ? ("Level " + state.selected.level) : "‚Äî";

  ui.btnSave.disabled = !(state.selected.aisle && state.selected.rail && state.selected.level && ui.photoInput.files?.length && norm(ui.tagInput.value));
}

function clearSelections(fromStep="AISLE"){
  if(fromStep==="AISLE"){ state.selected = { aisle:null, rail:null, level:null }; }
  if(fromStep==="RAIL"){ state.selected.rail = null; state.selected.level = null; }
  if(fromStep==="LEVEL"){ state.selected.level = null; }
  // clear tile selection UI
  [...document.querySelectorAll(".tile.sel")].forEach(x=>x.classList.remove("sel"));
  goStep(fromStep);
}

function pickAisle(name, el){
  pushHistory();
  state.selected.aisle = name;
  // highlight selection
  [...ui.aisleMap.querySelectorAll(".tile")].forEach(x=>x.classList.remove("sel"));
  el.classList.add("sel");
  goStep("RAIL");
}
function pickRail(n, el){
  pushHistory();
  state.selected.rail = n;
  [...ui.railMap.querySelectorAll(".tile")].forEach(x=>x.classList.remove("sel"));
  el.classList.add("sel");
  goStep("LEVEL");
}
function pickLevel(n, el){
  pushHistory();
  state.selected.level = n;
  [...ui.levelMap.querySelectorAll(".tile")].forEach(x=>x.classList.remove("sel"));
  el.classList.add("sel");
  goStep("PHOTO");
}

/** ==========================================================
 *  Camera scanning (ZXing)
 * ========================================================== */
async function startCamera(){
  if(state.cam.running) return;

  try{
    ui.videoWrap.style.display = "block";
    state.cam.reader = new ZXingBrowser.BrowserMultiFormatReader();
    state.cam.running = true;

    const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
    const deviceId = devices?.[0]?.deviceId;

    // decode continuously
    state.cam.stopFn = await state.cam.reader.decodeFromVideoDevice(
      deviceId || null,
      ui.video,
      (result, err) => {
        if(result){
          const text = result.getText();
          ui.tagInput.value = text;
          toast("Scanned", text);
          stopCamera();
          // auto-find on scan
          findTag();
        }
      }
    );
  }catch(e){
    console.error(e);
    toast("Camera error", "Allow camera permission and retry.");
    stopCamera();
  }
}
function stopCamera(){
  try{
    if(state.cam.stopFn) state.cam.stopFn();
    if(state.cam.reader) state.cam.reader.reset();
  }catch(_){}
  state.cam.running = false;
  state.cam.stopFn = null;
  ui.videoWrap.style.display = "none";
}

/** ==========================================================
 *  Tag lookup + details
 * ========================================================== */
function setTagUI(row, photos){
  state.currentTagRow = row || null;
  state.currentPhotos = photos || [];

  if(!row){
    ui.statusBadge.textContent = "‚Äî";
    ui.recentBadge.style.display = "none";
    ui.btnMarkInbound.disabled = true;
    ui.btnMarkOutbound.disabled = true;
    ui.foundBox.style.display = "none";
    return;
  }

  ui.statusBadge.textContent = row.status || "‚Äî";
  ui.recentBadge.style.display = isRecent(row.updated_at) ? "" : "none";

  ui.btnMarkInbound.disabled = false;
  ui.btnMarkOutbound.disabled = false;

  ui.foundBox.style.display = "";
  ui.foundMeta.textContent =
    `${row.tag_id} ‚Ä¢ ${row.aisle_name} / Rail ${row.rail} / Level ${row.level} ‚Ä¢ updated ${new Date(row.updated_at).toLocaleString()}`;

  ui.foundThumbs.innerHTML = "";
  (photos||[]).forEach(p=>{
    const url = sb.storage.from(BUCKET).getPublicUrl(p.object_path)?.data?.publicUrl;
    const div = document.createElement("div");
    div.className = "thumb";
    div.innerHTML = `<img src="${url}" alt="photo">`;
    ui.foundThumbs.appendChild(div);
  });
}

async function findTag(){
  const tag = norm(ui.tagInput.value);
  if(!tag){ toast("Missing tag", "Type or scan a tag first."); return; }

  // Get most recent record for that tag (either inbound/outbound)
  const { data: rows, error } = await sb
    .from("pallet_tags")
    .select("*")
    .eq("tag_id", tag)
    .order("updated_at", { ascending:false })
    .limit(1);

  if(error){ toast("Find error", error.message); return; }
  const row = rows?.[0] || null;

  if(!row){
    toast("Not found", "No record yet. Pick location + photo then Save.");
    setTagUI(null, []);
    return;
  }

  // Photos for this row
  const { data: photos, error: pe } = await sb
    .from("tag_photos")
    .select("*")
    .eq("pallet_tag_id", row.id)
    .order("created_at", { ascending:false });

  if(pe){ toast("Photo load error", pe.message); return; }

  // Update selection breadcrumb to match found row (optional convenience)
  state.selected.aisle = row.aisle_name;
  state.selected.rail  = row.rail;
  state.selected.level = row.level;
  goStep("PHOTO");

  setTagUI(row, photos || []);
  toast("Loaded", `${row.aisle_name} / Rail ${row.rail} / Level ${row.level}`);
}

/** ==========================================================
 *  Save (insert or update latest INBOUND row)
 * ========================================================== */
async function saveTag(){
  const tag = norm(ui.tagInput.value);
  if(!tag){ toast("Missing tag", "Type or scan a tag first."); return; }
  if(!(state.selected.aisle && state.selected.rail && state.selected.level)){
    toast("Missing location", "Pick aisle ‚Üí rail ‚Üí level."); return;
  }
  const file = ui.photoInput.files?.[0];
  if(!file){ toast("Missing photo", "Add a photo before saving."); return; }

  ui.btnSave.disabled = true;

  try{
    // 1) Find latest row for this tag (prefer INBOUND)
    const { data: existingRows, error: exErr } = await sb
      .from("pallet_tags")
      .select("*")
      .eq("tag_id", tag)
      .order("updated_at", { ascending:false })
      .limit(5);

    if(exErr) throw exErr;

    const existingInbound = (existingRows||[]).find(r => r.status === "INBOUND") || null;
    let tagRow = null;

    const payload = {
      tag_id: tag,
      aisle_name: state.selected.aisle,
      rail: state.selected.rail,
      level: state.selected.level,
      status: "INBOUND",
      notes: norm(ui.notesInput.value) || null
    };

    if(existingInbound){
      // Update the current inbound record
      const { data: upd, error: uErr } = await sb
        .from("pallet_tags")
        .update(payload)
        .eq("id", existingInbound.id)
        .select("*")
        .single();
      if(uErr) throw uErr;
      tagRow = upd;
    } else {
      // Insert new
      const { data: ins, error: iErr } = await sb
        .from("pallet_tags")
        .insert(payload)
        .select("*")
        .single();
      if(iErr) throw iErr;
      tagRow = ins;
    }

    // 2) Upload photo to storage
    const safeTag = tag.replace(/[^a-zA-Z0-9._-]+/g, "_");
    const path = `${state.selected.aisle}/R${state.selected.rail}/L${state.selected.level}/${safeTag}_${Date.now()}.jpg`;

    const { error: upErr } = await sb
      .storage
      .from(BUCKET)
      .upload(path, file, { upsert: false, contentType: file.type || "image/jpeg" });

    if(upErr) throw upErr;

    // 3) Link photo row
    const { error: linkErr } = await sb
      .from("tag_photos")
      .insert({
        pallet_tag_id: tagRow.id,
        bucket: BUCKET,
        object_path: path,
        file_name: file.name || null,
        content_type: file.type || null
      });

    if(linkErr) throw linkErr;

    ui.photoInput.value = "";
    ui.notesInput.value = "";

    toast("Saved", `${tagRow.aisle_name} / Rail ${tagRow.rail} / Level ${tagRow.level}`);

    // Refresh details + list
    await findTag();
    await loadList();

  }catch(e){
    console.error(e);
    toast("Save failed", e.message || String(e));
  }finally{
    ui.btnSave.disabled = false;
  }
}

/** ==========================================================
 *  Mark OUTBOUND / INBOUND
 * ========================================================== */
async function markStatus(next){
  const tag = norm(ui.tagInput.value);
  if(!tag){ toast("Missing tag", "Type or scan a tag first."); return; }

  // target: currentTagRow if loaded; else latest row
  let row = state.currentTagRow;
  if(!row){
    const { data, error } = await sb
      .from("pallet_tags")
      .select("*")
      .eq("tag_id", tag)
      .order("updated_at", { ascending:false })
      .limit(1);
    if(error){ toast("Status error", error.message); return; }
    row = data?.[0];
  }
  if(!row){ toast("Not found", "Save the tag first."); return; }

  const { error } = await sb
    .from("pallet_tags")
    .update({ status: next })
    .eq("id", row.id);

  if(error){ toast("Update failed", error.message); return; }

  toast("Updated", `${tag} marked ${next}`);
  await findTag();
  await loadList();
}

/** ==========================================================
 *  List + Search + PDF
 * ========================================================== */
async function loadList(){
  const status = ui.statusFilter.value;
  const q = norm(ui.searchInput.value);

  let query = sb.from("pallet_tags").select("*");

  if(status !== "ALL"){
    query = query.eq("status", status);
  }
  if(q){
    // partial match
    query = query.ilike("tag_id", `%${q}%`);
  }

  const { data, error } = await query
    .order("updated_at", { ascending:false })
    .limit(200);

  if(error){ toast("List error", error.message); return; }

  state.list = data || [];
  ui.listNote.textContent = `${state.list.length} result(s)`;
  renderRows();
}

function renderRows(){
  ui.rows.innerHTML = "";
  state.list.forEach(r=>{
    const tr = document.createElement("tr");
    const recent = isRecent(r.updated_at);

    const statusCell = recent
      ? `<span class="badge recent">${r.status} ‚Ä¢ recent</span>`
      : `<span class="badge">${r.status}</span>`;

    tr.innerHTML = `
      <td><b>${escapeHtml(r.tag_id)}</b></td>
      <td>${escapeHtml(r.aisle_name)} / Rail ${r.rail} / Level ${r.level}</td>
      <td>${statusCell}</td>
      <td>${new Date(r.updated_at).toLocaleString()}</td>
      <td>
        <button class="btn small" data-act="open" data-id="${r.id}">Open</button>
      </td>
    `;
    ui.rows.appendChild(tr);
  });

  ui.rows.querySelectorAll("button[data-act='open']").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute("data-id");
      const row = state.list.find(x=>x.id===id);
      ui.tagInput.value = row.tag_id;
      await findTag();
      window.scrollTo({ top: 0, behavior: "smooth" });
    };
  });
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

async function exportListPdf(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"letter" });

  const title = `LocateMe Report (${ui.statusFilter.value})`;
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text(title, 40, 50);

  doc.setFont("helvetica","normal");
  doc.setFontSize(10);
  doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 68);
  doc.text(`Results: ${state.list.length}`, 40, 84);

  let y = 110;
  const lineH = 16;

  doc.setFont("helvetica","bold");
  doc.text("TAG", 40, y);
  doc.text("LOCATION", 200, y);
  doc.text("STATUS", 470, y);
  doc.setFont("helvetica","normal");
  y += 10;

  doc.setDrawColor(180);
  doc.line(40, y, 572, y);
  y += 18;

  for(const r of state.list){
    const loc = `${r.aisle_name} / R${r.rail} / L${r.level}`;
    if(y > 740){
      doc.addPage();
      y = 60;
    }
    doc.text(String(r.tag_id).slice(0,24), 40, y);
    doc.text(loc.slice(0,34), 200, y);
    doc.text(String(r.status), 470, y);
    y += lineH;
  }

  doc.save(`locateme_report_${ui.statusFilter.value}_${Date.now()}.pdf`);
}

async function exportTagPdf(){
  const row = state.currentTagRow;
  if(!row){ toast("No tag loaded", "Find a tag first."); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"letter" });

  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.text(`Tag Report`, 40, 52);

  doc.setFontSize(12);
  doc.text(`Tag: ${row.tag_id}`, 40, 82);
  doc.text(`Location: ${row.aisle_name} / Rail ${row.rail} / Level ${row.level}`, 40, 102);
  doc.text(`Status: ${row.status}`, 40, 122);
  doc.text(`Updated: ${new Date(row.updated_at).toLocaleString()}`, 40, 142);

  // Attempt to embed first photo thumbnail if available
  const first = state.currentPhotos?.[0];
  if(first){
    const url = sb.storage.from(BUCKET).getPublicUrl(first.object_path)?.data?.publicUrl;
    try{
      const img = await fetch(url).then(r=>r.blob()).then(blob=>blobToDataURL(blob));
      doc.text(`Photo:`, 40, 172);
      doc.addImage(img, "JPEG", 40, 184, 260, 180);
    }catch(_){
      doc.text(`Photo URL: ${url}`, 40, 172);
    }
  }

  doc.save(`locateme_tag_${row.tag_id}_${Date.now()}.pdf`);
}

function blobToDataURL(blob){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.onerror = rej;
    r.readAsDataURL(blob);
  });
}

/** ==========================================================
 *  Wiring
 * ========================================================== */
ui.btnCam.onclick = startCamera;
ui.btnStopCam.onclick = stopCamera;
ui.btnFind.onclick = findTag;

ui.btnBack.onclick = ()=>{
  const prev = state.history.pop();
  ui.btnBack.disabled = state.history.length === 0;
  if(!prev) return;
  state.step = prev.step;
  state.selected = prev.selected;
  goStep(prev.step);
};

ui.btnReset.onclick = ()=>{
  state.history = [];
  ui.btnBack.disabled = true;
  ui.tagInput.value = "";
  ui.photoInput.value = "";
  ui.notesInput.value = "";
  setTagUI(null, []);
  clearSelections("AISLE");
  toast("Reset", "Ready for next tag.");
};

ui.photoInput.addEventListener("change", ()=>goStep(state.step)); // refresh save enabled state
ui.tagInput.addEventListener("input", ()=>goStep(state.step));

ui.btnSave.onclick = saveTag;

ui.btnMarkOutbound.onclick = ()=>markStatus("OUTBOUND");
ui.btnMarkInbound.onclick  = ()=>markStatus("INBOUND");

ui.btnSearch.onclick = loadList;
ui.btnRefresh.onclick = loadList;
ui.statusFilter.onchange = loadList;
ui.searchInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") loadList(); });

ui.btnPdf.onclick = exportListPdf;
ui.btnTagPdf.onclick = exportTagPdf;

/** ==========================================================
 *  Boot
 * ========================================================== */
(async function init(){
  try{
    setConnected(true, "Connected to Supabase");
    buildRailMap();
    buildLevelMap();
    await loadAisles();
    clearSelections("AISLE");
    await maybeAutoPurge();
    await loadList();
    toast("Ready", "Scan a tag or type it in, then click an aisle.");
  }catch(e){
    console.error(e);
    setConnected(false, "Connection error");
    toast("Startup error", e.message || String(e));
  }
})();
</script>
</body>
</html>
